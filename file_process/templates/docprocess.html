{% extends "base.html" %}
{% block title %}æ–‡æ¡£å¤„ç†ç³»ç»Ÿ{% endblock %}
{% block content %}

<style>
    .main-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }

    .section-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
    }

    .action-bar {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-info:hover {
        background: #138496;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background: #e0a800;
    }

    /* ç¦ç”¨çŠ¶æ€çš„æŒ‰é’®æ ·å¼ */
    .btn:disabled {
        background: #cccccc !important;
        color: #666666 !important;
        cursor: not-allowed !important;
        opacity: 0.5;
        box-shadow: none;
    }

    .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
    }

    .doc-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .doc-table th,
    .doc-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }

    .doc-table th {
        background-color: #667eea;
        color: white;
        font-weight: bold;
    }

    .doc-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .doc-table tr:hover {
        background-color: #f5f5f5;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }

    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-processing {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .status-completed {
        background-color: #d4edda;
        color: #155724;
    }

    .status-failed {
        background-color: #f8d7da;
        color: #721c24;
    }

    /* çŠ¶æ€å•å…ƒæ ¼çš„åŠ¨æ€æ ·å¼ */
    .status-cell.status-processing {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
        100% {
            opacity: 1;
        }
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #667eea;
    }

    .modal-title {
        font-size: 20px;
        font-weight: bold;
        color: #333;
    }

    .modal-close {
        font-size: 28px;
        cursor: pointer;
        color: #666;
        transition: color 0.3s;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-body {
        line-height: 1.6;
    }

    .detail-section {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9ff;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .detail-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #667eea;
    }

    .detail-item {
        margin-bottom: 8px;
    }

    .detail-label {
        font-weight: bold;
        color: #555;
        display: inline-block;
        width: 120px;
    }

    .detail-value {
        color: #333;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
    }

    /* ç« èŠ‚æ ‘æ ·å¼ */
    .chapter-tree {
        margin-top: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }

    .chapter-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 500px;
        overflow-y: auto;
    }

    .chapter-item {
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .chapter-item:last-child {
        border-bottom: none;
    }

    .chapter-item:hover {
        background-color: #f0f0f0;
    }

    .chapter-item.active {
        background-color: #e8f4f8;
        border-left: 3px solid #667eea;
    }

    .chapter-title {
        padding: 12px 15px;
        display: flex;
        align-items: center;
    }

    .chapter-level-indicator {
        margin-right: 10px;
        color: #999;
        font-size: 12px;
    }

    .chapter-text {
        flex: 1;
        font-size: 14px;
        color: #333;
    }

    .chapter-text.is-bold {
        font-weight: bold;
    }

    .chapter-content {
        padding: 15px 20px;
        background-color: #f9f9f9;
        border-top: 1px solid #eee;
        display: none;
        line-height: 1.8;
        color: #555;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .chapter-content.show {
        display: block;
    }

    /* æ–‡æœ¬å†…è”å›¾ç‰‡ï¼ˆå ä½ç¬¦æ›¿æ¢åæ’å…¥ï¼‰ */
    .inline-image-wrapper {
        margin: 10px 0;
        text-align: left;
    }

    .inline-image {
        max-width: 100%;
        height: auto;
        display: block;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fff;
    }

    /* ç« èŠ‚å›¾ç‰‡æ ·å¼ */
    .chapter-images {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
    }

    .chapter-images h5 {
        margin: 0 0 10px 0;
        color: #667eea;
        font-size: 14px;
        font-weight: bold;
    }

    .image-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .image-item {
        position: relative;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .image-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .image-thumbnail {
        width: 120px;
        height: 90px;
        object-fit: cover;
        cursor: pointer;
        display: block;
        transition: opacity 0.3s ease;
    }
    
    .image-thumbnail[data-loaded="false"] {
        opacity: 0.7;
        background-color: #f8f9fa;
    }
    
    .image-thumbnail[data-loaded="true"] {
        opacity: 1;
    }
    
    .image-thumbnail[data-loaded="error"] {
        opacity: 0.5;
        border: 1px dashed #dc3545;
    }

    .image-caption {
        padding: 5px 8px;
        font-size: 12px;
        color: #666;
        background: #f8f9fa;
        text-align: center;
        border-top: 1px solid #eee;
    }

    /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        align-items: center;
        justify-content: center;
    }

    .image-modal.show {
        display: flex;
    }

    .image-modal-content {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .image-modal img {
        width: 100%;
        height: auto;
        display: block;
    }

    .image-modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: rgba(0,0,0,0.5);
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
    }

    .image-modal-close:hover {
        background: rgba(0,0,0,0.7);
    }

    .chapter-empty {
        padding: 20px;
        text-align: center;
        color: #999;
    }

    .chapter-toggle-icon {
        margin-right: 8px;
        transition: transform 0.2s;
    }

    .chapter-toggle-icon.expanded {
        transform: rotate(90deg);
    }
</style>

<div style="display: flex; flex: 1; width: 100%;">
    <!-- å·¦ä¾§åŠŸèƒ½æ  -->
    <div style="width: 200px; min-width: 200px; border-right: 1px solid #ddd; padding: 20px; background: #f8f9fa;">
        <h3 style="margin-bottom: 20px; color: #333;">åŠŸèƒ½èœå•</h3>
        <ul style="list-style: none; padding: 0;">
            <li style="margin-bottom: 15px;">
                <a href="/documentlist" style="text-decoration: none; color: #333;">
                    æ–‡æ¡£ä¸Šä¼ 
                </a>
            </li>
            <li style="margin-bottom: 15px;">
                <a href="/docprocess" style="text-decoration: none; color: #667eea; font-weight: bold;">
                    æ–‡æ¡£å¤„ç†
                </a>
            </li>
            <li style="margin-bottom: 15px;">
                <a href="/chatdoc" style="text-decoration: none; color: #333;">
                    æ–‡æ¡£å¯¹è¯
                </a>
            </li>
        </ul>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-container" style="flex: 1; overflow-x: hidden;">
        <h2>æ–‡æ¡£å¤„ç†</h2>

        <!-- æ“ä½œæ  -->
        <div class="action-bar">
            <button class="btn btn-primary" onclick="openAddModal()">
                æ·»åŠ æ–‡æ¡£
            </button>
            <button class="btn btn-info" onclick="loadDocProcessList()">
                åˆ·æ–°åˆ—è¡¨
            </button>
            <button class="btn btn-warning" onclick="recoverOrphanedTasks()" title="æ¢å¤ç³»ç»Ÿé‡å¯åä¸¢å¤±çš„å¤„ç†ä»»åŠ¡">
                æ¢å¤ä»»åŠ¡
            </button>
        </div>

        <!-- æ–‡æ¡£åˆ—è¡¨ -->
        <div id="docListContainer">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>

<!-- æ·»åŠ æ–‡æ¡£æ¨¡æ€æ¡† -->
<div id="addModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">æ·»åŠ æ–‡æ¡£åˆ°å¤„ç†åˆ—è¡¨</h3>
            <span class="modal-close" onclick="closeAddModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 15px; color: #666;">è¯·ä»æ–‡æ¡£ä¸Šä¼ åˆ—è¡¨ä¸­é€‰æ‹©è¦å¤„ç†çš„æ–‡æ¡£:</p>
            <div id="uploadDocList" style="max-height: 400px; overflow-y: auto;">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
</div>

<!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="detailModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 class="modal-title">æ–‡æ¡£å¤„ç†è¯¦æƒ…</h3>
            <span class="modal-close" onclick="closeDetailModal()">&times;</span>
        </div>
        <div class="modal-body" id="detailContent">
            <!-- è¯¦æƒ…å†…å®¹ -->
        </div>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="imageModal" class="image-modal">
    <div class="image-modal-content">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" src="" alt="å›¾ç‰‡é¢„è§ˆ">
    </div>
</div>

<script>
const API_BASE = '/api/doc-process';

// ç»Ÿä¸€çš„å ä½å›¾ï¼ˆç”¨äºæ‡’åŠ è½½ï¼‰
const PLACEHOLDER_IMG = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTIwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik00MCA0MEw2MCA2MEw4MCA0MEw4MCA3MEg0MFY0MFoiIGZpbGw9IiNEREREREQiLz4KPHRleHQgeD0iNjAiIHk9IjUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjEyIj7ngrnlh7vliKDovb08L3RleHQ+PC9zdmc+';

// æ³¨æ„ï¼šæ¨¡æ¿ç”± Jinja2 æ¸²æŸ“ï¼Œæºç é‡Œä¸èƒ½å‡ºç°è¿ç»­ä¸¤ä¸ªå·¦å¤§æ‹¬å·ï¼Œå¦åˆ™ä¼šè¢«å½“æˆæ¨¡æ¿è¯­æ³•ã€‚
const IMAGE_ID_PREFIX = '{' + '{IMAGE_ID_';
const IMAGE_ID_RE = /\{\{IMAGE_ID_(\d+)\}\}/g;

// å°†ç« èŠ‚ content ä¸­çš„ IMAGE_ID å ä½ç¬¦æ›¿æ¢ä¸ºå†…è” <img>ï¼ˆå…ˆ escapeï¼Œå†æ›¿æ¢ï¼Œé¿å… XSSï¼‰
// åŒæ—¶å¤„ç† [è¡¨æ ¼]...[/è¡¨æ ¼] æ ‡ç­¾ï¼Œæ¸²æŸ“æˆ HTML è¡¨æ ¼
function renderContentWithImages(content, images) {
    const imgMap = {};
    (images || []).forEach(img => {
        if (img && img.id) {
            imgMap[String(img.id)] = img.image_url || img.image_path;
        }
    });

    const escaped = escapeHtml(content || '');
    
    // å…ˆæ›¿æ¢å›¾ç‰‡å ä½ç¬¦
    let result = escaped.replace(IMAGE_ID_RE, (m, id) => {
        const url = imgMap[String(id)];
        if (!url) return m;
        const safeUrl = escapeHtml(url);
        return `<div class="inline-image-wrapper"><img class="inline-image" data-src="${safeUrl}" data-loaded="false" src="${PLACEHOLDER_IMG}" alt="å›¾ç‰‡ ${id}" onclick="showImageModal(this.getAttribute('data-src'))"></div>`;
    });
    
    // å¤„ç† [è¡¨æ ¼]...[/è¡¨æ ¼] æ ‡ç­¾ï¼šæ¸²æŸ“æˆå¸¦è¾¹æ¡†çš„è¡¨æ ¼
    result = result.replace(/\[è¡¨æ ¼\]([\s\S]*?)\[\/è¡¨æ ¼\]/g, (m, tableContent) => {
        const cleaned = tableContent.trim();
        if (!cleaned) return '';
        return `<table class="inline-table" style="border:1px solid #ccc; border-collapse:collapse; margin:10px 0; width:100%;"><tr><td style="border:1px solid #ccc; padding:10px;">${cleaned.replace(/\r?\n/g, '<br>')}</td></tr></table>`;
    });
    
    // å¤„ç†å‰©ä½™çš„æ¢è¡Œç¬¦
    result = result.replace(/\r?\n/g, '<br>');
    
    return result;
}

// åŠ è½½æ–‡æ¡£å¤„ç†åˆ—è¡¨
async function loadDocProcessList() {
    try {
        const response = await fetch(`${API_BASE}/list`, {
            credentials: 'same-origin'
        });
        
        // æ£€æŸ¥æ˜¯å¦è¢«é‡å®šå‘åˆ°ç™»å½•é¡µé¢
        if (response.redirected || response.url.endsWith('/')) {
            window.location.href = '/';
            return;
        }
        
        const result = await response.json();

        if (result.success) {
            renderDocList(result.data);
        } else {
            console.error('åŠ è½½å¤±è´¥:', result.error);
            document.getElementById('docListContainer').innerHTML =
                `<div class="empty-state">åŠ è½½å¤±è´¥: ${result.error}</div>`;
        }
    } catch (error) {
        console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('docListContainer').innerHTML =
            `<div class="empty-state">åŠ è½½å¤±è´¥: ${error.message}</div>`;
    }
}

// æ¸²æŸ“æ–‡æ¡£åˆ—è¡¨
function renderDocList(documents) {
    const container = document.getElementById('docListContainer');

    if (!documents || documents.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“­</div>
                <p>æš‚æ— å¤„ç†æ–‡æ¡£</p>
                <p style="font-size: 14px; margin-top: 10px;">ç‚¹å‡»"æ·»åŠ æ–‡æ¡£"æŒ‰é’®å¼€å§‹</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="doc-table">
            <thead>
                <tr>
                    <th style="width: 5%;">åºå·</th>
                    <th style="width: 25%;">æ–‡ä»¶å</th>
                    <th style="width: 10%;">çŠ¶æ€</th>
                    <th style="width: 15%;">æ·»åŠ æ—¶é—´</th>
                    <th style="width: 15%;">å¤„ç†æ—¶é—´</th>
                    <th style="width: 35%;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
    `;

    documents.forEach((doc, index) => {
        html += `
            <tr data-doc-id="${doc.doc_id}">
                <td>${index + 1}</td>
                <td>${escapeHtml(doc.filename)}</td>
                <td><span class="status-cell status-badge status-${doc.status}">${getStatusText(doc.status)}</span></td>
                <td>${formatDate(doc.created_at)}</td>
                <td>${doc.process_end_time ? formatDate(doc.process_end_time) : '-'}</td>
                <td>
                    ${doc.status === 'failed' ? `
                        <button class="btn btn-primary btn-sm" onclick="processDoc('${doc.doc_id}', '${doc.status}')">
                            é‡è¯•
                        </button>
                    ` : (doc.status === 'completed' ? `
                        <button class="btn btn-success btn-sm" onclick="processDoc('${doc.doc_id}', '${doc.status}')">
                            é‡æ–°å¤„ç†
                        </button>
                    ` : `
                        <button class="btn btn-success btn-sm" onclick="processDoc('${doc.doc_id}', '${doc.status}')" ${doc.status === 'processing' ? 'disabled' : ''}>
                            å¤„ç†
                        </button>
                    `)}
                    <button class="btn btn-info btn-sm" onclick="showDetail('${doc.doc_id}')">
                        è¯¦æƒ…
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadDoc('${doc.doc_id}')">
                        ä¸‹è½½
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteDoc('${doc.doc_id}')">
                        åˆ é™¤
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    container.innerHTML = html;
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        'pending': 'å¾…å¤„ç†',
        'processing': 'å¤„ç†ä¸­',
        'completed': 'å·²å®Œæˆ',
        'failed': 'å¤„ç†å¤±è´¥'
    };
    return statusMap[status] || status;
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleString('zh-CN');
}

// HTMLè½¬ä¹‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ‰“å¼€æ·»åŠ æ–‡æ¡£æ¨¡æ€æ¡†
async function openAddModal() {
    document.getElementById('addModal').classList.add('show');
    loadUploadDocList();
}

// å…³é—­æ·»åŠ æ–‡æ¡£æ¨¡æ€æ¡†
function closeAddModal() {
    document.getElementById('addModal').classList.remove('show');
}

// åŠ è½½å¯æ·»åŠ çš„æ–‡æ¡£åˆ—è¡¨
async function loadUploadDocList() {
    try {
        const response = await fetch('/upload/list', {
            credentials: 'same-origin'
        });
        if (!response.ok) {
            throw new Error('è·å–ä¸Šä¼ åˆ—è¡¨å¤±è´¥');
        }
        const data = await response.json();
        const uploads = data.uploads || [];

        if (uploads.length > 0) {
            renderUploadDocList(uploads);
        } else {
            document.getElementById('uploadDocList').innerHTML =
                `<div class="empty-state">æš‚æ— å¯æ·»åŠ çš„æ–‡æ¡£</div>`;
        }
    } catch (error) {
        console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('uploadDocList').innerHTML =
            `<div class="empty-state">åŠ è½½å¤±è´¥: ${error.message}</div>`;
    }
}

// æ¸²æŸ“å¯æ·»åŠ çš„æ–‡æ¡£åˆ—è¡¨
function renderUploadDocList(documents) {
    const container = document.getElementById('uploadDocList');

    if (!documents || documents.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p>æš‚æ— å¯æ·»åŠ çš„æ–‡æ¡£</p>
            </div>
        `;
        return;
    }

    let html = '<table class="doc-table"><thead><tr><th>æ–‡ä»¶å</th><th>ä¸Šä¼ æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';

    documents.forEach(doc => {
        html += `
            <tr>
                <td>${escapeHtml(doc.filename)}</td>
                <td>${formatDate(doc.created_at)}</td>
                <td>
                    <button class="btn btn-success btn-sm" onclick="addDoc('${doc.upload_id}', '${escapeHtml(doc.filename)}')">
                        æ·»åŠ 
                    </button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// æ·»åŠ æ–‡æ¡£åˆ°å¤„ç†åˆ—è¡¨
async function addDoc(uploadId, filename) {
    try {
        const response = await fetch(`${API_BASE}/add`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({upload_id: uploadId}),
            credentials: 'same-origin'
        });

        const result = await response.json();

        if (result.success) {
            alert(`"${filename}" æ·»åŠ æˆåŠŸ!`);
            closeAddModal();
            loadDocProcessList();
        } else {
            alert(`æ·»åŠ å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        console.error('æ·»åŠ æ–‡æ¡£å¤±è´¥:', error);
        alert(`æ·»åŠ å¤±è´¥: ${error.message}`);
    }
}

// å¤„ç†æ–‡æ¡£
async function processDoc(docId, status) {
    const isReprocess = status === 'completed';
    const confirmMsg = isReprocess ? 'è¯¥æ–‡æ¡£å·²å¤„ç†å®Œæˆï¼Œç¡®å®šè¦é‡æ–°å¤„ç†å—?\n\né‡æ–°å¤„ç†ä¼šç”¨æœ€æ–°è§„åˆ™é‡å»ºç« èŠ‚/å›¾ç‰‡æ•°æ®ã€‚' : 'ç¡®å®šè¦å¤„ç†è¯¥æ–‡æ¡£å—?';
    if (!confirm(confirmMsg)) {
        return;
    }

    // ç«‹å³ç¦ç”¨æŒ‰é’®
    const row = document.querySelector(`[data-doc-id="${docId}"]`);
    if (row) {
        const firstButton = row.querySelector('button:first-child');
        if (firstButton) {
            firstButton.disabled = true;
        }
    }

    try {
        const response = await fetch(`${API_BASE}/process`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({doc_id: docId, reprocess: status === 'completed'}),
            credentials: 'same-origin'
        });

        // æ£€æŸ¥å“åº”æ˜¯å¦ä¸º JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('æœåŠ¡å™¨è¿”å›éJSONå“åº”ï¼Œå¯èƒ½æ˜¯è®¤è¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°ç™»å½•');
        }

        const result = await response.json();

        // å¤„ç†è®¤è¯å¤±è´¥
        if (result.code === 'UNAUTHORIZED') {
            alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            window.location.href = '/';
            return;
        }

        if (result.success) {
            alert('å¤„ç†ä»»åŠ¡å·²æäº¤!');
            loadDocProcessList();
            // è½®è¯¢çŠ¶æ€
            pollDocStatus(docId);
        } else {
            alert(`å¤„ç†å¤±è´¥: ${result.error}`);
            // å¤±è´¥åæ¢å¤æŒ‰é’®
            if (row) {
                const firstButton = row.querySelector('button:first-child');
                if (firstButton) {
                    firstButton.disabled = false;
                }
            }
        }
    } catch (error) {
        console.error('å¤„ç†æ–‡æ¡£å¤±è´¥:', error);
        alert(`å¤„ç†å¤±è´¥: ${error.message}`);
        // å¤±è´¥åæ¢å¤æŒ‰é’®
        if (row) {
            const firstButton = row.querySelector('button:first-child');
            if (firstButton) {
                firstButton.disabled = false;
            }
        }
    }
}

// è½®è¯¢æ–‡æ¡£çŠ¶æ€
function pollDocStatus(docId) {
    const interval = setInterval(async () => {
        try {
            // ä½¿ç”¨æ–°çš„çŠ¶æ€æŸ¥è¯¢API
            const response = await fetch(`${API_BASE}/status?doc_id=${docId}`, {
                credentials: 'same-origin'
            });
            const result = await response.json();

            if (result.success) {
                const status = result.data.status;

                // æ›´æ–°è¡¨æ ¼ä¸­çš„çŠ¶æ€æ˜¾ç¤º
                updateDocStatus(docId, status, result.data);

                // å¦‚æœå¤„ç†å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                if (status === 'completed') {
                    clearInterval(interval);
                    alert('æ–‡æ¡£å¤„ç†å®Œæˆ!');
                    loadDocProcessList();
                } else if (status === 'failed') {
                    clearInterval(interval);
                    const errorMsg = result.data.process_result?.error || 'å¤„ç†å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯';
                    alert(`æ–‡æ¡£å¤„ç†å¤±è´¥: ${errorMsg}`);
                    loadDocProcessList();
                }
            }
        } catch (error) {
            console.error('è½®è¯¢çŠ¶æ€å¤±è´¥:', error);
        }
    }, 5000); // æ¯5ç§’è½®è¯¢ä¸€æ¬¡

    // 10åˆ†é’Ÿååœæ­¢è½®è¯¢ï¼ˆé¿å…æ— é™è½®è¯¢ï¼‰
    setTimeout(() => {
        clearInterval(interval);
        console.log('è½®è¯¢è¶…æ—¶ï¼Œåœæ­¢è½®è¯¢');
    }, 600000);
}

// æ›´æ–°æ–‡æ¡£çŠ¶æ€æ˜¾ç¤º
function updateDocStatus(docId, status, data) {
    // æ‰¾åˆ°å¯¹åº”çš„è¡Œ
    const row = document.querySelector(`[data-doc-id="${docId}"]`);
    if (!row) return;

    const statusCell = row.querySelector('.status-cell');
    if (statusCell) {
        let statusClass = '';
        let statusText = getStatusText(status);

        if (status === 'processing') {
            statusClass = 'status-processing';
            statusText += ` (å¤„ç†ä¸­...)`;
        } else if (status === 'completed') {
            statusClass = 'status-completed';
        } else if (status === 'failed') {
            statusClass = 'status-failed';
        }

        statusCell.className = `status-cell ${statusClass}`;
        statusCell.textContent = statusText;
    }

    // æ›´æ–°å¤„ç†æŒ‰é’®çŠ¶æ€
    const firstButton = row.querySelector('button:first-child');
    if (firstButton) {
        // ç¡®ä¿ onclick æºå¸¦æœ€æ–°çŠ¶æ€
        firstButton.setAttribute('onclick', `processDoc('${docId}', '${status}')`);

        if (status === 'failed') {
            // å¤±è´¥çŠ¶æ€æ˜¾ç¤º"é‡è¯•"æŒ‰é’®ï¼Œå¯ä»¥ç‚¹å‡»
            firstButton.textContent = 'é‡è¯•';
            firstButton.className = 'btn btn-primary btn-sm';
            firstButton.disabled = false;
        } else if (status === 'completed') {
            // å·²å®Œæˆå…è®¸é‡æ–°å¤„ç†
            firstButton.textContent = 'é‡æ–°å¤„ç†';
            firstButton.className = 'btn btn-success btn-sm';
            firstButton.disabled = false;
        } else if (status === 'pending') {
            firstButton.textContent = 'å¤„ç†';
            firstButton.className = 'btn btn-success btn-sm';
            firstButton.disabled = false;
        } else {
            // processing ç­‰ï¼šç¦ç”¨
            firstButton.textContent = 'å¤„ç†ä¸­';
            firstButton.className = 'btn btn-success btn-sm';
            firstButton.disabled = true;
        }
    }
}

// æ¢å¤å­¤å„¿ä»»åŠ¡
async function recoverOrphanedTasks() {
    if (!confirm('ç¡®å®šè¦æ¢å¤ç³»ç»Ÿé‡å¯åä¸¢å¤±çš„å¤„ç†ä»»åŠ¡å—ï¼Ÿ\n\nè¿™å°†æ£€æŸ¥æ‰€æœ‰é•¿æ—¶é—´å¤„äº"å¤„ç†ä¸­"çŠ¶æ€çš„ä»»åŠ¡ï¼Œå¹¶é‡æ–°æäº¤åˆ°å¤„ç†é˜Ÿåˆ—ã€‚')) {
        return;
    }

    // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
    const recoverBtn = event.target;
    const originalText = recoverBtn.textContent;
    recoverBtn.disabled = true;
    recoverBtn.textContent = 'æ¢å¤ä¸­...';

    try {
        const response = await fetch(`${API_BASE}/recover-tasks`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin'
        });

        // æ£€æŸ¥å“åº”æ˜¯å¦ä¸º JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('æœåŠ¡å™¨è¿”å›éJSONå“åº”ï¼Œå¯èƒ½æ˜¯è®¤è¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°ç™»å½•');
        }

        const result = await response.json();

        if (result.success) {
            alert('ä»»åŠ¡æ¢å¤æ£€æŸ¥å®Œæˆï¼\n\nå·²è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­¤å„¿ä»»åŠ¡ï¼Œè¯·æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨ã€‚');
            // åˆ·æ–°åˆ—è¡¨ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
            loadDocProcessList();
        } else {
            alert(`ä»»åŠ¡æ¢å¤å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        console.error('æ¢å¤ä»»åŠ¡å¤±è´¥:', error);
        alert(`æ¢å¤ä»»åŠ¡å¤±è´¥: ${error.message}`);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        recoverBtn.disabled = false;
        recoverBtn.textContent = originalText;
    }
}

// åˆ é™¤æ–‡æ¡£
async function deleteDoc(docId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ–‡æ¡£å—?')) {
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/delete`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({doc_id: docId, reprocess: status === 'completed'}),
            credentials: 'same-origin'
        });

        const result = await response.json();

        if (result.success) {
            alert('åˆ é™¤æˆåŠŸ!');
            loadDocProcessList();
        } else {
            alert(`åˆ é™¤å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        console.error('åˆ é™¤æ–‡æ¡£å¤±è´¥:', error);
        alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
    }
}

// ä¸‹è½½æ–‡æ¡£
function downloadDoc(docId) {
    window.open(`${API_BASE}/download?doc_id=${docId}`, '_blank');
}

// æ˜¾ç¤ºè¯¦æƒ…
async function showDetail(docId) {
    try {
        const response = await fetch(`${API_BASE}/detail?doc_id=${docId}`, {
            credentials: 'same-origin'
        });
        const result = await response.json();

        if (result.success) {
            // åŒæ—¶è·å–ç« èŠ‚ä¿¡æ¯
            await renderDetail(result.data);
            await loadChapters(docId);
            document.getElementById('detailModal').classList.add('show');
        } else {
            alert(`è·å–è¯¦æƒ…å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        console.error('è·å–è¯¦æƒ…å¤±è´¥:', error);
        alert(`è·å–è¯¦æƒ…å¤±è´¥: ${error.message}`);
    }
}

// åŠ è½½ç« èŠ‚æ ‘
async function loadChapters(docId) {
    try {
        const response = await fetch(`${API_BASE}/chapters?doc_id=${docId}`, {
            credentials: 'same-origin'
        });
        const result = await response.json();

        if (result.success) {
            renderChapterTree(result.data.chapters, result.data.total_count);
        }
    } catch (error) {
        console.error('è·å–ç« èŠ‚å¤±è´¥:', error);
    }
}

// æ¸²æŸ“ç« èŠ‚æ ‘
function renderChapterTree(chapters, totalCount) {
    const container = document.getElementById('detailContent');
    const existingSection = document.getElementById('chapterSection');

    // å¦‚æœå·²ç»æœ‰ç« èŠ‚åŒºåŸŸ,ç§»é™¤å®ƒ
    if (existingSection) {
        existingSection.remove();
    }

    if (!chapters || chapters.length === 0) {
        // æ²¡æœ‰ç« èŠ‚,ä¸æ˜¾ç¤ºç« èŠ‚åŒºåŸŸ
        return;
    }

    // åˆ›å»ºç« èŠ‚åŒºåŸŸ
    const chapterSection = document.createElement('div');
    chapterSection.id = 'chapterSection';
    chapterSection.className = 'detail-section';
    chapterSection.innerHTML = `
        <h4>æ–‡æ¡£ç›®å½• (${totalCount} ä¸ªç« èŠ‚)</h4>
        <div class="chapter-tree">
            <ul class="chapter-list" id="chapterList"></ul>
        </div>
    `;

    container.appendChild(chapterSection);

    // é€’å½’æ¸²æŸ“ç« èŠ‚
    renderChapterItems(chapters, document.getElementById('chapterList'), 0);
}

// é€’å½’æ¸²æŸ“ç« èŠ‚é¡¹
function renderChapterItems(chapters, container, level) {
    chapters.forEach(chapter => {
        const li = document.createElement('li');
        li.className = 'chapter-item';
        li.dataset.chapterId = chapter.id;

        // è®¡ç®—ç¼©è¿›
        const paddingLeft = 15 + level * 20;

        // åˆ›å»ºæ ‡é¢˜
        const titleDiv = document.createElement('div');
        titleDiv.className = 'chapter-title';
        titleDiv.style.paddingLeft = `${paddingLeft}px`;

        // æœ‰å­ç« èŠ‚çš„æ˜¾ç¤ºç®­å¤´
        if (chapter.children && chapter.children.length > 0) {
            const toggleIcon = document.createElement('span');
            toggleIcon.className = 'chapter-toggle-icon';
            toggleIcon.innerHTML = 'â–¼';
            titleDiv.appendChild(toggleIcon);
        }

        // å±‚çº§æŒ‡ç¤ºå™¨
        const levelIndicator = document.createElement('span');
        levelIndicator.className = 'chapter-level-indicator';
        levelIndicator.textContent = `${'â”‚'.repeat(level)}${level === 0 ? 'â””' : 'â”œ'}`;
        titleDiv.appendChild(levelIndicator);

        // æ ‡é¢˜æ–‡æœ¬
        const titleText = document.createElement('span');
        titleText.className = `chapter-text ${chapter.is_bold ? 'is-bold' : ''}`;
        titleText.textContent = chapter.title;
        titleDiv.appendChild(titleText);

        li.appendChild(titleDiv);

        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const contentDiv = document.createElement('div');
        contentDiv.className = 'chapter-content';
        contentDiv.id = `chapter-content-${chapter.id}`;
        
        // æ·»åŠ æ–‡æœ¬å†…å®¹ï¼ˆæ”¯æŒ IMAGE_ID å ä½ç¬¦ -> inline <img>ï¼‰
        const textContent = document.createElement('div');
        const rawContent = chapter.content || 'ï¼ˆæ— å†…å®¹ï¼‰';
        textContent.innerHTML = renderContentWithImages(rawContent, chapter.images || []);
        contentDiv.appendChild(textContent);

        const hasInlineImages = (chapter.content || '').includes(IMAGE_ID_PREFIX);

        // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰å ä½ç¬¦ï¼Œä½†å­˜åœ¨å›¾ç‰‡ï¼Œåˆ™ä»æ˜¾ç¤ºå›¾ç‰‡åˆ—è¡¨
        if (!hasInlineImages && chapter.images && chapter.images.length > 0) {
            const imagesDiv = document.createElement('div');
            imagesDiv.className = 'chapter-images';

            const imagesTitle = document.createElement('h5');
            imagesTitle.textContent = `ç›¸å…³å›¾ç‰‡ (${chapter.images.length}å¼ )`;
            imagesDiv.appendChild(imagesTitle);

            const imageGallery = document.createElement('div');
            imageGallery.className = 'image-gallery';

            chapter.images.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';

                const img = document.createElement('img');
                img.className = 'image-thumbnail';
                // æ‡’åŠ è½½ï¼šå…ˆä¸è®¾ç½®srcï¼Œä½¿ç”¨data-srcå­˜å‚¨çœŸå®URL
                img.setAttribute('data-src', image.image_url || image.image_path);
                img.setAttribute('data-loaded', 'false');
                img.alt = `ç« èŠ‚å›¾ç‰‡ ${index + 1}`;

                // è®¾ç½®å ä½å›¾
                img.src = PLACEHOLDER_IMG;

                img.onclick = function() {
                    const realSrc = this.getAttribute('data-src');
                    showImageModal(realSrc);
                };

                imageItem.appendChild(img);

                const caption = document.createElement('div');
                caption.className = 'image-caption';
                caption.textContent = `å›¾ç‰‡ ${index + 1}`;
                imageItem.appendChild(caption);

                imageGallery.appendChild(imageItem);
            });

            imagesDiv.appendChild(imageGallery);
            contentDiv.appendChild(imagesDiv);
        }
        
        li.appendChild(contentDiv);

        // ç‚¹å‡»äº‹ä»¶:æ˜¾ç¤º/éšè—å†…å®¹
        titleDiv.addEventListener('click', (e) => {
            e.stopPropagation();

            // å¦‚æœæœ‰å­ç« èŠ‚,åˆ‡æ¢å±•å¼€/æŠ˜å 
            if (chapter.children && chapter.children.length > 0) {
                const childrenContainer = li.querySelector('.chapter-children');
                const toggleIcon = titleDiv.querySelector('.chapter-toggle-icon');

                if (childrenContainer) {
                    childrenContainer.style.display = childrenContainer.style.display === 'none' ? 'block' : 'none';
                    toggleIcon.classList.toggle('expanded');
                }
            }

            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            const allContent = document.querySelectorAll('.chapter-content');
            allContent.forEach(c => c.classList.remove('show'));

            const allItems = document.querySelectorAll('.chapter-item');
            allItems.forEach(item => item.classList.remove('active'));

            contentDiv.classList.add('show');
            li.classList.add('active');
            
            // æ‡’åŠ è½½ï¼šå½“ç« èŠ‚å†…å®¹æ˜¾ç¤ºæ—¶ï¼ŒåŠ è½½è¯¥ç« èŠ‚çš„å›¾ç‰‡
            loadChapterImages(contentDiv);
        });

        container.appendChild(li);

        // æ¸²æŸ“å­ç« èŠ‚
        if (chapter.children && chapter.children.length > 0) {
            const childrenContainer = document.createElement('ul');
            childrenContainer.className = 'chapter-list chapter-children';
            childrenContainer.style.display = 'block'; // é»˜è®¤å±•å¼€
            childrenContainer.style.paddingLeft = '0';
            li.appendChild(childrenContainer);

            renderChapterItems(chapter.children, childrenContainer, level + 1);
        }
    });
}

// æ¸²æŸ“è¯¦æƒ…
function renderDetail(doc) {
    const container = document.getElementById('detailContent');
    const processResult = doc.process_result || {};

    let html = `
        <div class="detail-section">
            <h4>åŸºæœ¬ä¿¡æ¯</h4>
            <div class="detail-item">
                <span class="detail-label">æ–‡ä»¶å:</span>
                <span class="detail-value">${escapeHtml(doc.filename)}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">çŠ¶æ€:</span>
                <span class="detail-value">
                    <span class="status-badge status-${doc.status}">${getStatusText(doc.status)}</span>
                </span>
            </div>
            <div class="detail-item">
                <span class="detail-label">åˆ›å»ºæ—¶é—´:</span>
                <span class="detail-value">${formatDate(doc.created_at)}</span>
            </div>
            ${doc.process_start_time ? `
            <div class="detail-item">
                <span class="detail-label">å¤„ç†å¼€å§‹æ—¶é—´:</span>
                <span class="detail-value">${formatDate(doc.process_start_time)}</span>
            </div>
            ` : ''}
            ${doc.process_end_time ? `
            <div class="detail-item">
                <span class="detail-label">å¤„ç†ç»“æŸæ—¶é—´:</span>
                <span class="detail-value">${formatDate(doc.process_end_time)}</span>
            </div>
            ` : ''}
        </div>
    `;

    if (processResult) {
        html += `
            <div class="detail-section">
                <h4>å¤„ç†ç»“æœ</h4>
                <div class="detail-item">
                    <span class="detail-label">å¤„ç†æ—¶é—´:</span>
                    <span class="detail-value">${processResult.process_time || '-'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">æ¶ˆæ¯:</span>
                    <span class="detail-value">${processResult.message || '-'}</span>
                </div>
                ${processResult.file_size ? `
                <div class="detail-item">
                    <span class="detail-label">æ–‡ä»¶å¤§å°:</span>
                    <span class="detail-value">${formatFileSize(processResult.file_size)}</span>
                </div>
                ` : ''}
                ${processResult.file_type ? `
                <div class="detail-item">
                    <span class="detail-label">æ–‡ä»¶ç±»å‹:</span>
                    <span class="detail-value">${processResult.file_type}</span>
                </div>
                ` : ''}
                ${processResult.details ? `
                <div class="detail-section" style="margin-top: 15px; margin-bottom: 0;">
                    <h4>è¯¦ç»†ä¿¡æ¯</h4>
                    ${processResult.details.word_count !== undefined ? `
                    <div class="detail-item">
                        <span class="detail-label">å­—æ•°:</span>
                        <span class="detail-value">${processResult.details.word_count}</span>
                    </div>
                    ` : ''}
                    ${processResult.details.paragraph_count !== undefined ? `
                    <div class="detail-item">
                        <span class="detail-label">æ®µè½æ•°:</span>
                        <span class="detail-value">${processResult.details.paragraph_count}</span>
                    </div>
                    ` : ''}
                    ${processResult.details.summary ? `
                    <div class="detail-item">
                        <span class="detail-label">æ‘˜è¦:</span>
                        <span class="detail-value">${escapeHtml(processResult.details.summary)}</span>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
                ${processResult.error ? `
                <div class="detail-section" style="background-color: #fff3f0; border-left-color: #dc3545;">
                    <h4 style="color: #dc3545;">é”™è¯¯ä¿¡æ¯</h4>
                    <p style="color: #721c24; margin: 0;">${escapeHtml(processResult.error)}</p>
                </div>
                ` : ''}
            </div>
        `;
    }

    container.innerHTML = html;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

// æ‡’åŠ è½½ç« èŠ‚å›¾ç‰‡
function loadChapterImages(contentDiv) {
    const images = contentDiv.querySelectorAll('img[data-loaded="false"]');
    
    images.forEach(img => {
        const realSrc = img.getAttribute('data-src');
        if (realSrc) {
            console.log(`æ‡’åŠ è½½å›¾ç‰‡: ${realSrc}`);
            
            // åˆ›å»ºæ–°çš„Imageå¯¹è±¡æ¥é¢„åŠ è½½
            const newImg = new Image();
            
            newImg.onload = function() {
                // å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œæ›¿æ¢å ä½å›¾
                img.src = realSrc;
                img.setAttribute('data-loaded', 'true');
                console.log(`å›¾ç‰‡åŠ è½½æˆåŠŸ: ${realSrc}`);
            };
            
            newImg.onerror = function() {
                // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯å ä½å›¾
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTIwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik00MCA0MEw2MCA2MEw4MCA0MEw4MCA3MEg0MFY0MFoiIGZpbGw9IiNEREREREQiLz4KPHRleHQgeD0iNjAiIHk9IjUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjEyIj7liqDovb3lpLHotKU8L3RleHQ+PC9zdmc+';
                img.setAttribute('data-loaded', 'error');
                img.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                console.log(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${realSrc}`);
            };
            
            // å¼€å§‹åŠ è½½å›¾ç‰‡
            newImg.src = realSrc;
        }
    });
}

// å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
function closeDetailModal() {
    document.getElementById('detailModal').classList.remove('show');
}

// æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
function showImageModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    
    modalImage.src = imageSrc;
    modal.classList.add('show');
}

// å…³é—­å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
function closeImageModal() {
    document.getElementById('imageModal').classList.remove('show');
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
    }
    if (event.target.classList.contains('image-modal')) {
        event.target.classList.remove('show');
    }
};

// é¡µé¢åŠ è½½æ—¶è·å–æ–‡æ¡£åˆ—è¡¨
loadDocProcessList();
</script>

{% endblock %}
