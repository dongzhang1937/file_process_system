{% extends "base.html" %}

{% block title %}æ™ºèƒ½é—®ç­” - LLM{% endblock %}

{% block extra_css %}
<style>
    .llm-container {
        display: flex;
        height: calc(100vh - 60px);
        background: #f5f7fa;
    }
    
    /* ä¾§è¾¹æ  */
    .sidebar {
        width: 280px;
        background: #fff;
        border-right: 1px solid #e4e7ed;
        display: flex;
        flex-direction: column;
    }
    
    .sidebar-header {
        padding: 16px;
        border-bottom: 1px solid #e4e7ed;
    }
    
    .new-chat-btn {
        width: 100%;
        padding: 12px;
        background: #409eff;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .new-chat-btn:hover {
        background: #66b1ff;
    }
    
    .session-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }
    
    .session-item {
        padding: 12px;
        margin-bottom: 4px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .session-item:hover {
        background: #f5f7fa;
    }
    
    .session-item.active {
        background: #ecf5ff;
        color: #409eff;
    }
    
    .session-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 14px;
    }
    
    .session-delete {
        opacity: 0;
        color: #909399;
        padding: 4px;
    }
    
    .session-item:hover .session-delete {
        opacity: 1;
    }
    
    .session-delete:hover {
        color: #f56c6c;
    }
    
    /* ä¸»èŠå¤©åŒºåŸŸ */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        padding: 16px 24px;
        background: #fff;
        border-bottom: 1px solid #e4e7ed;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .chat-title {
        font-size: 16px;
        font-weight: 500;
    }
    
    .settings-btn {
        padding: 8px 16px;
        background: #fff;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .settings-btn:hover {
        border-color: #409eff;
        color: #409eff;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
    }
    
    .message {
        margin-bottom: 24px;
        display: flex;
        gap: 12px;
    }
    
    .message.user {
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #409eff;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 14px;
        flex-shrink: 0;
    }
    
    .message.user .message-avatar {
        background: #67c23a;
    }
    
    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        line-height: 1.6;
    }
    
    .message.user .message-content {
        background: #409eff;
        color: #fff;
    }
    
    .message-sources {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #eee;
        font-size: 12px;
        color: #909399;
    }
    
    .source-tag {
        display: inline-block;
        padding: 2px 8px;
        background: #f0f9ff;
        color: #409eff;
        border-radius: 4px;
        margin-right: 8px;
        margin-bottom: 4px;
    }
    
    /* è¾“å…¥åŒºåŸŸ */
    .chat-input-area {
        padding: 16px 24px;
        background: #fff;
        border-top: 1px solid #e4e7ed;
    }
    
    .input-options {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    
    .option-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #606266;
    }
    
    .input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }
    
    .input-wrapper textarea {
        flex: 1;
        padding: 12px;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        resize: none;
        font-size: 14px;
        line-height: 1.5;
        min-height: 48px;
        max-height: 200px;
    }
    
    .input-wrapper textarea:focus {
        outline: none;
        border-color: #409eff;
    }
    
    .send-btn {
        padding: 12px 24px;
        background: #409eff;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
    }
    
    .send-btn:hover {
        background: #66b1ff;
    }
    
    .send-btn:disabled {
        background: #a0cfff;
        cursor: not-allowed;
    }
    
    /* è®¾ç½®é¢æ¿ */
    .settings-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: #fff;
        box-shadow: -2px 0 8px rgba(0,0,0,0.15);
        transition: right 0.3s;
        z-index: 1000;
        display: flex;
        flex-direction: column;
    }
    
    .settings-panel.show {
        right: 0;
    }
    
    .settings-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e4e7ed;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .settings-header h3 {
        margin: 0;
        font-size: 16px;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #909399;
    }
    
    .settings-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    .setting-group {
        margin-bottom: 24px;
    }
    
    .setting-group h4 {
        margin: 0 0 12px;
        font-size: 14px;
        color: #303133;
    }
    
    .setting-group select,
    .setting-group input,
    .setting-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .setting-group select:focus,
    .setting-group input:focus,
    .setting-group textarea:focus {
        outline: none;
        border-color: #409eff;
    }
    
    .toggle-switch {
        position: relative;
        width: 44px;
        height: 22px;
        background: #dcdfe6;
        border-radius: 11px;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .toggle-switch.active {
        background: #409eff;
    }
    
    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 18px;
        height: 18px;
        background: #fff;
        border-radius: 50%;
        transition: left 0.3s;
    }
    
    .toggle-switch.active::after {
        left: 24px;
    }
    
    /* é®ç½© */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.3);
        z-index: 999;
        display: none;
    }
    
    .overlay.show {
        display: block;
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #909399;
    }
    
    .empty-state svg {
        width: 120px;
        height: 120px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 8px 0;
    }
    
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #409eff;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
    }
    
    /* LLMé…ç½®ç®¡ç†å¼¹çª— */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
    }
    
    .modal.show {
        display: flex;
    }
    
    .modal-content {
        background: #fff;
        border-radius: 8px;
        width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e4e7ed;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #e4e7ed;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    
    .config-list {
        margin-bottom: 16px;
    }
    
    .config-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border: 1px solid #e4e7ed;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    
    .config-item.default {
        border-color: #409eff;
        background: #ecf5ff;
    }
    
    .config-info {
        flex: 1;
    }
    
    .config-name {
        font-weight: 500;
        margin-bottom: 4px;
    }
    
    .config-detail {
        font-size: 12px;
        color: #909399;
    }
    
    .config-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-small {
        padding: 4px 12px;
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid #dcdfe6;
        background: #fff;
    }
    
    .btn-small:hover {
        border-color: #409eff;
        color: #409eff;
    }
    
    .btn-small.danger:hover {
        border-color: #f56c6c;
        color: #f56c6c;
    }
    
    .btn-primary {
        background: #409eff;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .btn-primary:hover {
        background: #66b1ff;
    }
    
    .btn-default {
        background: #fff;
        border: 1px solid #dcdfe6;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .btn-default:hover {
        border-color: #409eff;
        color: #409eff;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: #606266;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
    }
    
    .form-row {
        display: flex;
        gap: 16px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="llm-container">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewSession()">
                <span>+</span> æ–°å»ºå¯¹è¯
            </button>
        </div>
        <div class="session-list" id="sessionList">
            <!-- ä¼šè¯åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
        </div>
    </div>
    
    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <div class="chat-main">
        <div class="chat-header">
            <span class="chat-title" id="chatTitle">æ™ºèƒ½é—®ç­”</span>
            <button class="settings-btn" onclick="toggleSettings()">è®¾ç½®</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="empty-state" id="emptyState">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                <p>å¼€å§‹ä¸€æ®µæ–°å¯¹è¯</p>
                <p style="font-size: 12px;">ä¸Šä¼ çš„æ–‡æ¡£å†…å®¹å°†ä½œä¸ºå›ç­”çš„ä¼˜å…ˆå‚è€ƒæ¥æº</p>
            </div>
        </div>
        
        <div class="chat-input-area">
            <div class="input-options">
                <div class="option-item">
                    <input type="checkbox" id="enableWebSearch" checked>
                    <label for="enableWebSearch">å¯ç”¨ç½‘ç»œæœç´¢</label>
                </div>
                <div class="option-item">
                    <label>æ–‡æ¡£èŒƒå›´:</label>
                    <select id="documentScope">
                        <option value="all">å…¨éƒ¨æ–‡æ¡£</option>
                        <option value="recent">æœ€è¿‘ä¸Šä¼ </option>
                        <option value="select">æŒ‡å®šæ–‡æ¡£</option>
                    </select>
                </div>
            </div>
            <div class="input-wrapper">
                <textarea id="questionInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="1" 
                    onkeydown="handleKeyDown(event)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendQuestion()">å‘é€</button>
            </div>
        </div>
    </div>
    
    <!-- è®¾ç½®é¢æ¿ -->
    <div class="overlay" id="overlay" onclick="toggleSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h3>è®¾ç½®</h3>
            <button class="close-btn" onclick="toggleSettings()">&times;</button>
        </div>
        <div class="settings-body">
            <div class="setting-group">
                <h4>LLMé…ç½®</h4>
                <select id="llmConfigSelect">
                    <option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>
                </select>
                <button class="btn-small" style="margin-top: 8px;" onclick="openConfigModal()">
                    ç®¡ç†é…ç½®
                </button>
            </div>
            
            <div class="setting-group">
                <h4>ç½‘ç»œæœç´¢</h4>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <span>å¯ç”¨ç½‘ç»œæœç´¢</span>
                    <div class="toggle-switch active" id="webSearchToggle" onclick="toggleWebSearch()"></div>
                </div>
                <div id="customUrlsSection">
                    <label style="font-size: 13px; color: #606266;">æŒ‡å®šæœç´¢ç½‘ç«™ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea id="customUrls" rows="3" placeholder="ä¾‹å¦‚ï¼š&#10;docs.python.org&#10;stackoverflow.com"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- LLMé…ç½®ç®¡ç†å¼¹çª— -->
<div class="modal" id="configModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>LLMé…ç½®ç®¡ç†</h3>
            <button class="close-btn" onclick="closeConfigModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="config-list" id="configList">
                <!-- é…ç½®åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
            </div>
            <button class="btn-primary" onclick="showAddConfigForm()">+ æ·»åŠ æ–°é…ç½®</button>
            
            <!-- æ·»åŠ /ç¼–è¾‘é…ç½®è¡¨å• -->
            <div id="configForm" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e4e7ed;">
                <h4 id="configFormTitle">æ·»åŠ é…ç½®</h4>
                <input type="hidden" id="editConfigId">
                
                <div class="form-group">
                    <label>é…ç½®åç§°</label>
                    <input type="text" id="configName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„GPT-4é…ç½®">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ¨¡å‹ç±»å‹</label>
                        <select id="modelType" onchange="onModelTypeChange()">
                            <option value="openai">OpenAI</option>
                            <option value="qianwen">é€šä¹‰åƒé—®</option>
                            <option value="wenxin">æ–‡å¿ƒä¸€è¨€</option>
                            <option value="zhipu">æ™ºè°±GLM</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ¨¡å‹åç§°</label>
                        <select id="modelName">
                            <option value="gpt-4">gpt-4</option>
                            <option value="gpt-4-turbo">gpt-4-turbo</option>
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>API Base URLï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰</label>
                    <input type="text" id="apiBaseUrl" placeholder="https://api.openai.com/v1">
                </div>
                
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-...">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Max Tokens</label>
                        <input type="number" id="maxTokens" value="2048">
                    </div>
                    <div class="form-group">
                        <label>Temperature</label>
                        <input type="number" id="temperature" value="0.7" step="0.1" min="0" max="2">
                    </div>
                </div>
                
                <div class="form-group">
                    <input type="checkbox" id="isDefault">
                    <label for="isDefault" style="display: inline;">è®¾ä¸ºé»˜è®¤é…ç½®</label>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn-primary" onclick="saveConfig()">ä¿å­˜</button>
                    <button class="btn-default" onclick="hideConfigForm()">å–æ¶ˆ</button>
                    <button class="btn-default" onclick="testConfig()">æµ‹è¯•è¿æ¥</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // å…¨å±€çŠ¶æ€
    let currentSessionId = null;
    let llmConfigs = [];
    let modelOptions = {
        'openai': ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo', 'gpt-4o', 'gpt-4o-mini'],
        'qianwen': ['qwen-turbo', 'qwen-plus', 'qwen-max', 'qwen-long'],
        'wenxin': ['ernie-bot-4', 'ernie-bot-turbo', 'ernie-bot'],
        'zhipu': ['glm-4', 'glm-4-flash', 'glm-3-turbo'],
        'deepseek': ['deepseek-chat', 'deepseek-coder'],
        'custom': []
    };
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadSessions();
        loadLLMConfigs();
        autoResizeTextarea();
    });
    
    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    function autoResizeTextarea() {
        const textarea = document.getElementById('questionInput');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });
    }
    
    // åŠ è½½ä¼šè¯åˆ—è¡¨
    async function loadSessions() {
        try {
            const response = await fetch('/llm/sessions');
            const data = await response.json();
            
            if (data.success) {
                renderSessionList(data.data);
            }
        } catch (error) {
            console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
        }
    }
    
    // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
    function renderSessionList(sessions) {
        const container = document.getElementById('sessionList');
        
        if (!sessions || sessions.length === 0) {
            container.innerHTML = '<div style="padding: 16px; color: #909399; text-align: center;">æš‚æ— ä¼šè¯</div>';
            return;
        }
        
        container.innerHTML = sessions.map(session => `
            <div class="session-item ${session.id === currentSessionId ? 'active' : ''}" 
                 onclick="selectSession(${session.id})">
                <span class="session-title">${escapeHtml(session.title)}</span>
                <span class="session-delete" onclick="deleteSession(${session.id}, event)">&times;</span>
            </div>
        `).join('');
    }
    
    // åˆ›å»ºæ–°ä¼šè¯
    async function createNewSession() {
        try {
            const response = await fetch('/llm/sessions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            });
            const data = await response.json();
            
            if (data.success) {
                currentSessionId = data.data.session_id;
                loadSessions();
                clearMessages();
                document.getElementById('chatTitle').textContent = 'æ–°å¯¹è¯';
            }
        } catch (error) {
            console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
        }
    }
    
    // é€‰æ‹©ä¼šè¯
    async function selectSession(sessionId) {
        currentSessionId = sessionId;
        loadSessions();
        await loadSessionHistory(sessionId);
    }
    
    // åŠ è½½ä¼šè¯å†å²
    async function loadSessionHistory(sessionId) {
        try {
            const response = await fetch(`/llm/sessions/${sessionId}/history`);
            const data = await response.json();
            
            if (data.success) {
                renderMessages(data.data);
            }
        } catch (error) {
            console.error('åŠ è½½å†å²å¤±è´¥:', error);
        }
    }
    
    // æ¸²æŸ“æ¶ˆæ¯
    function renderMessages(messages) {
        const container = document.getElementById('chatMessages');
        const emptyState = document.getElementById('emptyState');
        
        if (!messages || messages.length === 0) {
            emptyState.style.display = 'flex';
            container.innerHTML = '';
            container.appendChild(emptyState);
            return;
        }
        
        emptyState.style.display = 'none';
        container.innerHTML = messages.map(msg => `
            <div class="message user">
                <div class="message-avatar">æˆ‘</div>
                <div class="message-content">${escapeHtml(msg.question)}</div>
            </div>
            <div class="message assistant">
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    ${formatAnswer(msg.answer)}
                    ${renderSources(msg)}
                </div>
            </div>
        `).join('');
        
        container.scrollTop = container.scrollHeight;
    }
    
    // æ ¼å¼åŒ–å›ç­”
    function formatAnswer(text) {
        return escapeHtml(text).replace(/\n/g, '<br>');
    }
    
    // æ¸²æŸ“æ¥æºä¿¡æ¯
    function renderSources(msg) {
        if (!msg.source_type || msg.source_type === 'none') return '';
        
        let html = '<div class="message-sources">';
        html += '<strong>å‚è€ƒæ¥æºï¼š</strong>';
        
        if (msg.source_documents && msg.source_documents.length > 0) {
            msg.source_documents.forEach(doc => {
                html += `<span class="source-tag">ğŸ“„ ${escapeHtml(doc.filename || 'æ–‡æ¡£')}</span>`;
            });
        }
        
        if (msg.web_search_results && msg.web_search_results.length > 0) {
            msg.web_search_results.forEach(result => {
                html += `<span class="source-tag">ğŸŒ ${escapeHtml(result.title)}</span>`;
            });
        }
        
        html += '</div>';
        return html;
    }
    
    // åˆ é™¤ä¼šè¯
    async function deleteSession(sessionId, event) {
        event.stopPropagation();
        
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) return;
        
        try {
            const response = await fetch(`/llm/sessions/${sessionId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            
            if (data.success) {
                if (currentSessionId === sessionId) {
                    currentSessionId = null;
                    clearMessages();
                }
                loadSessions();
            }
        } catch (error) {
            console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
        }
    }
    
    // æ¸…ç©ºæ¶ˆæ¯
    function clearMessages() {
        const container = document.getElementById('chatMessages');
        const emptyState = document.getElementById('emptyState');
        container.innerHTML = '';
        emptyState.style.display = 'flex';
        container.appendChild(emptyState);
    }
    
    // å‘é€é—®é¢˜
    async function sendQuestion() {
        const input = document.getElementById('questionInput');
        const question = input.value.trim();
        
        if (!question) return;
        
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessage('user', question);
        input.value = '';
        input.style.height = 'auto';
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const loadingId = addLoadingMessage();
        
        try {
            const enableWebSearch = document.getElementById('enableWebSearch').checked;
            const customUrls = document.getElementById('customUrls').value.trim().split('\n').filter(u => u);
            const llmConfigId = document.getElementById('llmConfigSelect').value || null;
            
            const response = await fetch('/llm/qa', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: currentSessionId,
                    question: question,
                    enable_web_search: enableWebSearch,
                    custom_search_urls: customUrls.length > 0 ? customUrls : null,
                    llm_config_id: llmConfigId,
                    stream: false
                })
            });
            
            const data = await response.json();
            
            // ç§»é™¤åŠ è½½çŠ¶æ€
            removeLoadingMessage(loadingId);
            
            if (data.success) {
                if (!currentSessionId) {
                    currentSessionId = data.data.session_id;
                    loadSessions();
                }
                
                addMessage('assistant', data.data.answer, data.data.sources, data.data.source_type);
            } else {
                addMessage('assistant', 'æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‡ºç°é”™è¯¯ï¼š' + data.error);
            }
        } catch (error) {
            removeLoadingMessage(loadingId);
            addMessage('assistant', 'æŠ±æ­‰ï¼Œå‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            console.error('å‘é€é—®é¢˜å¤±è´¥:', error);
        } finally {
            sendBtn.disabled = false;
        }
    }
    
    // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
    function addMessage(role, content, sources, sourceType) {
        const container = document.getElementById('chatMessages');
        const emptyState = document.getElementById('emptyState');
        emptyState.style.display = 'none';
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const avatar = role === 'user' ? 'æˆ‘' : 'AI';
        let sourcesHtml = '';
        
        if (sources && sourceType && sourceType !== 'none') {
            sourcesHtml = '<div class="message-sources"><strong>å‚è€ƒæ¥æºï¼š</strong>';
            if (sources.documents) {
                sources.documents.forEach(doc => {
                    sourcesHtml += `<span class="source-tag">ğŸ“„ ${escapeHtml(doc.filename || 'æ–‡æ¡£')}</span>`;
                });
            }
            if (sources.web) {
                sources.web.forEach(result => {
                    sourcesHtml += `<span class="source-tag">ğŸŒ ${escapeHtml(result.title)}</span>`;
                });
            }
            sourcesHtml += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">
                ${formatAnswer(content)}
                ${sourcesHtml}
            </div>
        `;
        
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }
    
    // æ·»åŠ åŠ è½½æ¶ˆæ¯
    function addLoadingMessage() {
        const container = document.getElementById('chatMessages');
        const id = 'loading-' + Date.now();
        
        const messageDiv = document.createElement('div');
        messageDiv.id = id;
        messageDiv.className = 'message assistant';
        messageDiv.innerHTML = `
            <div class="message-avatar">AI</div>
            <div class="message-content">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
        
        return id;
    }
    
    // ç§»é™¤åŠ è½½æ¶ˆæ¯
    function removeLoadingMessage(id) {
        const element = document.getElementById(id);
        if (element) {
            element.remove();
        }
    }
    
    // é”®ç›˜äº‹ä»¶å¤„ç†
    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendQuestion();
        }
    }
    
    // åˆ‡æ¢è®¾ç½®é¢æ¿
    function toggleSettings() {
        const panel = document.getElementById('settingsPanel');
        const overlay = document.getElementById('overlay');
        
        panel.classList.toggle('show');
        overlay.classList.toggle('show');
    }
    
    // åˆ‡æ¢ç½‘ç»œæœç´¢
    function toggleWebSearch() {
        const toggle = document.getElementById('webSearchToggle');
        const checkbox = document.getElementById('enableWebSearch');
        
        toggle.classList.toggle('active');
        checkbox.checked = toggle.classList.contains('active');
    }
    
    // åŠ è½½LLMé…ç½®
    async function loadLLMConfigs() {
        try {
            const response = await fetch('/llm/config');
            const data = await response.json();
            
            if (data.success) {
                llmConfigs = data.data;
                renderConfigSelect();
                renderConfigList();
            }
        } catch (error) {
            console.error('åŠ è½½LLMé…ç½®å¤±è´¥:', error);
        }
    }
    
    // æ¸²æŸ“é…ç½®é€‰æ‹©å™¨
    function renderConfigSelect() {
        const select = document.getElementById('llmConfigSelect');
        select.innerHTML = '<option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>';
        
        llmConfigs.forEach(config => {
            const option = document.createElement('option');
            option.value = config.id;
            option.textContent = config.config_name + (config.is_default ? ' (é»˜è®¤)' : '');
            select.appendChild(option);
        });
    }
    
    // æ¸²æŸ“é…ç½®åˆ—è¡¨
    function renderConfigList() {
        const container = document.getElementById('configList');
        
        if (!llmConfigs || llmConfigs.length === 0) {
            container.innerHTML = '<div style="padding: 16px; color: #909399; text-align: center;">æš‚æ— é…ç½®</div>';
            return;
        }
        
        container.innerHTML = llmConfigs.map(config => `
            <div class="config-item ${config.is_default ? 'default' : ''}">
                <div class="config-info">
                    <div class="config-name">${escapeHtml(config.config_name)} ${config.is_default ? '<span style="color: #409eff;">(é»˜è®¤)</span>' : ''}</div>
                    <div class="config-detail">${config.model_type} / ${config.model_name}</div>
                </div>
                <div class="config-actions">
                    <button class="btn-small" onclick="editConfig(${config.id})">ç¼–è¾‘</button>
                    <button class="btn-small danger" onclick="deleteConfig(${config.id})">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
    }
    
    // æ‰“å¼€é…ç½®å¼¹çª—
    function openConfigModal() {
        document.getElementById('configModal').classList.add('show');
        loadLLMConfigs();
    }
    
    // å…³é—­é…ç½®å¼¹çª—
    function closeConfigModal() {
        document.getElementById('configModal').classList.remove('show');
        hideConfigForm();
    }
    
    // æ˜¾ç¤ºæ·»åŠ é…ç½®è¡¨å•
    function showAddConfigForm() {
        document.getElementById('configForm').style.display = 'block';
        document.getElementById('configFormTitle').textContent = 'æ·»åŠ é…ç½®';
        document.getElementById('editConfigId').value = '';
        
        // é‡ç½®è¡¨å•
        document.getElementById('configName').value = '';
        document.getElementById('modelType').value = 'openai';
        document.getElementById('apiBaseUrl').value = '';
        document.getElementById('apiKey').value = '';
        document.getElementById('maxTokens').value = '2048';
        document.getElementById('temperature').value = '0.7';
        document.getElementById('isDefault').checked = false;
        
        onModelTypeChange();
    }
    
    // éšè—é…ç½®è¡¨å•
    function hideConfigForm() {
        document.getElementById('configForm').style.display = 'none';
    }
    
    // æ¨¡å‹ç±»å‹å˜æ›´
    function onModelTypeChange() {
        const modelType = document.getElementById('modelType').value;
        const modelSelect = document.getElementById('modelName');
        const options = modelOptions[modelType] || [];
        
        modelSelect.innerHTML = '';
        
        if (options.length === 0) {
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'modelName';
            input.placeholder = 'è¾“å…¥æ¨¡å‹åç§°';
            modelSelect.parentNode.replaceChild(input, modelSelect);
        } else {
            options.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
        }
    }
    
    // ç¼–è¾‘é…ç½®
    function editConfig(configId) {
        const config = llmConfigs.find(c => c.id === configId);
        if (!config) return;
        
        document.getElementById('configForm').style.display = 'block';
        document.getElementById('configFormTitle').textContent = 'ç¼–è¾‘é…ç½®';
        document.getElementById('editConfigId').value = configId;
        
        document.getElementById('configName').value = config.config_name;
        document.getElementById('modelType').value = config.model_type;
        onModelTypeChange();
        
        const modelNameEl = document.getElementById('modelName');
        if (modelNameEl.tagName === 'SELECT') {
            modelNameEl.value = config.model_name;
        } else {
            modelNameEl.value = config.model_name;
        }
        
        document.getElementById('apiBaseUrl').value = config.api_base_url || '';
        document.getElementById('apiKey').value = '';  // ä¸æ˜¾ç¤ºå¯†é’¥
        document.getElementById('maxTokens').value = config.max_tokens;
        document.getElementById('temperature').value = config.temperature;
        document.getElementById('isDefault').checked = config.is_default;
    }
    
    // ä¿å­˜é…ç½®
    async function saveConfig() {
        const editId = document.getElementById('editConfigId').value;
        const isEdit = !!editId;
        
        const data = {
            config_name: document.getElementById('configName').value,
            model_type: document.getElementById('modelType').value,
            model_name: document.getElementById('modelName').value,
            api_base_url: document.getElementById('apiBaseUrl').value || null,
            max_tokens: parseInt(document.getElementById('maxTokens').value),
            temperature: parseFloat(document.getElementById('temperature').value),
            is_default: document.getElementById('isDefault').checked
        };
        
        const apiKey = document.getElementById('apiKey').value;
        if (apiKey) {
            data.api_key = apiKey;
        } else if (!isEdit) {
            alert('è¯·è¾“å…¥API Key');
            return;
        }
        
        try {
            const url = isEdit ? `/llm/config/${editId}` : '/llm/config';
            const method = isEdit ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(isEdit ? 'é…ç½®æ›´æ–°æˆåŠŸ' : 'é…ç½®åˆ›å»ºæˆåŠŸ');
                hideConfigForm();
                loadLLMConfigs();
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + result.error);
            }
        } catch (error) {
            console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    
    // åˆ é™¤é…ç½®
    async function deleteConfig(configId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) return;
        
        try {
            const response = await fetch(`/llm/config/${configId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            
            if (data.success) {
                loadLLMConfigs();
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + data.error);
            }
        } catch (error) {
            console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
        }
    }
    
    // æµ‹è¯•é…ç½®
    async function testConfig() {
        const editId = document.getElementById('editConfigId').value;
        
        if (!editId) {
            alert('è¯·å…ˆä¿å­˜é…ç½®åå†æµ‹è¯•');
            return;
        }
        
        try {
            const response = await fetch('/llm/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({config_id: parseInt(editId)})
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('æµ‹è¯•æˆåŠŸï¼\nå›å¤: ' + data.data.response);
            } else {
                alert('æµ‹è¯•å¤±è´¥: ' + data.error);
            }
        } catch (error) {
            console.error('æµ‹è¯•å¤±è´¥:', error);
            alert('æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        }
    }
    
    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
