{% extends "base.html" %}
{% block title %}æ–‡æ¡£å¯¹è¯ - æ–‡ä»¶å¤„ç†ç³»ç»Ÿ{% endblock %}
{% block content %}

<style>
    .main-container {
        display: flex;
        flex: 1;
        width: 100%;
    }

    /* å·¦ä¾§èœå• */
    .sidebar {
        width: 200px;
        min-width: 200px;
        border-right: 1px solid #ddd;
        padding: 20px;
        background: #f8f9fa;
    }

    .sidebar h3 {
        margin-bottom: 20px;
        color: #333;
    }

    .sidebar ul {
        list-style: none;
        padding: 0;
    }

    .sidebar li {
        margin-bottom: 15px;
    }

    .sidebar a {
        text-decoration: none;
        color: #333;
        padding: 8px 12px;
        display: block;
        border-radius: 5px;
        transition: all 0.3s;
    }

    .sidebar a:hover {
        background: #e9ecef;
    }

    .sidebar a.active {
        background: #667eea;
        color: white;
    }

    /* ä¸»å†…å®¹åŒº */
    .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0;
    }

    /* Tab åˆ‡æ¢ */
    .tab-container {
        display: flex;
        border-bottom: 2px solid #667eea;
        background: #f8f9fa;
    }

    .tab-btn {
        padding: 12px 30px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        color: #666;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }

    .tab-btn:hover {
        background: #e9ecef;
    }

    .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: white;
    }

    .tab-content {
        display: none;
        flex: 1;
        overflow: hidden;
    }

    .tab-content.active {
        display: flex;
        flex-direction: column;
    }

    /* æ–‡æ¡£é€‰æ‹©åŒº */
    .doc-selector {
        padding: 15px 20px;
        background: #f0f4ff;
        border-bottom: 1px solid #ddd;
    }

    .doc-selector h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 14px;
    }

    .doc-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        max-height: 100px;
        overflow-y: auto;
    }

    .doc-checkbox {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .doc-checkbox:hover {
        border-color: #667eea;
    }

    .doc-checkbox.selected {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .doc-checkbox input {
        margin: 0;
    }

    /* å¯¹è¯åŒº */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
    }

    .message {
        margin-bottom: 20px;
        max-width: 85%;
    }

    .message.user {
        margin-left: auto;
    }

    .message-content {
        padding: 12px 16px;
        border-radius: 12px;
        line-height: 1.6;
    }

    .message.user .message-content {
        background: #667eea;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.system .message-content {
        background: white;
        border: 1px solid #ddd;
        border-bottom-left-radius: 4px;
    }

    .message-time {
        font-size: 11px;
        color: #999;
        margin-top: 5px;
    }

    .message.user .message-time {
        text-align: right;
    }

    /* æœç´¢ç»“æœ */
    .search-result {
        margin-top: 15px;
    }

    .result-doc {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
    }

    .result-doc-header {
        padding: 10px 15px;
        background: #667eea;
        color: white;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .result-chapter {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    .result-chapter:last-child {
        border-bottom: none;
    }

    .chapter-path {
        font-size: 12px;
        color: #888;
        margin-bottom: 6px;
        padding: 4px 8px;
        background: #f5f5f5;
        border-radius: 4px;
        border-left: 3px solid #667eea;
    }

    .chapter-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chapter-level {
        background: #e0e0e0;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        color: #666;
    }

    .chapter-content {
        color: #555;
        line-height: 1.8;
        white-space: pre-wrap;
    }

    .chapter-images {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .chapter-image {
        width: 120px;
        height: 90px;
        object-fit: cover;
        border-radius: 5px;
        border: 1px solid #ddd;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .chapter-image:hover {
        transform: scale(1.05);
    }

    .chapter-children {
        margin-left: 20px;
        border-left: 2px solid #667eea;
        padding-left: 15px;
        margin-top: 10px;
    }

    /* è¾“å…¥åŒº */
    .input-area {
        padding: 15px 20px;
        background: white;
        border-top: 1px solid #ddd;
    }

    .input-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .input-row:last-child {
        margin-bottom: 0;
    }

    .chat-input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        resize: none;
        min-height: 44px;
        max-height: 120px;
    }

    .chat-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }

    .btn-outline {
        background: white;
        border: 1px solid #667eea;
        color: #667eea;
    }

    .btn-outline:hover {
        background: #667eea;
        color: white;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* æ–‡ä»¶ä¸Šä¼  */
    .file-upload-area {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-input {
        display: none;
    }

    .file-label {
        padding: 8px 15px;
        background: #f0f0f0;
        border: 1px dashed #999;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.15s ease;
        user-select: none;
    }

    .file-label:hover {
        background: #e0e0e0;
        border-color: #667eea;
    }

    .file-label:active {
        background: #d0d0d0;
        transform: scale(0.98);
    }

    .file-name {
        font-size: 13px;
        color: #666;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* å†²çªé€‰æ‹©å¯¹è¯æ¡† */
    .conflict-dialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .conflict-dialog.show {
        display: flex;
    }

    .conflict-content {
        background: white;
        padding: 25px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .conflict-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
    }

    .conflict-options {
        margin: 20px 0;
    }

    .conflict-option {
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .conflict-option:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .conflict-option.selected {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }

    .conflict-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    /* å›¾ç‰‡é¢„è§ˆ */
    .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }

    .image-modal.show {
        display: flex;
    }

    .image-modal img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 8px;
    }

    .image-modal-close {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 30px;
        cursor: pointer;
    }

    /* LLM Tab æ ·å¼ */
    .llm-placeholder {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        text-align: center;
        color: #666;
    }

    .llm-placeholder h2 {
        color: #333;
        margin-bottom: 20px;
    }

    .llm-placeholder p {
        max-width: 600px;
        line-height: 1.8;
        margin-bottom: 15px;
    }

    .llm-features {
        text-align: left;
        background: #f8f9fa;
        padding: 20px 30px;
        border-radius: 10px;
        margin-top: 20px;
    }

    .llm-features h4 {
        color: #667eea;
        margin-bottom: 15px;
    }

    .llm-features ul {
        margin: 0;
        padding-left: 20px;
    }

    .llm-features li {
        margin-bottom: 8px;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-message {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #666;
    }
</style>

<div class="main-container">
    <!-- å·¦ä¾§èœå• -->
    <div class="sidebar">
        <h3>åŠŸèƒ½èœå•</h3>
        <ul>
            <li><a href="/documentlist">æ–‡æ¡£ä¸Šä¼ </a></li>
            <li><a href="/docprocess">æ–‡æ¡£å¤„ç†</a></li>
            <li><a href="/chatdoc" class="active">æ–‡æ¡£å¯¹è¯</a></li>
        </ul>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="content-area">
        <!-- Tab åˆ‡æ¢ -->
        <div class="tab-container">
            <button class="tab-btn active" data-tab="exact">ç²¾å‡†åŒ¹é…</button>
            <button class="tab-btn" data-tab="llm">LLMåŒ¹é…</button>
        </div>

        <!-- ç²¾å‡†åŒ¹é… Tab -->
        <div id="tab-exact" class="tab-content active">
            <!-- æ–‡æ¡£é€‰æ‹© -->
            <div class="doc-selector">
                <h4>é€‰æ‹©æŸ¥è¯¢èŒƒå›´ï¼ˆä¸é€‰åˆ™æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼‰:</h4>
                <div class="doc-list" id="docList">
                    <span style="color: #999;">åŠ è½½ä¸­...</span>
                </div>
            </div>

            <!-- å¯¹è¯åŒº -->
            <div class="chat-area">
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        <div class="message-content">
                            æ¬¢è¿ä½¿ç”¨æ–‡æ¡£å¯¹è¯åŠŸèƒ½ï¼æ‚¨å¯ä»¥ï¼š
                            <br>1. è¾“å…¥å…³é”®è¯è¿›è¡Œç²¾ç¡®åŒ¹é…æˆ–æ¨¡ç³ŠåŒ¹é…
                            <br>2. ä¸Šä¼ TXTæ–‡ä»¶æ‰¹é‡æŸ¥è¯¢ï¼ˆæ¯è¡Œä¸€ä¸ªå…³é”®è¯ï¼‰
                            <br>3. æŸ¥è¯¢ç»“æœå¯å¯¼å‡ºä¸ºWordæ–‡æ¡£
                        </div>
                        <div class="message-time">ç³»ç»Ÿæ¶ˆæ¯</div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒº -->
                <div class="input-area">
                    <div class="input-row">
                        <textarea class="chat-input" id="queryInput" placeholder="è¾“å…¥æŸ¥è¯¢å†…å®¹..." rows="1"></textarea>
                    </div>
                    <div class="input-row">
                        <div class="file-upload-area">
                            <input type="file" id="txtFile" class="file-input" accept=".txt">
                            <label for="txtFile" class="file-label">ğŸ“„ ä¸Šä¼ TXTæ‰¹é‡æŸ¥è¯¢</label>
                            <span class="file-name" id="fileName"></span>
                        </div>
                        <div style="flex: 1;"></div>
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                            <input type="checkbox" id="includeChildren" checked> åŒ…å«å­ç« èŠ‚
                        </label>
                        <button class="btn btn-primary" id="btnExact" onclick="doSearch('exact')">å®Œå…¨åŒ¹é…</button>
                        <button class="btn btn-secondary" id="btnFuzzy" onclick="doSearch('fuzzy')">æ¨¡ç³ŠæŸ¥è¯¢</button>
                        <button class="btn btn-success" id="btnExport" onclick="exportToWord()" disabled>å¯¼å‡ºWord</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LLMåŒ¹é… Tab -->
        <div id="tab-llm" class="tab-content">
            <div class="llm-placeholder">
                <h2>ğŸ¤– LLMæ™ºèƒ½åŒ¹é…</h2>
                <p>LLMåŒ¹é…åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œè¯¥åŠŸèƒ½å°†ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹è¿›è¡Œæ™ºèƒ½è¯­ä¹‰åŒ¹é…ï¼Œèƒ½å¤Ÿç†è§£è‡ªç„¶è¯­è¨€æŸ¥è¯¢å¹¶è¿”å›æœ€ç›¸å…³çš„æ–‡æ¡£å†…å®¹ã€‚</p>
                
                <div class="llm-features">
                    <h4>è®¡åˆ’å®ç°çš„åŠŸèƒ½ï¼š</h4>
                    <ul>
                        <li><strong>è¯­ä¹‰ç†è§£</strong>ï¼šç†è§£ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢æ„å›¾</li>
                        <li><strong>æ™ºèƒ½æ£€ç´¢</strong>ï¼šä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢æœ€ç›¸å…³çš„ç« èŠ‚</li>
                        <li><strong>ä¸Šä¸‹æ–‡å¯¹è¯</strong>ï¼šæ”¯æŒå¤šè½®å¯¹è¯ï¼Œç†è§£ä¸Šä¸‹æ–‡</li>
                        <li><strong>ç­”æ¡ˆç”Ÿæˆ</strong>ï¼šåŸºäºæ£€ç´¢å†…å®¹ç”Ÿæˆå‡†ç¡®çš„å›ç­”</li>
                        <li><strong>æ¥æºå¼•ç”¨</strong>ï¼šæ ‡æ³¨ç­”æ¡ˆæ¥æºçš„å…·ä½“ç« èŠ‚</li>
                    </ul>
                    
                    <h4 style="margin-top: 20px;">æŠ€æœ¯æ–¹æ¡ˆï¼š</h4>
                    <ul>
                        <li>RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ¶æ„</li>
                        <li>å‘é‡æ•°æ®åº“å­˜å‚¨æ–‡æ¡£åµŒå…¥</li>
                        <li>æ”¯æŒå¤šç§LLMï¼ˆGPT-4ã€Claudeã€æ–‡å¿ƒä¸€è¨€ç­‰ï¼‰</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å†²çªé€‰æ‹©å¯¹è¯æ¡† -->
<div class="conflict-dialog" id="conflictDialog">
    <div class="conflict-content">
        <div class="conflict-title">å¤šä¸ªæ–‡æ¡£åŒ¹é…åˆ°ç›¸åŒå†…å®¹</div>
        <p>ä»¥ä¸‹æ–‡æ¡£éƒ½åŒ…å«åŒ¹é…çš„å†…å®¹ï¼Œè¯·é€‰æ‹©è¦ä½¿ç”¨çš„æ–‡æ¡£ï¼š</p>
        <div class="conflict-options" id="conflictOptions"></div>
        <div class="conflict-actions">
            <button class="btn btn-outline" onclick="closeConflictDialog()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmConflictSelection()">ç¡®è®¤é€‰æ‹©</button>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆ -->
<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <img id="modalImage" src="" alt="å›¾ç‰‡é¢„è§ˆ">
</div>

<script>
const API_BASE = '/api/chat';

// ç»Ÿä¸€çš„å ä½å›¾ï¼ˆç”¨äºæ‡’åŠ è½½/å†…è”å±•ç¤ºï¼‰
const PLACEHOLDER_IMG = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTIwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik00MCA0MEw2MCA2MEw4MCA0MEw4MCA3MEg0MFY0MFoiIGZpbGw9IiNEREREREQiLz4KPHRleHQgeD0iNjAiIHk9IjUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjEyIj7ngrnlh7vliKDovb08L3RleHQ+PC9zdmc+';

// æ³¨æ„ï¼šæ¨¡æ¿ç”± Jinja2 æ¸²æŸ“ï¼Œæºç é‡Œä¸èƒ½å‡ºç°è¿ç»­ä¸¤ä¸ªå·¦å¤§æ‹¬å·ï¼Œå¦åˆ™ä¼šè¢«å½“æˆæ¨¡æ¿è¯­æ³•ã€‚
const IMAGE_ID_PREFIX = '{' + '{IMAGE_ID_';
const IMAGE_ID_RE = /\{\{IMAGE_ID_(\d+)\}\}/g;

// å°†ç« èŠ‚ content ä¸­çš„ IMAGE_ID å ä½ç¬¦æ›¿æ¢ä¸ºå†…è” <img>ï¼ˆå…ˆ escapeï¼Œå†æ›¿æ¢ï¼Œé¿å… XSSï¼‰
// åŒæ—¶å¤„ç† [è¡¨æ ¼]...[/è¡¨æ ¼] æ ‡ç­¾ï¼Œæ¸²æŸ“æˆ HTML è¡¨æ ¼
function renderContentWithImages(content, images) {
    const imgMap = {};
    (images || []).forEach(img => {
        if (img && img.id) {
            imgMap[String(img.id)] = img.image_url || img.image_path;
        }
    });

    const escaped = escapeHtml(content || '');
    
    // å…ˆæ›¿æ¢å›¾ç‰‡å ä½ç¬¦
    let result = escaped.replace(IMAGE_ID_RE, (m, id) => {
        const url = imgMap[String(id)];
        if (!url) return m;
        const safeUrl = escapeHtml(url);
        return `<div style="margin:10px 0;"><img class="chapter-image" data-src="${safeUrl}" src="${safeUrl}" alt="å›¾ç‰‡ ${id}" onclick="showImage(this.getAttribute('data-src'))"></div>`;
    });
    
    // å¤„ç† [è¡¨æ ¼]...[/è¡¨æ ¼] æ ‡ç­¾ï¼šæ¸²æŸ“æˆå¸¦è¾¹æ¡†çš„è¡¨æ ¼
    // æ³¨æ„ï¼šescapeHtml å [ å’Œ ] ä¸ä¼šè¢«è½¬ä¹‰ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åŒ¹é…
    result = result.replace(/\[è¡¨æ ¼\]([\s\S]*?)\[\/è¡¨æ ¼\]/g, (m, tableContent) => {
        // å»æ‰é¦–å°¾ç©ºç™½å’Œæ¢è¡Œç¬¦
        const cleaned = tableContent.trim();
        if (!cleaned) return '';
        return `<table class="inline-table" style="border:1px solid #ccc; border-collapse:collapse; margin:10px 0; width:100%;"><tr><td style="border:1px solid #ccc; padding:10px;">${cleaned.replace(/\r?\n/g, '<br>')}</td></tr></table>`;
    });
    
    // å¤„ç†å‰©ä½™çš„æ¢è¡Œç¬¦
    result = result.replace(/\r?\n/g, '<br>');
    
    return result;
}

let selectedDocuments = [];
let lastSearchResults = null;
let pendingConflict = null;

// Tab åˆ‡æ¢
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
});

// åŠ è½½æ–‡æ¡£åˆ—è¡¨
async function loadDocuments() {
    try {
        const response = await fetch(`${API_BASE}/documents`, {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            renderDocList(result.data);
        } else {
            document.getElementById('docList').innerHTML = '<span style="color: #dc3545;">åŠ è½½å¤±è´¥</span>';
        }
    } catch (error) {
        console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('docList').innerHTML = '<span style="color: #dc3545;">åŠ è½½å¤±è´¥</span>';
    }
}

function renderDocList(documents) {
    const container = document.getElementById('docList');
    
    if (!documents || documents.length === 0) {
        container.innerHTML = '<span style="color: #999;">æš‚æ— å·²å¤„ç†çš„æ–‡æ¡£</span>';
        return;
    }
    
    container.innerHTML = documents.map(doc => `
        <label class="doc-checkbox" data-doc-id="${doc.doc_id}">
            <input type="checkbox" value="${doc.doc_id}" onchange="toggleDocument('${doc.doc_id}')">
            ${escapeHtml(doc.filename)}
        </label>
    `).join('');
}

function toggleDocument(docId) {
    const index = selectedDocuments.indexOf(docId);
    const checkbox = document.querySelector(`.doc-checkbox[data-doc-id="${docId}"]`);
    
    if (index === -1) {
        selectedDocuments.push(docId);
        checkbox.classList.add('selected');
    } else {
        selectedDocuments.splice(index, 1);
        checkbox.classList.remove('selected');
    }
}

// æœç´¢åŠŸèƒ½
async function doSearch(matchType) {
    const input = document.getElementById('queryInput');
    const query = input.value.trim();
    const txtFile = document.getElementById('txtFile');
    const includeChildren = document.getElementById('includeChildren').checked;
    
    // æ£€æŸ¥æ˜¯å¦æœ‰TXTæ–‡ä»¶ä¸Šä¼ 
    if (txtFile.files.length > 0) {
        await doBatchSearch(matchType);
        return;
    }
    
    if (!query) {
        alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
        return;
    }
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage('user', query);
    input.value = '';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const loadingId = addLoadingMessage();
    
    try {
        const response = await fetch(`${API_BASE}/search`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                query: query,
                match_type: matchType,
                document_ids: selectedDocuments,
                include_children: includeChildren
            })
        });
        
        const result = await response.json();
        removeMessage(loadingId);
        
        if (result.success) {
            lastSearchResults = [{
                query: query,
                results: result.data.results,
                match_count: result.data.total_matches
            }];
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªæ–‡æ¡£åŒ¹é…
            if (result.data.document_count > 1) {
                showConflictDialog(query, matchType, result.data.results);
            } else {
                displaySearchResult(result.data);
                
                // æ˜¾ç¤ºæŸ¥è¯¢å®Œæˆæç¤º
                if (result.data.total_matches > 0) {
                    addMessage('system', `âœ… æŸ¥è¯¢å®Œæˆï¼æ‰¾åˆ° <strong>${result.data.total_matches}</strong> ä¸ªåŒ¹é…ç»“æœã€‚<br>æ‚¨å¯ä»¥ç‚¹å‡» <strong>"å¯¼å‡ºWord"</strong> æŒ‰é’®å°†ç»“æœå¯¼å‡ºä¸ºæ–‡æ¡£ã€‚`, true);
                }
            }
            
            // å¯ç”¨å¯¼å‡ºæŒ‰é’®
            if (result.data.total_matches > 0) {
                document.getElementById('btnExport').disabled = false;
            }
        } else {
            addMessage('system', `æŸ¥è¯¢å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        removeMessage(loadingId);
        addMessage('system', `æŸ¥è¯¢å‡ºé”™: ${error.message}`);
    }
}

// æ‰¹é‡æœç´¢
async function doBatchSearch(matchType) {
    const txtFile = document.getElementById('txtFile');
    const includeChildren = document.getElementById('includeChildren').checked;
    
    if (txtFile.files.length === 0) {
        alert('è¯·å…ˆä¸Šä¼ TXTæ–‡ä»¶');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', txtFile.files[0]);
    
    // å…ˆä¸Šä¼ æ–‡ä»¶è·å–æŸ¥è¯¢åˆ—è¡¨
    addMessage('user', `æ‰¹é‡æŸ¥è¯¢æ–‡ä»¶: ${txtFile.files[0].name}`);
    const loadingId = addLoadingMessage();
    
    try {
        // ä¸Šä¼ TXTæ–‡ä»¶
        const uploadResponse = await fetch(`${API_BASE}/upload-txt`, {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });
        
        const uploadResult = await uploadResponse.json();
        
        if (!uploadResult.success) {
            removeMessage(loadingId);
            addMessage('system', `æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${uploadResult.error}`);
            return;
        }
        
        const queries = uploadResult.data.queries;
        addMessage('system', `å·²è§£æ ${queries.length} æ¡æŸ¥è¯¢`);
        
        // æ‰§è¡Œæ‰¹é‡æœç´¢
        const searchResponse = await fetch(`${API_BASE}/batch-search`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                queries: queries,
                match_type: matchType,
                document_ids: selectedDocuments,
                include_children: includeChildren
            })
        });
        
        const searchResult = await searchResponse.json();
        removeMessage(loadingId);
        
        if (searchResult.success) {
            lastSearchResults = searchResult.data.batch_results;
            displayBatchResults(searchResult.data);
            
            // å¯ç”¨å¯¼å‡ºæŒ‰é’®
            const hasResults = searchResult.data.batch_results.some(r => r.match_count > 0);
            document.getElementById('btnExport').disabled = !hasResults;
            
            // æ˜¾ç¤ºæŸ¥è¯¢å®Œæˆæç¤º
            if (hasResults) {
                const totalMatches = searchResult.data.batch_results.reduce((sum, r) => sum + r.match_count, 0);
                addMessage('system', `âœ… æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼å…±æ‰¾åˆ° <strong>${totalMatches}</strong> ä¸ªåŒ¹é…ç»“æœã€‚<br>æ‚¨å¯ä»¥ç‚¹å‡» <strong>"å¯¼å‡ºWord"</strong> æŒ‰é’®å°†ç»“æœå¯¼å‡ºä¸ºæ–‡æ¡£ã€‚`, true);
            }
        } else {
            addMessage('system', `æ‰¹é‡æŸ¥è¯¢å¤±è´¥: ${searchResult.error}`);
        }
        
        // æ¸…é™¤æ–‡ä»¶
        txtFile.value = '';
        document.getElementById('fileName').textContent = '';
        
    } catch (error) {
        removeMessage(loadingId);
        addMessage('system', `æ‰¹é‡æŸ¥è¯¢å‡ºé”™: ${error.message}`);
    }
}

// æ˜¾ç¤ºæœç´¢ç»“æœ
function displaySearchResult(data) {
    const matchType = data.match_type === 'exact' ? 'å®Œå…¨åŒ¹é…' : 'æ¨¡ç³ŠåŒ¹é…';
    
    if (data.results.length === 0) {
        addMessage('system', `æœªæ‰¾åˆ°åŒ¹é…çš„å†…å®¹ï¼ˆ${matchType}ï¼‰`);
        return;
    }
    
    let html = `<div class="search-result">`;
    html += `<p>æ‰¾åˆ° <strong>${data.total_matches}</strong> ä¸ªåŒ¹é…é¡¹ï¼ˆ${matchType}ï¼‰ï¼Œæ¥è‡ª <strong>${data.document_count}</strong> ä¸ªæ–‡æ¡£ï¼š</p>`;
    
    for (const docResult of data.results) {
        html += renderDocResult(docResult);
    }
    
    html += `</div>`;
    addMessage('system', html, true);
}

// æ˜¾ç¤ºæ‰¹é‡ç»“æœ
function displayBatchResults(data) {
    let html = `<div class="search-result">`;
    html += `<p>æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼Œå…± ${data.total_queries} æ¡æŸ¥è¯¢ï¼š</p>`;
    
    for (const queryResult of data.batch_results) {
        html += `<h4 style="margin: 15px 0 10px 0; color: #667eea;">æŸ¥è¯¢: "${escapeHtml(queryResult.query)}"</h4>`;
        
        if (queryResult.results.length === 0) {
            html += `<p style="color: #999;">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</p>`;
        } else {
            for (const docResult of queryResult.results) {
                html += renderDocResult(docResult);
            }
        }
    }
    
    html += `</div>`;
    addMessage('system', html, true);
}

// æ¸²æŸ“æ–‡æ¡£ç»“æœ
function renderDocResult(docResult) {
    let html = `<div class="result-doc">`;
    html += `<div class="result-doc-header">
        <span>ğŸ“„ ${escapeHtml(docResult.filename)}</span>
        <span>${docResult.chapters.length} ä¸ªç« èŠ‚</span>
    </div>`;
    
    for (const chapter of docResult.chapters) {
        html += renderChapter(chapter);
    }
    
    html += `</div>`;
    return html;
}

// æ¸²æŸ“ç« èŠ‚
function renderChapter(chapter, isChild = false) {
    let html = `<div class="result-chapter${isChild ? ' chapter-child' : ''}">`;
    
    // æ˜¾ç¤ºå±‚çº§è·¯å¾„ï¼ˆåªåœ¨éå­ç« èŠ‚æ—¶æ˜¾ç¤ºï¼Œæ˜¾ç¤ºå®Œæ•´è·¯å¾„åŒ…æ‹¬å½“å‰ç« èŠ‚ï¼‰
    if (!isChild && chapter.path && chapter.path.length > 0) {
        const pathTitles = chapter.path.map(p => escapeHtml(p.title || '(æ— æ ‡é¢˜)'));
        html += `<div class="chapter-path">${pathTitles.join(' -> ')}</div>`;
    }
    
    html += `<div class="chapter-title">
        <span class="chapter-level">L${chapter.level}</span>
        ${escapeHtml(chapter.title || '(æ— æ ‡é¢˜)')}
    </div>`;
    
    if (chapter.content) {
        html += `<div class="chapter-content">${renderContentWithImages(chapter.content, chapter.images || [])}</div>`;
    }

    const hasInlineImages = chapter.content && chapter.content.includes(IMAGE_ID_PREFIX);

    // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœ content æ²¡æœ‰å ä½ç¬¦ï¼Œä½† images æœ‰å€¼ï¼Œåˆ™æ˜¾ç¤ºå›¾ç‰‡åˆ—è¡¨
    if (!hasInlineImages && chapter.images && chapter.images.length > 0) {
        html += `<div class="chapter-images">`;
        for (const img of chapter.images) {
            const imgUrl = img.image_url || img.image_path;
            const safeUrl = escapeHtml(imgUrl);
            html += `<img class="chapter-image" src="${safeUrl}" data-src="${safeUrl}" onclick="showImage(this.getAttribute('data-src'))" alt="ç« èŠ‚å›¾ç‰‡">`;
        }
        html += `</div>`;
    }
    
    // æ˜¾ç¤ºå­ç« èŠ‚
    if (chapter.children && chapter.children.length > 0) {
        html += `<div class="chapter-children">`;
        for (const child of chapter.children) {
            html += renderChapter(child, true);
        }
        html += `</div>`;
    }
    
    html += `</div>`;
    return html;
}

// å¯¼å‡ºWord
async function exportToWord() {
    if (!lastSearchResults || lastSearchResults.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
        return;
    }
    
    const btn = document.getElementById('btnExport');
    btn.disabled = true;
    btn.textContent = 'å¯¼å‡ºä¸­...';
    
    try {
        const response = await fetch(`${API_BASE}/export-word`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                results: lastSearchResults,
                title: 'æ–‡æ¡£æŸ¥è¯¢ç»“æœ'
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æŸ¥è¯¢ç»“æœ_${new Date().toISOString().slice(0,10)}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            addMessage('system', 'Wordæ–‡æ¡£å·²ä¸‹è½½');
        } else {
            const result = await response.json();
            addMessage('system', `å¯¼å‡ºå¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        addMessage('system', `å¯¼å‡ºå‡ºé”™: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'å¯¼å‡ºWord';
    }
}

// å†²çªå¯¹è¯æ¡†
function showConflictDialog(query, matchType, results) {
    pendingConflict = { query, matchType, results };
    
    const optionsHtml = results.map(doc => `
        <div class="conflict-option" data-doc-id="${doc.document_id}" onclick="selectConflictOption(this)">
            <strong>${escapeHtml(doc.filename)}</strong>
            <br><small>${doc.chapters.length} ä¸ªåŒ¹é…ç« èŠ‚</small>
        </div>
    `).join('');
    
    document.getElementById('conflictOptions').innerHTML = optionsHtml;
    document.getElementById('conflictDialog').classList.add('show');
}

function selectConflictOption(element) {
    document.querySelectorAll('.conflict-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
}

function closeConflictDialog() {
    document.getElementById('conflictDialog').classList.remove('show');
    pendingConflict = null;
    
    // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œæ˜¾ç¤ºæ‰€æœ‰ç»“æœ
    if (lastSearchResults && lastSearchResults.length > 0) {
        displaySearchResult({
            results: lastSearchResults[0].results,
            total_matches: lastSearchResults[0].match_count,
            document_count: lastSearchResults[0].results.length,
            match_type: 'exact'
        });
    }
}

async function confirmConflictSelection() {
    const selected = document.querySelector('.conflict-option.selected');
    if (!selected) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£');
        return;
    }
    
    const docId = selected.dataset.docId;
    document.getElementById('conflictDialog').classList.remove('show');
    
    const loadingId = addLoadingMessage();
    
    try {
        const response = await fetch(`${API_BASE}/select-document`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                document_id: docId,
                query: pendingConflict.query,
                match_type: pendingConflict.matchType,
                include_children: document.getElementById('includeChildren').checked
            })
        });
        
        const result = await response.json();
        removeMessage(loadingId);
        
        if (result.success) {
            // æ‰¾åˆ°é€‰ä¸­æ–‡æ¡£çš„ä¿¡æ¯
            const selectedDoc = pendingConflict.results.find(r => r.document_id === docId);
            
            lastSearchResults = [{
                query: pendingConflict.query,
                results: [{
                    document_id: docId,
                    filename: selectedDoc ? selectedDoc.filename : 'æœªçŸ¥æ–‡æ¡£',
                    chapters: result.data.chapters
                }],
                match_count: result.data.chapters.length
            }];
            
            displaySearchResult({
                results: lastSearchResults[0].results,
                total_matches: result.data.chapters.length,
                document_count: 1,
                match_type: pendingConflict.matchType
            });
        } else {
            addMessage('system', `é€‰æ‹©å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        removeMessage(loadingId);
        addMessage('system', `é€‰æ‹©å‡ºé”™: ${error.message}`);
    }
    
    pendingConflict = null;
}

// æ¶ˆæ¯ç›¸å…³
let messageId = 0;

function addMessage(type, content, isHtml = false) {
    const container = document.getElementById('chatMessages');
    const id = 'msg-' + (++messageId);
    
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.id = id;
    
    const time = new Date().toLocaleTimeString('zh-CN');
    
    div.innerHTML = `
        <div class="message-content">${isHtml ? content : escapeHtml(content)}</div>
        <div class="message-time">${time}</div>
    `;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    return id;
}

function addLoadingMessage() {
    const container = document.getElementById('chatMessages');
    const id = 'msg-' + (++messageId);
    
    const div = document.createElement('div');
    div.className = 'message system';
    div.id = id;
    div.innerHTML = `
        <div class="message-content">
            <div class="loading-message">
                <div class="loading"></div>
                <span>æ­£åœ¨æŸ¥è¯¢...</span>
            </div>
        </div>
    `;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    return id;
}

function removeMessage(id) {
    const msg = document.getElementById(id);
    if (msg) msg.remove();
}

// å›¾ç‰‡é¢„è§ˆ
function showImage(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').classList.add('show');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('show');
}

// å·¥å…·å‡½æ•°
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ–‡ä»¶é€‰æ‹©
document.getElementById('txtFile').addEventListener('change', function() {
    const fileName = this.files.length > 0 ? this.files[0].name : '';
    document.getElementById('fileName').textContent = fileName;
    
    // å¼‚æ­¥æ˜¾ç¤ºæ¶ˆæ¯ï¼Œé¿å…é˜»å¡UI
    if (fileName) {
        requestAnimationFrame(() => {
            addMessage('system', `å·²é€‰æ‹©æ–‡ä»¶: <strong>${escapeHtml(fileName)}</strong><br>è¯·ç‚¹å‡»"å®Œå…¨åŒ¹é…"æˆ–"æ¨¡ç³ŠæŸ¥è¯¢"æŒ‰é’®å¼€å§‹æ‰¹é‡æŸ¥è¯¢`, true);
        });
    }
});

// å›è½¦å‘é€
document.getElementById('queryInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        doSearch('exact');
    }
});

// åˆå§‹åŒ–
loadDocuments();
</script>

{% endblock %}
