{% extends "base.html" %}
{% block title %}æ–‡æ¡£å¯¹è¯ - æ–‡ä»¶å¤„ç†ç³»ç»Ÿ{% endblock %}
{% block content %}

<style>
    .main-container {
        display: flex;
        flex: 1;
        width: 100%;
    }

    /* å·¦ä¾§èœå• */
    .sidebar {
        width: 200px;
        min-width: 200px;
        border-right: 1px solid #ddd;
        padding: 20px;
        background: #f8f9fa;
    }

    .sidebar h3 {
        margin-bottom: 20px;
        color: #333;
    }

    .sidebar ul {
        list-style: none;
        padding: 0;
    }

    .sidebar li {
        margin-bottom: 15px;
    }

    .sidebar a {
        text-decoration: none;
        color: #333;
        padding: 8px 12px;
        display: block;
        border-radius: 5px;
        transition: all 0.3s;
    }

    .sidebar a:hover {
        background: #e9ecef;
    }

    .sidebar a.active {
        background: #667eea;
        color: white;
    }

    /* ä¸»å†…å®¹åŒº */
    .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0;
    }

    /* Tab åˆ‡æ¢ */
    .tab-container {
        display: flex;
        border-bottom: 2px solid #667eea;
        background: #f8f9fa;
    }

    .tab-btn {
        padding: 12px 30px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        color: #666;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }

    .tab-btn:hover {
        background: #e9ecef;
    }

    .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: white;
    }

    .tab-content {
        display: none;
        flex: 1;
        overflow: hidden;
    }

    .tab-content.active {
        display: flex;
        flex-direction: column;
    }

    /* æ–‡æ¡£é€‰æ‹©åŒº */
    .doc-selector {
        padding: 15px 20px;
        background: #f0f4ff;
        border-bottom: 1px solid #ddd;
    }

    .doc-selector h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 14px;
    }

    .doc-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        max-height: 100px;
        overflow-y: auto;
    }

    .doc-checkbox {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .doc-checkbox:hover {
        border-color: #667eea;
    }

    .doc-checkbox.selected {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .doc-checkbox input {
        margin: 0;
    }

    /* å¯¹è¯åŒº */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
    }

    .message {
        margin-bottom: 20px;
        max-width: 85%;
    }

    .message.user {
        margin-left: auto;
    }

    .message-content {
        padding: 12px 16px;
        border-radius: 12px;
        line-height: 1.6;
    }

    .message.user .message-content {
        background: #667eea;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.system .message-content {
        background: white;
        border: 1px solid #ddd;
        border-bottom-left-radius: 4px;
    }

    .message-time {
        font-size: 11px;
        color: #999;
        margin-top: 5px;
    }

    .message.user .message-time {
        text-align: right;
    }

    /* æœç´¢ç»“æœ */
    .search-result {
        margin-top: 15px;
    }

    .result-doc {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
    }

    .result-doc-header {
        padding: 10px 15px;
        background: #667eea;
        color: white;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .result-chapter {
        padding: 15px;
        border-bottom: 1px solid #eee;
        position: relative;
    }

    .result-chapter:last-child {
        border-bottom: none;
    }

    /* ç« èŠ‚é€‰æ‹©å¤é€‰æ¡† */
    .chapter-select-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }

    .chapter-select-checkbox {
        margin-top: 3px;
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #667eea;
    }

    .chapter-select-content {
        flex: 1;
    }

    /* å…¨é€‰æ§åˆ¶æ  */
    .select-all-bar {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 8px 15px;
        background: #e8f0fe;
        border-bottom: 1px solid #667eea;
    }

    .select-all-bar label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-size: 13px;
        font-weight: bold;
        color: #333;
    }

    .select-count {
        font-size: 12px;
        color: #666;
    }

    .chapter-path {
        font-size: 12px;
        color: #888;
        margin-bottom: 6px;
        padding: 4px 8px;
        background: #f5f5f5;
        border-radius: 4px;
        border-left: 3px solid #667eea;
    }

    .chapter-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chapter-level {
        background: #e0e0e0;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        color: #666;
    }

    .chapter-content {
        color: #555;
        line-height: 1.8;
        white-space: pre-wrap;
    }

    .chapter-images {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .chapter-image {
        width: 120px;
        height: 90px;
        object-fit: cover;
        border-radius: 5px;
        border: 1px solid #ddd;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .chapter-image:hover {
        transform: scale(1.05);
    }

    .chapter-children {
        margin-left: 20px;
        border-left: 2px solid #667eea;
        padding-left: 15px;
        margin-top: 10px;
    }

    /* è¾“å…¥åŒº */
    .input-area {
        padding: 15px 20px;
        background: white;
        border-top: 1px solid #ddd;
    }

    .input-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .input-row:last-child {
        margin-bottom: 0;
    }

    .chat-input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        resize: none;
        min-height: 44px;
        max-height: 120px;
    }

    .chat-input:focus {
        outline: none;
        border-color: #667eea;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }

    .btn-outline {
        background: white;
        border: 1px solid #667eea;
        color: #667eea;
    }

    .btn-outline:hover {
        background: #667eea;
        color: white;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* æ–‡ä»¶ä¸Šä¼  */
    .file-upload-area {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-input {
        display: none;
    }

    .file-label {
        padding: 8px 15px;
        background: #f0f0f0;
        border: 1px dashed #999;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.15s ease;
        user-select: none;
    }

    .file-label:hover {
        background: #e0e0e0;
        border-color: #667eea;
    }

    .file-label:active {
        background: #d0d0d0;
        transform: scale(0.98);
    }

    .file-name {
        font-size: 13px;
        color: #666;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* å†²çªé€‰æ‹©å¯¹è¯æ¡† */
    .conflict-dialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .conflict-dialog.show {
        display: flex;
    }

    .conflict-content {
        background: white;
        padding: 25px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .conflict-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
    }

    .conflict-options {
        margin: 20px 0;
    }

    .conflict-option {
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .conflict-option:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .conflict-option.selected {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }

    .conflict-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    /* å›¾ç‰‡é¢„è§ˆ */
    .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }

    .image-modal.show {
        display: flex;
    }

    .image-modal img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 8px;
    }

    .image-modal-close {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 30px;
        cursor: pointer;
    }

    /* LLM Tab æ ·å¼ */
    .llm-options-bar {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 12px 20px;
        background: #f0f4ff;
        border-bottom: 1px solid #ddd;
        flex-wrap: wrap;
    }
    
    .llm-options-bar .option-group {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
    }
    
    .llm-options-bar select {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 13px;
        background: white;
    }
    
    .llm-status {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-left: auto;
        font-size: 12px;
    }
    
    .llm-status .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #999;
    }
    
    .llm-status.ready .status-dot {
        background: #28a745;
    }
    
    .llm-status.error .status-dot {
        background: #dc3545;
    }
    
    .llm-status .status-text {
        color: #666;
    }

    .llm-placeholder {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        text-align: center;
        color: #666;
    }

    .llm-placeholder h2 {
        color: #333;
        margin-bottom: 20px;
    }

    .llm-placeholder p {
        max-width: 600px;
        line-height: 1.8;
        margin-bottom: 15px;
    }

    .llm-features {
        text-align: left;
        background: #f8f9fa;
        padding: 20px 30px;
        border-radius: 10px;
        margin-top: 20px;
    }

    .llm-features h4 {
        color: #667eea;
        margin-bottom: 15px;
    }

    .llm-features ul {
        margin: 0;
        padding-left: 20px;
    }

    .llm-features li {
        margin-bottom: 8px;
    }
    
    /* LLMç»“æœæ ·å¼ */
    .llm-result {
        margin-top: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .llm-result-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        background: #667eea;
        color: white;
    }
    
    .match-type-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }
    
    .match-type-badge.exact {
        background: #28a745;
    }
    
    .match-type-badge.semantic {
        background: #17a2b8;
    }
    
    .match-type-badge.web {
        background: #fd7e14;
    }
    
    .match-type-badge.llm_generated {
        background: #6f42c1;
    }
    
    .match-type-badge.none, .match-type-badge.error {
        background: #dc3545;
    }
    
    .llm-result-body {
        padding: 15px;
    }
    
    .llm-source-info {
        font-size: 12px;
        color: #666;
        padding: 8px 12px;
        background: #e9ecef;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    
    .llm-answer {
        padding: 10px;
        background: white;
        border-radius: 5px;
        line-height: 1.8;
        white-space: pre-wrap;
    }
    
    .confidence-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        font-size: 12px;
        color: #666;
    }
    
    .confidence-bar .bar {
        flex: 1;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
    }
    
    .confidence-bar .bar-fill {
        height: 100%;
        background: #667eea;
        border-radius: 3px;
        transition: width 0.3s;
    }
    
    /* æ‰¹é‡åˆ†æç»“æœæ ·å¼ */
    .batch-results {
        margin-top: 15px;
    }
    
    .batch-summary {
        display: flex;
        gap: 15px;
        padding: 12px 15px;
        background: #e8f4f8;
        border-radius: 8px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .batch-summary .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 13px;
    }
    
    .batch-summary .stat-count {
        font-weight: bold;
        color: #667eea;
    }
    
    .requirement-item {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
    }
    
    .requirement-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        background: #f8f9fa;
        cursor: pointer;
    }
    
    .requirement-header:hover {
        background: #e9ecef;
    }
    
    .requirement-index {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
        margin-right: 10px;
    }
    
    .requirement-title {
        flex: 1;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .requirement-body {
        padding: 15px;
        display: none;
    }
    
    .requirement-body.show {
        display: block;
    }
    
    .req-section {
        margin-bottom: 12px;
    }
    
    .req-section-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
        font-size: 13px;
    }
    
    .req-section-content {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        line-height: 1.6;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-message {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #666;
    }
    
    /* LLMé…ç½®å¼¹çª—æ ·å¼ */
    .llm-config-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }
    
    .llm-config-modal.show {
        display: flex;
    }
    
    .llm-modal-content {
        background: #fff;
        border-radius: 10px;
        width: 650px;
        max-width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    
    .llm-modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e4e7ed;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .llm-modal-header h3 {
        margin: 0;
        font-size: 18px;
        color: #333;
    }
    
    .llm-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #909399;
        line-height: 1;
    }
    
    .llm-modal-close:hover {
        color: #333;
    }
    
    .llm-modal-body {
        padding: 20px;
    }
    
    .llm-config-list {
        margin-bottom: 16px;
    }
    
    .llm-config-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 15px;
        border: 1px solid #e4e7ed;
        border-radius: 6px;
        margin-bottom: 10px;
        transition: all 0.2s;
    }
    
    .llm-config-item:hover {
        border-color: #667eea;
    }
    
    .llm-config-item.default {
        border-color: #667eea;
        background: #f0f4ff;
    }
    
    .llm-config-info {
        flex: 1;
    }
    
    .llm-config-name {
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
    }
    
    .llm-config-detail {
        font-size: 12px;
        color: #909399;
    }
    
    .llm-config-actions {
        display: flex;
        gap: 8px;
    }
    
    .llm-config-actions button {
        padding: 5px 12px;
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid #dcdfe6;
        background: #fff;
        transition: all 0.2s;
    }
    
    .llm-config-actions button:hover {
        border-color: #667eea;
        color: #667eea;
    }
    
    .llm-config-actions button.danger:hover {
        border-color: #dc3545;
        color: #dc3545;
    }
    
    .llm-form-group {
        margin-bottom: 15px;
    }
    
    .llm-form-group label {
        display: block;
        margin-bottom: 6px;
        font-size: 13px;
        color: #606266;
        font-weight: 500;
    }
    
    .llm-form-group input,
    .llm-form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dcdfe6;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
        transition: border-color 0.2s;
    }
    
    .llm-form-group input:focus,
    .llm-form-group select:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .llm-form-row {
        display: flex;
        gap: 15px;
    }
    
    .llm-form-row .llm-form-group {
        flex: 1;
    }
    
    /* æ‹›æ ‡ä½œç­”æ ·å¼ */
    .bid-preview {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    
    .bid-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e4e7ed;
    }
    
    .bid-preview-header h4 {
        margin: 0;
        color: #333;
    }
    
    .bid-section-item {
        background: #fff;
        border: 1px solid #e4e7ed;
        border-radius: 6px;
        margin-bottom: 10px;
        overflow: hidden;
    }
    
    .bid-section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        background: #f5f7fa;
    }
    
    .bid-section-header .section-number {
        background: #667eea;
        color: #fff;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .bid-section-header .section-title {
        flex: 1;
        font-weight: 500;
    }
    
    .bid-section-header .section-count {
        color: #909399;
        font-size: 12px;
    }
    
    .bid-requirements-list {
        padding: 10px 15px;
    }
    
    .bid-req-item {
        display: flex;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px dashed #eee;
    }
    
    .bid-req-item:last-child {
        border-bottom: none;
    }
    
    .bid-req-item .req-idx {
        color: #667eea;
        font-weight: 600;
        min-width: 25px;
    }
    
    .bid-req-item .req-text {
        color: #606266;
        font-size: 13px;
        line-height: 1.5;
    }
    
    .bid-req-more {
        color: #909399;
        font-size: 12px;
        padding: 8px 0;
        text-align: center;
    }
    
    .bid-warning {
        background: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 13px;
    }
    
    .bid-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e4e7ed;
    }
    
    /* æ‹›æ ‡ä½œç­”ç»“æœæ ·å¼ */
    .bid-results {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    
    .bid-results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .bid-results-header h4 {
        margin: 0;
        color: #333;
    }
    
    .bid-results-header .doc-info {
        color: #909399;
        font-size: 13px;
    }
    
    .bid-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        padding: 15px;
        background: #fff;
        border-radius: 6px;
        margin-bottom: 15px;
    }
    
    .bid-summary .summary-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 70px;
    }
    
    .bid-summary .summary-item span {
        font-size: 12px;
        color: #909399;
    }
    
    .bid-summary .summary-item strong {
        font-size: 20px;
        font-weight: 600;
    }
    
    .bid-export-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        padding: 10px 15px;
        background: #e8f4f8;
        border-radius: 6px;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .bid-section-result {
        background: #fff;
        border: 1px solid #e4e7ed;
        border-radius: 6px;
        margin-bottom: 10px;
        overflow: hidden;
    }
    
    .section-result-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        background: #f5f7fa;
        cursor: pointer;
        user-select: none;
    }
    
    .section-result-header:hover {
        background: #eef1f6;
    }
    
    .section-result-header .section-num {
        background: #667eea;
        color: #fff;
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
    }
    
    .section-result-header .section-title {
        flex: 1;
        font-weight: 500;
    }
    
    .section-result-header .section-toggle {
        color: #909399;
        transition: transform 0.2s;
    }
    
    .section-result-body {
        padding: 10px 15px;
    }
    
    .bid-answer-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .bid-answer-item:last-child {
        border-bottom: none;
    }
    
    .answer-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .answer-header .answer-idx {
        background: #e8f4fd;
        color: #1890ff;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .answer-header .match-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
    }
    
    .answer-requirement {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 13px;
        line-height: 1.6;
    }
    
    .answer-requirement em {
        color: #909399;
        display: block;
        margin-top: 5px;
    }
    
    .answer-content {
        font-size: 13px;
        line-height: 1.6;
    }
    
    .answer-content .answer-text {
        background: #f0fff4;
        border-left: 3px solid #28a745;
        padding: 10px;
        margin-top: 8px;
        border-radius: 0 4px 4px 0;
        white-space: pre-wrap;
    }
    
    .answer-source {
        margin-top: 8px;
        font-size: 12px;
        color: #909399;
    }
</style>

<div class="main-container">
    <!-- å·¦ä¾§èœå• -->
    <div class="sidebar">
        <h3>åŠŸèƒ½èœå•</h3>
        <ul>
            <li><a href="/documentlist">æ–‡æ¡£ä¸Šä¼ </a></li>
            <li><a href="/docprocess">æ–‡æ¡£å¤„ç†</a></li>
            <li><a href="/chatdoc" class="active">æ–‡æ¡£å¯¹è¯</a></li>
        </ul>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="content-area">
        <!-- Tab åˆ‡æ¢ -->
        <div class="tab-container">
            <button class="tab-btn active" data-tab="exact">ç²¾å‡†åŒ¹é…</button>
            <button class="tab-btn" data-tab="llm">LLMåŒ¹é…</button>
        </div>

        <!-- ç²¾å‡†åŒ¹é… Tab -->
        <div id="tab-exact" class="tab-content active">
            <!-- æ–‡æ¡£é€‰æ‹© -->
            <div class="doc-selector">
                <h4>é€‰æ‹©æŸ¥è¯¢èŒƒå›´ï¼ˆä¸é€‰åˆ™æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼‰:</h4>
                <div class="doc-list" id="docList">
                    <span style="color: #999;">åŠ è½½ä¸­...</span>
                </div>
            </div>

            <!-- å¯¹è¯åŒº -->
            <div class="chat-area">
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        <div class="message-content">
                            æ¬¢è¿ä½¿ç”¨æ–‡æ¡£å¯¹è¯åŠŸèƒ½ï¼æ‚¨å¯ä»¥ï¼š
                            <br>1. è¾“å…¥å…³é”®è¯è¿›è¡Œç²¾ç¡®åŒ¹é…æˆ–æ¨¡ç³ŠåŒ¹é…
                            <br>2. ä¸Šä¼ TXT/DOCXæ–‡ä»¶æ‰¹é‡æŸ¥è¯¢ï¼ˆTXTæ¯è¡Œä¸€ä¸ªå…³é”®è¯ï¼ŒDOCXè‡ªåŠ¨è§£æï¼‰
                            <br>3. æŸ¥è¯¢ç»“æœå¯å¯¼å‡ºä¸ºWordæ–‡æ¡£
                        </div>
                        <div class="message-time">ç³»ç»Ÿæ¶ˆæ¯</div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒº -->
                <div class="input-area">
                    <div class="input-row">
                        <textarea class="chat-input" id="queryInput" placeholder="è¾“å…¥æŸ¥è¯¢å†…å®¹..." rows="1"></textarea>
                    </div>
                    <div class="input-row">
                        <div class="file-upload-area">
                            <input type="file" id="txtFile" class="file-input" accept=".txt,.docx">
                            <label for="txtFile" class="file-label">ğŸ“„ ä¸Šä¼ æ‰¹é‡æŸ¥è¯¢æ–‡ä»¶</label>
                            <span class="file-name" id="fileName"></span>
                        </div>
                        <div style="flex: 1;"></div>
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                            <input type="checkbox" id="includeChildren" checked> åŒ…å«å­ç« èŠ‚
                        </label>
                        <select id="searchScope" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; background: white;">
                            <option value="title">åªæŸ¥è¯¢æ ‡é¢˜</option>
                            <option value="content">å†…å®¹åŒ¹é…(æ ‡é¢˜+å†…å®¹)</option>
                        </select>
                        <button class="btn btn-primary" id="btnExact" onclick="doSearch('exact')">å®Œå…¨åŒ¹é…</button>
                        <button class="btn btn-secondary" id="btnFuzzy" onclick="doSearch('fuzzy')">æ¨¡ç³ŠæŸ¥è¯¢</button>
                        <button class="btn btn-success" id="btnExport" onclick="exportToWord()" disabled>å¯¼å‡ºWord</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LLMåŒ¹é… Tab -->
        <div id="tab-llm" class="tab-content">
            <!-- æ–‡æ¡£é€‰æ‹©åŒº -->
            <div class="doc-selector">
                <h4>é€‰æ‹©æŸ¥è¯¢èŒƒå›´ï¼ˆä¸é€‰åˆ™æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼‰:</h4>
                <div class="doc-list" id="llmDocList">
                    <span style="color: #999;">åŠ è½½ä¸­...</span>
                </div>
            </div>
            
            <!-- LLMé…ç½®å’Œé€‰é¡¹åŒº -->
            <div class="llm-options-bar">
                <div class="option-group">
                    <label>LLMé…ç½®ï¼š</label>
                    <select id="llmConfigSelect">
                        <option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>
                    </select>
                    <a href="javascript:void(0)" onclick="openLLMConfigModal()" style="margin-left: 10px; color: #667eea; font-size: 13px;">ç®¡ç†é…ç½®</a>
                </div>
                <div class="option-group">
                    <label>Embeddingï¼š</label>
                    <select id="embeddingConfigSelect">
                        <option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>
                    </select>
                    <a href="javascript:void(0)" onclick="openEmbeddingConfigModal()" style="margin-left: 10px; color: #667eea; font-size: 13px;">é…ç½®</a>
                </div>
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="enableWebSearchLLM" checked> å¯ç”¨ç½‘ç»œæœç´¢
                    </label>
                    <select id="searchEngineSelect" style="margin-left: 5px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        <option value="">æ— é…ç½®</option>
                    </select>
                    <a href="javascript:void(0)" onclick="openSearchConfigModal()" style="margin-left: 5px; color: #667eea; font-size: 12px;">é…ç½®</a>
                </div>
                <div class="llm-status" id="llmStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">æ£€æŸ¥é…ç½®ä¸­...</span>
                </div>
            </div>
            
            <!-- å¯¹è¯åŒº -->
            <div class="chat-area">
                <div class="chat-messages" id="llmChatMessages">
                    <div class="message system">
                        <div class="message-content">
                            æ¬¢è¿ä½¿ç”¨LLMæ™ºèƒ½åŒ¹é…åŠŸèƒ½ï¼æ‚¨å¯ä»¥ï¼š
                            <br>1. <b>æ‹›æ ‡åº”ç­”æ¨¡å¼</b>ï¼šè¾“å…¥æŒ‡ä»¤å¦‚ "é’ˆå¯¹æ–‡æ¡£ä¸­çš„1.4.1,1.4.2ä½œç­”"ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å®šä½ç« èŠ‚å¹¶é€é¡¹å›ç­”æŠ€æœ¯è¦æ±‚
                            <br>2. <b>å•æ¡åŒ¹é…æ¨¡å¼</b>ï¼šç›´æ¥è¾“å…¥éœ€æ±‚å†…å®¹è¿›è¡Œæ™ºèƒ½åŒ¹é…
                            <br>3. <b>æ‰¹é‡åˆ†ææ¨¡å¼</b>ï¼šä¸Šä¼ éœ€æ±‚æ–‡æ¡£ï¼ˆ.docx/.txtï¼‰æ‰¹é‡åˆ†æ
                            <br>4. åŒ¹é…ä¼˜å…ˆçº§ï¼šç²¾ç¡®åŒ¹é… â†’ è¯­ä¹‰åŒ¹é… â†’ ç½‘ç»œæœç´¢ â†’ LLMç”Ÿæˆ
                        </div>
                        <div class="message-time">ç³»ç»Ÿæ¶ˆæ¯</div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒº -->
                <div class="input-area">
                    <div class="input-row">
                        <textarea class="chat-input" id="llmQueryInput" placeholder="è¾“å…¥æŒ‡ä»¤ï¼Œå¦‚ï¼šé’ˆå¯¹æ–‡æ¡£ä¸­çš„1.4.1,1.4.2ä½œç­”..." rows="1"></textarea>
                    </div>
                    <div class="input-row">
                        <div class="file-upload-area">
                            <input type="file" id="reqFile" class="file-input" accept=".docx,.txt">
                            <label for="reqFile" class="file-label">ğŸ“„ ä¸Šä¼ éœ€æ±‚æ–‡æ¡£</label>
                            <span class="file-name" id="reqFileName"></span>
                        </div>
                        <div style="flex: 1;"></div>
                        <button class="btn btn-primary" id="btnLLMSearch" onclick="doLLMSearch()">æ™ºèƒ½åŒ¹é…</button>
                        <button class="btn btn-secondary" id="btnAnalyzeFile" onclick="analyzeUploadedFile()" style="display:none;">åˆ†ææ–‡æ¡£</button>
                        <button class="btn btn-success" id="btnExportLLM" onclick="exportLLMResults()" disabled>å¯¼å‡ºWord</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å†²çªé€‰æ‹©å¯¹è¯æ¡† -->
<div class="conflict-dialog" id="conflictDialog">
    <div class="conflict-content">
        <div class="conflict-title">å¤šä¸ªæ–‡æ¡£åŒ¹é…åˆ°ç›¸åŒå†…å®¹</div>
        <p>ä»¥ä¸‹æ–‡æ¡£éƒ½åŒ…å«åŒ¹é…çš„å†…å®¹ï¼Œè¯·é€‰æ‹©è¦ä½¿ç”¨çš„æ–‡æ¡£ï¼š</p>
        <div class="conflict-options" id="conflictOptions"></div>
        <div class="conflict-actions">
            <button class="btn btn-outline" onclick="closeConflictDialog()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmConflictSelection()">ç¡®è®¤é€‰æ‹©</button>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆ -->
<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <img id="modalImage" src="" alt="å›¾ç‰‡é¢„è§ˆ">
</div>

<!-- LLMé…ç½®ç®¡ç†å¼¹çª— -->
<div class="llm-config-modal" id="llmConfigModal">
    <div class="llm-modal-content">
        <div class="llm-modal-header">
            <h3>LLMé…ç½®ç®¡ç†</h3>
            <button class="llm-modal-close" onclick="closeLLMConfigModal()">&times;</button>
        </div>
        <div class="llm-modal-body">
            <div class="llm-config-list" id="llmConfigList">
                <!-- é…ç½®åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
            </div>
            <button class="btn btn-primary" onclick="showAddLLMConfigForm()" style="margin-top: 15px;">+ æ·»åŠ æ–°é…ç½®</button>
            
            <!-- æ·»åŠ /ç¼–è¾‘é…ç½®è¡¨å• -->
            <div id="llmConfigForm" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e4e7ed;">
                <h4 id="llmConfigFormTitle" style="margin-bottom: 15px;">æ·»åŠ é…ç½®</h4>
                <input type="hidden" id="editLLMConfigId">
                
                <div class="llm-form-group">
                    <label>é…ç½®åç§°</label>
                    <input type="text" id="llmConfigName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„GPT-4é…ç½®">
                </div>
                
                <div class="llm-form-row">
                    <div class="llm-form-group">
                        <label>æ¨¡å‹ç±»å‹</label>
                        <select id="llmModelType" onchange="onLLMModelTypeChange()">
                            <option value="openai">OpenAI</option>
                            <option value="qianwen">é€šä¹‰åƒé—®</option>
                            <option value="wenxin">æ–‡å¿ƒä¸€è¨€</option>
                            <option value="zhipu">æ™ºè°±GLM</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div class="llm-form-group">
                        <label>æ¨¡å‹åç§°</label>
                        <select id="llmModelName">
                            <option value="gpt-4">gpt-4</option>
                            <option value="gpt-4-turbo">gpt-4-turbo</option>
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        </select>
                    </div>
                </div>
                
                <div class="llm-form-group">
                    <label>API Base URLï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰</label>
                    <input type="text" id="llmApiBaseUrl" placeholder="https://api.openai.com/v1">
                </div>
                
                <div class="llm-form-group">
                    <label>API Key</label>
                    <input type="password" id="llmApiKey" placeholder="sk-...">
                </div>
                
                <div class="llm-form-row">
                    <div class="llm-form-group">
                        <label>Max Tokens</label>
                        <input type="number" id="llmMaxTokens" value="2048">
                    </div>
                    <div class="llm-form-group">
                        <label>Temperature</label>
                        <input type="number" id="llmTemperature" value="0.7" step="0.1" min="0" max="2">
                    </div>
                </div>
                
                <div class="llm-form-group">
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="llmIsDefault">
                        è®¾ä¸ºé»˜è®¤é…ç½®
                    </label>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="saveLLMConfig()">ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="hideLLMConfigForm()">å–æ¶ˆ</button>
                    <button class="btn btn-outline" onclick="testLLMConfig()">æµ‹è¯•è¿æ¥</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æœç´¢å¼•æ“é…ç½®å¼¹çª— -->
<div class="llm-config-modal" id="searchConfigModal">
    <div class="llm-modal-content" style="width: 550px;">
        <div class="llm-modal-header">
            <h3>ç½‘ç»œæœç´¢å¼•æ“é…ç½®</h3>
            <button class="llm-modal-close" onclick="closeSearchConfigModal()">&times;</button>
        </div>
        <div class="llm-modal-body">
            <div class="llm-config-list" id="searchConfigList">
                <!-- é…ç½®åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
            </div>
            <button class="btn btn-primary" onclick="showAddSearchConfigForm()" style="margin-top: 15px;">+ æ·»åŠ æœç´¢å¼•æ“</button>
            
            <!-- æ·»åŠ /ç¼–è¾‘æœç´¢é…ç½®è¡¨å• -->
            <div id="searchConfigForm" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e4e7ed;">
                <h4 id="searchConfigFormTitle" style="margin-bottom: 15px;">æ·»åŠ æœç´¢å¼•æ“</h4>
                <input type="hidden" id="editSearchConfigId">
                
                <div class="llm-form-group">
                    <label>æœç´¢å¼•æ“</label>
                    <select id="searchEngineType" onchange="onSearchEngineTypeChange()">
                        <option value="duckduckgo">DuckDuckGoï¼ˆå…è´¹ï¼Œæ— éœ€API Keyï¼‰</option>
                        <option value="google">Google è‡ªå®šä¹‰æœç´¢</option>
                        <option value="bing">Bing æœç´¢</option>
                        <option value="baidu">ç™¾åº¦æœç´¢</option>
                        <option value="custom">è‡ªå®šä¹‰æœç´¢å¼•æ“</option>
                    </select>
                </div>
                
                <div class="llm-form-group" id="searchApiUrlGroup">
                    <label>API URL</label>
                    <input type="text" id="searchApiUrl" placeholder="https://www.googleapis.com/customsearch/v1">
                </div>
                
                <div class="llm-form-group" id="searchApiKeyGroup">
                    <label>API Key</label>
                    <input type="password" id="searchApiKey" placeholder="è¾“å…¥APIå¯†é’¥">
                </div>
                
                <div class="llm-form-group" id="searchExtraParamsGroup">
                    <label>é¢å¤–å‚æ•°ï¼ˆJSONæ ¼å¼ï¼Œå¦‚Googleçš„cxå‚æ•°ï¼‰</label>
                    <textarea id="searchExtraParams" rows="3" placeholder='{"cx": "ä½ çš„æœç´¢å¼•æ“ID"}'></textarea>
                </div>
                
                <div class="llm-form-group">
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="searchIsDefault">
                        è®¾ä¸ºé»˜è®¤æœç´¢å¼•æ“
                    </label>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="saveSearchConfig()">ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="hideSearchConfigForm()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Embedding é…ç½®ç®¡ç†å¼¹çª— -->
<div class="llm-config-modal" id="embeddingConfigModal">
    <div class="llm-modal-content" style="width: 600px;">
        <div class="llm-modal-header">
            <h3>Embedding å‘é‡æ¨¡å‹é…ç½®</h3>
            <button class="llm-modal-close" onclick="closeEmbeddingConfigModal()">&times;</button>
        </div>
        <div class="llm-modal-body">
            <!-- Embedding çŠ¶æ€æç¤º -->
            <div id="embeddingStatusInfo" style="padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; background: #e6f7ff; border: 1px solid #91d5ff;">
                æ£€æŸ¥é…ç½®ä¸­...
            </div>
            
            <div class="llm-config-list" id="embeddingConfigList">
                <!-- é…ç½®åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
            </div>
            <button class="btn btn-primary" onclick="showAddEmbeddingConfigForm()" style="margin-top: 15px;">+ æ·»åŠ é…ç½®</button>
            
            <!-- æ·»åŠ /ç¼–è¾‘é…ç½®è¡¨å• -->
            <div id="embeddingConfigForm" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e4e7ed;">
                <h4 id="embeddingConfigFormTitle" style="margin-bottom: 15px;">æ·»åŠ  Embedding é…ç½®</h4>
                <input type="hidden" id="editEmbeddingConfigId">
                
                <div class="llm-form-group">
                    <label>é…ç½®åç§°</label>
                    <input type="text" id="embeddingConfigName" placeholder="ä¾‹å¦‚ï¼šæ··å…ƒEmbedding">
                </div>
                
                <div class="llm-form-row">
                    <div class="llm-form-group">
                        <label>æä¾›å•†</label>
                        <select id="embeddingProvider" onchange="onEmbeddingProviderChange()">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            <option value="hunyuan">è…¾è®¯æ··å…ƒ</option>
                            <option value="openai">OpenAI</option>
                            <option value="huggingface">HuggingFace æœ¬åœ°æ¨¡å‹</option>
                        </select>
                    </div>
                    <div class="llm-form-group">
                        <label>æ¨¡å‹åç§°</label>
                        <select id="embeddingModelName">
                            <option value="">-- è¯·å…ˆé€‰æ‹©æä¾›å•† --</option>
                        </select>
                    </div>
                </div>
                
                <div class="llm-form-group" id="embeddingApiKeyGroup">
                    <label>API Key / Secret ID</label>
                    <input type="password" id="embeddingApiKey" placeholder="è…¾è®¯äº‘ SecretId æˆ– OpenAI API Key">
                </div>
                
                <div class="llm-form-group" id="embeddingApiBaseGroup" style="display: none;">
                    <label>API Base URLï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="embeddingApiBase" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤åœ°å€">
                </div>
                
                <div class="llm-form-row">
                    <div class="llm-form-group">
                        <label>å‘é‡ç»´åº¦</label>
                        <input type="number" id="embeddingDimensions" value="1024" readonly style="background: #f5f7fa;">
                    </div>
                    <div class="llm-form-group" id="embeddingSecretKeyGroup">
                        <label>Secret Keyï¼ˆè…¾è®¯äº‘ï¼‰</label>
                        <input type="password" id="embeddingSecretKey" placeholder="è…¾è®¯äº‘ SecretKey">
                    </div>
                </div>
                
                <div class="llm-form-group">
                    <label style="display: inline-flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="embeddingIsDefault">
                        è®¾ä¸ºé»˜è®¤é…ç½®
                    </label>
                </div>
                
                <div id="embeddingTestResult" style="display: none; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 13px;"></div>
                
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="saveEmbeddingConfig()">ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="hideEmbeddingConfigForm()">å–æ¶ˆ</button>
                    <button class="btn btn-outline" onclick="testEmbeddingConfig()">æµ‹è¯•è¿æ¥</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE = '/api/chat';

// ç»Ÿä¸€çš„å ä½å›¾ï¼ˆç”¨äºæ‡’åŠ è½½/å†…è”å±•ç¤ºï¼‰
const PLACEHOLDER_IMG = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTIwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik00MCA0MEw2MCA2MEw4MCA0MEw4MCA3MEg0MFY0MFoiIGZpbGw9IiNEREREREQiLz4KPHRleHQgeD0iNjAiIHk9IjUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjEyIj7ngrnlh7vliKDovb08L3RleHQ+PC9zdmc+';

// æ³¨æ„ï¼šæ¨¡æ¿ç”± Jinja2 æ¸²æŸ“ï¼Œæºç é‡Œä¸èƒ½å‡ºç°è¿ç»­ä¸¤ä¸ªå·¦å¤§æ‹¬å·ï¼Œå¦åˆ™ä¼šè¢«å½“æˆæ¨¡æ¿è¯­æ³•ã€‚
const IMAGE_ID_PREFIX = '{' + '{IMAGE_ID_';
const IMAGE_ID_RE = /\{\{IMAGE_ID_(\d+)\}\}/g;

// å°†ç« èŠ‚ content ä¸­çš„ IMAGE_ID å ä½ç¬¦æ›¿æ¢ä¸ºå†…è” <img>ï¼ˆå…ˆ escapeï¼Œå†æ›¿æ¢ï¼Œé¿å… XSSï¼‰
// åŒæ—¶å¤„ç† [è¡¨æ ¼]...[/è¡¨æ ¼] æ ‡ç­¾ï¼Œæ¸²æŸ“æˆ HTML è¡¨æ ¼
function renderContentWithImages(content, images) {
    const imgMap = {};
    (images || []).forEach(img => {
        if (img && img.id) {
            imgMap[String(img.id)] = img.image_url || img.image_path;
        }
    });

    const escaped = escapeHtml(content || '');
    
    // å…ˆæ›¿æ¢å›¾ç‰‡å ä½ç¬¦
    let result = escaped.replace(IMAGE_ID_RE, (m, id) => {
        const url = imgMap[String(id)];
        if (!url) return m;
        const safeUrl = escapeHtml(url);
        return `<div style="margin:10px 0;"><img class="chapter-image" data-src="${safeUrl}" src="${safeUrl}" alt="å›¾ç‰‡ ${id}" onclick="showImage(this.getAttribute('data-src'))"></div>`;
    });
    
    // å¤„ç† [è¡¨æ ¼]...[/è¡¨æ ¼] æ ‡ç­¾ï¼šæ¸²æŸ“æˆå¸¦è¾¹æ¡†çš„è¡¨æ ¼
    // æ³¨æ„ï¼šescapeHtml å [ å’Œ ] ä¸ä¼šè¢«è½¬ä¹‰ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åŒ¹é…
    result = result.replace(/\[è¡¨æ ¼\]([\s\S]*?)\[\/è¡¨æ ¼\]/g, (m, tableContent) => {
        // å»æ‰é¦–å°¾ç©ºç™½å’Œæ¢è¡Œç¬¦
        const cleaned = tableContent.trim();
        if (!cleaned) return '';
        return `<table class="inline-table" style="border:1px solid #ccc; border-collapse:collapse; margin:10px 0; width:100%;"><tr><td style="border:1px solid #ccc; padding:10px;">${cleaned.replace(/\r?\n/g, '<br>')}</td></tr></table>`;
    });
    
    // å¤„ç†å‰©ä½™çš„æ¢è¡Œç¬¦
    result = result.replace(/\r?\n/g, '<br>');
    
    return result;
}

let selectedDocuments = [];
let lastSearchResults = null;
let pendingConflict = null;

// Tab åˆ‡æ¢
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
});

// åŠ è½½æ–‡æ¡£åˆ—è¡¨
async function loadDocuments() {
    try {
        const response = await fetch(`${API_BASE}/documents`, {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            renderDocList(result.data);
        } else {
            document.getElementById('docList').innerHTML = '<span style="color: #dc3545;">åŠ è½½å¤±è´¥</span>';
        }
    } catch (error) {
        console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('docList').innerHTML = '<span style="color: #dc3545;">åŠ è½½å¤±è´¥</span>';
    }
}

function renderDocList(documents) {
    const container = document.getElementById('docList');
    
    if (!documents || documents.length === 0) {
        container.innerHTML = '<span style="color: #999;">æš‚æ— å·²å¤„ç†çš„æ–‡æ¡£</span>';
        return;
    }
    
    container.innerHTML = documents.map(doc => `
        <label class="doc-checkbox" data-doc-id="${doc.doc_id}">
            <input type="checkbox" value="${doc.doc_id}" onchange="toggleDocument('${doc.doc_id}')">
            ${escapeHtml(doc.filename)}
        </label>
    `).join('');
}

function toggleDocument(docId) {
    const index = selectedDocuments.indexOf(docId);
    const checkbox = document.querySelector(`.doc-checkbox[data-doc-id="${docId}"]`);
    
    if (index === -1) {
        selectedDocuments.push(docId);
        checkbox.classList.add('selected');
    } else {
        selectedDocuments.splice(index, 1);
        checkbox.classList.remove('selected');
    }
}

// æœç´¢åŠŸèƒ½
async function doSearch(matchType) {
    const input = document.getElementById('queryInput');
    const query = input.value.trim();
    const txtFile = document.getElementById('txtFile');
    const includeChildren = document.getElementById('includeChildren').checked;
    const searchScope = document.getElementById('searchScope').value;  // è·å–æœç´¢èŒƒå›´
    
    // æ£€æŸ¥æ˜¯å¦æœ‰TXTæ–‡ä»¶ä¸Šä¼ 
    if (txtFile.files.length > 0) {
        await doBatchSearch(matchType);
        return;
    }
    
    if (!query) {
        alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
        return;
    }
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const scopeText = searchScope === 'content' ? '(å†…å®¹åŒ¹é…)' : '(æ ‡é¢˜åŒ¹é…)';
    addMessage('user', `${query} ${scopeText}`);
    input.value = '';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const loadingId = addLoadingMessage();
    
    try {
        const response = await fetch(`${API_BASE}/search`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                query: query,
                match_type: matchType,
                document_ids: selectedDocuments,
                include_children: includeChildren,
                search_scope: searchScope  // ä¼ é€’æœç´¢èŒƒå›´å‚æ•°
            })
        });
        
        const result = await response.json();
        removeMessage(loadingId);
        
        if (result.success) {
            lastSearchResults = [{
                query: query,
                results: result.data.results,
                match_count: result.data.total_matches
            }];
            
            // ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰åŒ¹é…ç»“æœï¼ˆä¸å†å¼¹å‡ºé€‰æ‹©å¯¹è¯æ¡†ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¤é€‰æ¡†é€‰æ‹©è¦å¯¼å‡ºçš„å†…å®¹ï¼‰
            displaySearchResult(result.data);
            
            // æ˜¾ç¤ºæŸ¥è¯¢å®Œæˆæç¤º
            if (result.data.total_matches > 0) {
                addMessage('system', `âœ… æŸ¥è¯¢å®Œæˆï¼æ‰¾åˆ° <strong>${result.data.total_matches}</strong> ä¸ªåŒ¹é…ç»“æœã€‚<br>æ‚¨å¯ä»¥é€šè¿‡å¤é€‰æ¡†é€‰æ‹©è¦å¯¼å‡ºçš„å†…å®¹ï¼Œç„¶åç‚¹å‡» <strong>"å¯¼å‡ºWord"</strong> æŒ‰é’®å¯¼å‡ºã€‚`, true);
            }
            
            // å¯ç”¨å¯¼å‡ºæŒ‰é’®
            if (result.data.total_matches > 0) {
                document.getElementById('btnExport').disabled = false;
            }
        } else {
            addMessage('system', `æŸ¥è¯¢å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        removeMessage(loadingId);
        addMessage('system', `æŸ¥è¯¢å‡ºé”™: ${error.message}`);
    }
}

// æ‰¹é‡æœç´¢
async function doBatchSearch(matchType) {
    const txtFile = document.getElementById('txtFile');
    const includeChildren = document.getElementById('includeChildren').checked;
    const searchScope = document.getElementById('searchScope').value;  // è·å–æœç´¢èŒƒå›´
    
    if (txtFile.files.length === 0) {
        alert('è¯·å…ˆä¸Šä¼ TXTæ–‡ä»¶');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', txtFile.files[0]);
    
    // å…ˆä¸Šä¼ æ–‡ä»¶è·å–æŸ¥è¯¢åˆ—è¡¨
    const scopeText = searchScope === 'content' ? '(å†…å®¹åŒ¹é…)' : '(æ ‡é¢˜åŒ¹é…)';
    addMessage('user', `æ‰¹é‡æŸ¥è¯¢æ–‡ä»¶: ${txtFile.files[0].name} ${scopeText}`);
    const loadingId = addLoadingMessage();
    
    try {
        // ä¸Šä¼ TXTæ–‡ä»¶
        const uploadResponse = await fetch(`${API_BASE}/upload-txt`, {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });
        
        const uploadResult = await uploadResponse.json();
        
        if (!uploadResult.success) {
            removeMessage(loadingId);
            addMessage('system', `æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${uploadResult.error}`);
            return;
        }
        
        const queries = uploadResult.data.queries;
        addMessage('system', `å·²è§£æ ${queries.length} æ¡æŸ¥è¯¢`);
        
        // æ‰§è¡Œæ‰¹é‡æœç´¢
        const searchResponse = await fetch(`${API_BASE}/batch-search`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                queries: queries,
                match_type: matchType,
                document_ids: selectedDocuments,
                include_children: includeChildren,
                search_scope: searchScope  // ä¼ é€’æœç´¢èŒƒå›´å‚æ•°
            })
        });
        
        const searchResult = await searchResponse.json();
        removeMessage(loadingId);
        
        if (searchResult.success) {
            lastSearchResults = searchResult.data.batch_results;
            displayBatchResults(searchResult.data);
            
            // å¯ç”¨å¯¼å‡ºæŒ‰é’®
            const hasResults = searchResult.data.batch_results.some(r => r.match_count > 0);
            document.getElementById('btnExport').disabled = !hasResults;
            
            // æ˜¾ç¤ºæŸ¥è¯¢å®Œæˆæç¤º
            if (hasResults) {
                const totalMatches = searchResult.data.batch_results.reduce((sum, r) => sum + r.match_count, 0);
                addMessage('system', `âœ… æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼å…±æ‰¾åˆ° <strong>${totalMatches}</strong> ä¸ªåŒ¹é…ç»“æœã€‚<br>æ‚¨å¯ä»¥ç‚¹å‡» <strong>"å¯¼å‡ºWord"</strong> æŒ‰é’®å°†ç»“æœå¯¼å‡ºä¸ºæ–‡æ¡£ã€‚`, true);
            }
        } else {
            addMessage('system', `æ‰¹é‡æŸ¥è¯¢å¤±è´¥: ${searchResult.error}`);
        }
        
        // æ¸…é™¤æ–‡ä»¶
        txtFile.value = '';
        document.getElementById('fileName').textContent = '';
        
    } catch (error) {
        removeMessage(loadingId);
        addMessage('system', `æ‰¹é‡æŸ¥è¯¢å‡ºé”™: ${error.message}`);
    }
}

// æ˜¾ç¤ºæœç´¢ç»“æœ
function displaySearchResult(data) {
    const matchType = data.match_type === 'exact' ? 'å®Œå…¨åŒ¹é…' : 'æ¨¡ç³ŠåŒ¹é…';
    const scopeType = data.search_scope === 'content' ? 'æ ‡é¢˜+å†…å®¹' : 'ä»…æ ‡é¢˜';
    
    if (data.results.length === 0) {
        addMessage('system', `æœªæ‰¾åˆ°åŒ¹é…çš„å†…å®¹ï¼ˆ${matchType}ï¼Œ${scopeType}ï¼‰`);
        return;
    }
    
    let html = `<div class="search-result">`;
    html += `<p>æ‰¾åˆ° <strong>${data.total_matches}</strong> ä¸ªåŒ¹é…é¡¹ï¼ˆ${matchType}ï¼Œ${scopeType}ï¼‰ï¼Œæ¥è‡ª <strong>${data.document_count}</strong> ä¸ªæ–‡æ¡£ï¼š</p>`;
    
    let docIndex = 0;
    for (const docResult of data.results) {
        html += renderDocResult(docResult, docIndex);
        docIndex++;
    }
    
    html += `</div>`;
    addMessage('system', html, true);
}

// æ˜¾ç¤ºæ‰¹é‡ç»“æœ
function displayBatchResults(data) {
    let html = `<div class="search-result">`;
    html += `<p>æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼Œå…± ${data.total_queries} æ¡æŸ¥è¯¢ï¼š</p>`;
    
    let globalDocIndex = 0;
    for (const queryResult of data.batch_results) {
        html += `<h4 style="margin: 15px 0 10px 0; color: #667eea;">æŸ¥è¯¢: "${escapeHtml(queryResult.query)}"</h4>`;
        
        if (queryResult.results.length === 0) {
            html += `<p style="color: #999;">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</p>`;
        } else {
            for (const docResult of queryResult.results) {
                html += renderDocResult(docResult, globalDocIndex);
                globalDocIndex++;
            }
        }
    }
    
    html += `</div>`;
    addMessage('system', html, true);
}

// æ¸²æŸ“æ–‡æ¡£ç»“æœ
function renderDocResult(docResult, docIndex) {
    const docKey = `doc_${docIndex}`;
    let html = `<div class="result-doc" data-doc-key="${docKey}">`;
    html += `<div class="result-doc-header">
        <span>ğŸ“„ ${escapeHtml(docResult.filename)}</span>
        <span>${docResult.chapters.length} ä¸ªç« èŠ‚</span>
    </div>`;
    
    // å…¨é€‰æ§åˆ¶æ 
    html += `<div class="select-all-bar">
        <label>
            <input type="checkbox" class="select-all-checkbox" data-doc-key="${docKey}" onchange="toggleSelectAll(this)" checked>
            å…¨é€‰
        </label>
        <span class="select-count" id="count_${docKey}">å·²é€‰ ${docResult.chapters.length}/${docResult.chapters.length}</span>
    </div>`;
    
    let chapterIndex = 0;
    for (const chapter of docResult.chapters) {
        html += renderChapter(chapter, false, docKey, chapterIndex);
        chapterIndex++;
    }
    
    html += `</div>`;
    return html;
}

// æ¸²æŸ“ç« èŠ‚
function renderChapter(chapter, isChild = false, docKey = '', chapterIndex = 0) {
    const chapterId = chapter.id || `${docKey}_ch_${chapterIndex}`;
    const checkboxId = `chk_${docKey}_${chapterIndex}`;
    
    let html = `<div class="result-chapter${isChild ? ' chapter-child' : ''}" data-chapter-id="${chapterId}" data-doc-key="${docKey}">`;
    
    // éå­ç« èŠ‚æ—¶æ˜¾ç¤ºå¤é€‰æ¡†
    if (!isChild) {
        html += `<div class="chapter-select-wrapper">`;
        html += `<input type="checkbox" class="chapter-select-checkbox" id="${checkboxId}" data-doc-key="${docKey}" data-chapter-id="${chapterId}" onchange="onChapterCheckChange('${docKey}')" checked>`;
        html += `<div class="chapter-select-content">`;
    }
    
    // æ˜¾ç¤ºå±‚çº§è·¯å¾„ï¼ˆåªåœ¨éå­ç« èŠ‚æ—¶æ˜¾ç¤ºï¼Œæ˜¾ç¤ºå®Œæ•´è·¯å¾„åŒ…æ‹¬å½“å‰ç« èŠ‚ï¼‰
    if (!isChild && chapter.path && chapter.path.length > 0) {
        const pathTitles = chapter.path.map(p => escapeHtml(p.title || '(æ— æ ‡é¢˜)'));
        html += `<div class="chapter-path">${pathTitles.join(' -> ')}</div>`;
    }
    
    // æ˜¾ç¤ºåŒ¹é…æ¥æºæ ‡ç­¾
    const matchFieldLabel = chapter.match_field === 'content' ? 
        '<span style="background:#ff9800;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-left:8px;">å†…å®¹åŒ¹é…</span>' : 
        '<span style="background:#4caf50;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-left:8px;">æ ‡é¢˜åŒ¹é…</span>';
    
    html += `<div class="chapter-title">
        <span class="chapter-level">L${chapter.level}</span>
        ${escapeHtml(chapter.title || '(æ— æ ‡é¢˜)')}
        ${!isChild && chapter.match_field ? matchFieldLabel : ''}
    </div>`;
    
    if (chapter.content) {
        html += `<div class="chapter-content">${renderContentWithImages(chapter.content, chapter.images || [])}</div>`;
    }

    const hasInlineImages = chapter.content && chapter.content.includes(IMAGE_ID_PREFIX);

    // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœ content æ²¡æœ‰å ä½ç¬¦ï¼Œä½† images æœ‰å€¼ï¼Œåˆ™æ˜¾ç¤ºå›¾ç‰‡åˆ—è¡¨
    if (!hasInlineImages && chapter.images && chapter.images.length > 0) {
        html += `<div class="chapter-images">`;
        for (const img of chapter.images) {
            const imgUrl = img.image_url || img.image_path;
            const safeUrl = escapeHtml(imgUrl);
            html += `<img class="chapter-image" src="${safeUrl}" data-src="${safeUrl}" onclick="showImage(this.getAttribute('data-src'))" alt="ç« èŠ‚å›¾ç‰‡">`;
        }
        html += `</div>`;
    }
    
    // æ˜¾ç¤ºå­ç« èŠ‚
    if (chapter.children && chapter.children.length > 0) {
        html += `<div class="chapter-children">`;
        let childIndex = 0;
        for (const child of chapter.children) {
            html += renderChapter(child, true, docKey, childIndex);
            childIndex++;
        }
        html += `</div>`;
    }
    
    // å…³é—­å¤é€‰æ¡†åŒ…è£…
    if (!isChild) {
        html += `</div></div>`;  // å…³é—­ chapter-select-content å’Œ chapter-select-wrapper
    }
    
    html += `</div>`;
    return html;
}

// å¯¼å‡ºWord
async function exportToWord() {
    if (!lastSearchResults || lastSearchResults.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
        return;
    }
    
    // è·å–æ‰€æœ‰é€‰ä¸­çš„ç« èŠ‚ID
    const selectedChapterIds = getSelectedChapterIds();
    
    if (selectedChapterIds.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç« èŠ‚è¿›è¡Œå¯¼å‡º');
        return;
    }
    
    // è¿‡æ»¤å‡ºé€‰ä¸­çš„ç« èŠ‚
    const filteredResults = filterSelectedChapters(lastSearchResults, selectedChapterIds);
    
    if (filteredResults.length === 0) {
        alert('æ²¡æœ‰é€‰ä¸­çš„ç« èŠ‚å¯å¯¼å‡º');
        return;
    }
    
    const btn = document.getElementById('btnExport');
    btn.disabled = true;
    btn.textContent = 'å¯¼å‡ºä¸­...';
    
    try {
        const response = await fetch(`${API_BASE}/export-word`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                results: filteredResults,
                title: 'æ–‡æ¡£æŸ¥è¯¢ç»“æœ'
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æŸ¥è¯¢ç»“æœ_${new Date().toISOString().slice(0,10)}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            addMessage('system', `Wordæ–‡æ¡£å·²ä¸‹è½½ï¼ˆå…±å¯¼å‡º ${selectedChapterIds.length} ä¸ªç« èŠ‚ï¼‰`);
        } else {
            const result = await response.json();
            addMessage('system', `å¯¼å‡ºå¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        addMessage('system', `å¯¼å‡ºå‡ºé”™: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'å¯¼å‡ºWord';
    }
}

// è·å–æ‰€æœ‰é€‰ä¸­çš„ç« èŠ‚ID
function getSelectedChapterIds() {
    const checkboxes = document.querySelectorAll('.chapter-select-checkbox:checked');
    const ids = [];
    checkboxes.forEach(cb => {
        ids.push(cb.dataset.chapterId);
    });
    return ids;
}

// è¿‡æ»¤å‡ºé€‰ä¸­çš„ç« èŠ‚
function filterSelectedChapters(results, selectedIds) {
    const selectedSet = new Set(selectedIds);
    const filtered = [];
    
    for (const queryResult of results) {
        const filteredQueryResult = {
            query: queryResult.query,
            results: [],
            match_count: 0
        };
        
        for (const docResult of queryResult.results) {
            const filteredChapters = docResult.chapters.filter(chapter => {
                const chapterId = String(chapter.id);
                return selectedSet.has(chapterId);
            });
            
            if (filteredChapters.length > 0) {
                filteredQueryResult.results.push({
                    document_id: docResult.document_id,
                    filename: docResult.filename,
                    chapters: filteredChapters
                });
                filteredQueryResult.match_count += filteredChapters.length;
            }
        }
        
        if (filteredQueryResult.results.length > 0) {
            filtered.push(filteredQueryResult);
        }
    }
    
    return filtered;
}

// å…¨é€‰/å–æ¶ˆå…¨é€‰
function toggleSelectAll(checkbox) {
    const docKey = checkbox.dataset.docKey;
    const isChecked = checkbox.checked;
    
    // æ‰¾åˆ°è¯¥æ–‡æ¡£ä¸‹çš„æ‰€æœ‰ç« èŠ‚å¤é€‰æ¡†
    const chapterCheckboxes = document.querySelectorAll(`.chapter-select-checkbox[data-doc-key="${docKey}"]`);
    chapterCheckboxes.forEach(cb => {
        cb.checked = isChecked;
    });
    
    // æ›´æ–°è®¡æ•°
    updateSelectCount(docKey);
}

// ç« èŠ‚å¤é€‰æ¡†å˜åŒ–æ—¶æ›´æ–°çŠ¶æ€
function onChapterCheckChange(docKey) {
    updateSelectCount(docKey);
    updateSelectAllState(docKey);
}

// æ›´æ–°é€‰ä¸­è®¡æ•°
function updateSelectCount(docKey) {
    const allCheckboxes = document.querySelectorAll(`.chapter-select-checkbox[data-doc-key="${docKey}"]`);
    const checkedCheckboxes = document.querySelectorAll(`.chapter-select-checkbox[data-doc-key="${docKey}"]:checked`);
    
    const countEl = document.getElementById(`count_${docKey}`);
    if (countEl) {
        countEl.textContent = `å·²é€‰ ${checkedCheckboxes.length}/${allCheckboxes.length}`;
    }
}

// æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
function updateSelectAllState(docKey) {
    const allCheckboxes = document.querySelectorAll(`.chapter-select-checkbox[data-doc-key="${docKey}"]`);
    const checkedCheckboxes = document.querySelectorAll(`.chapter-select-checkbox[data-doc-key="${docKey}"]:checked`);
    const selectAllCheckbox = document.querySelector(`.select-all-checkbox[data-doc-key="${docKey}"]`);
    
    if (selectAllCheckbox) {
        if (checkedCheckboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCheckboxes.length === allCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
}

// å†²çªå¯¹è¯æ¡†
function showConflictDialog(query, matchType, results) {
    pendingConflict = { query, matchType, results };
    
    const optionsHtml = results.map(doc => `
        <div class="conflict-option" data-doc-id="${doc.document_id}" onclick="selectConflictOption(this)">
            <strong>${escapeHtml(doc.filename)}</strong>
            <br><small>${doc.chapters.length} ä¸ªåŒ¹é…ç« èŠ‚</small>
        </div>
    `).join('');
    
    document.getElementById('conflictOptions').innerHTML = optionsHtml;
    document.getElementById('conflictDialog').classList.add('show');
}

function selectConflictOption(element) {
    document.querySelectorAll('.conflict-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
}

function closeConflictDialog() {
    document.getElementById('conflictDialog').classList.remove('show');
    pendingConflict = null;
    
    // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œæ˜¾ç¤ºæ‰€æœ‰ç»“æœ
    if (lastSearchResults && lastSearchResults.length > 0) {
        displaySearchResult({
            results: lastSearchResults[0].results,
            total_matches: lastSearchResults[0].match_count,
            document_count: lastSearchResults[0].results.length,
            match_type: 'exact'
        });
    }
}

async function confirmConflictSelection() {
    const selected = document.querySelector('.conflict-option.selected');
    if (!selected) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£');
        return;
    }
    
    const docId = selected.dataset.docId;
    document.getElementById('conflictDialog').classList.remove('show');
    
    const loadingId = addLoadingMessage();
    
    try {
        const response = await fetch(`${API_BASE}/select-document`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                document_id: docId,
                query: pendingConflict.query,
                match_type: pendingConflict.matchType,
                include_children: document.getElementById('includeChildren').checked
            })
        });
        
        const result = await response.json();
        removeMessage(loadingId);
        
        if (result.success) {
            // æ‰¾åˆ°é€‰ä¸­æ–‡æ¡£çš„ä¿¡æ¯
            const selectedDoc = pendingConflict.results.find(r => r.document_id === docId);
            
            lastSearchResults = [{
                query: pendingConflict.query,
                results: [{
                    document_id: docId,
                    filename: selectedDoc ? selectedDoc.filename : 'æœªçŸ¥æ–‡æ¡£',
                    chapters: result.data.chapters
                }],
                match_count: result.data.chapters.length
            }];
            
            displaySearchResult({
                results: lastSearchResults[0].results,
                total_matches: result.data.chapters.length,
                document_count: 1,
                match_type: pendingConflict.matchType
            });
        } else {
            addMessage('system', `é€‰æ‹©å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        removeMessage(loadingId);
        addMessage('system', `é€‰æ‹©å‡ºé”™: ${error.message}`);
    }
    
    pendingConflict = null;
}

// æ¶ˆæ¯ç›¸å…³
let messageId = 0;

function addMessage(type, content, isHtml = false) {
    const container = document.getElementById('chatMessages');
    const id = 'msg-' + (++messageId);
    
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.id = id;
    
    const time = new Date().toLocaleTimeString('zh-CN');
    
    div.innerHTML = `
        <div class="message-content">${isHtml ? content : escapeHtml(content)}</div>
        <div class="message-time">${time}</div>
    `;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    return id;
}

function addLoadingMessage() {
    const container = document.getElementById('chatMessages');
    const id = 'msg-' + (++messageId);
    
    const div = document.createElement('div');
    div.className = 'message system';
    div.id = id;
    div.innerHTML = `
        <div class="message-content">
            <div class="loading-message">
                <div class="loading"></div>
                <span>æ­£åœ¨æŸ¥è¯¢...</span>
            </div>
        </div>
    `;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    return id;
}

function removeMessage(id) {
    const msg = document.getElementById(id);
    if (msg) msg.remove();
}

// å›¾ç‰‡é¢„è§ˆ
function showImage(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').classList.add('show');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('show');
}

// å·¥å…·å‡½æ•°
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ–‡ä»¶é€‰æ‹©
document.getElementById('txtFile').addEventListener('change', function() {
    const fileName = this.files.length > 0 ? this.files[0].name : '';
    document.getElementById('fileName').textContent = fileName;
    
    // å¼‚æ­¥æ˜¾ç¤ºæ¶ˆæ¯ï¼Œé¿å…é˜»å¡UI
    if (fileName) {
        requestAnimationFrame(() => {
            addMessage('system', `å·²é€‰æ‹©æ–‡ä»¶: <strong>${escapeHtml(fileName)}</strong><br>è¯·ç‚¹å‡»"å®Œå…¨åŒ¹é…"æˆ–"æ¨¡ç³ŠæŸ¥è¯¢"æŒ‰é’®å¼€å§‹æ‰¹é‡æŸ¥è¯¢`, true);
        });
    }
});

// å›è½¦å‘é€
document.getElementById('queryInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        doSearch('exact');
    }
});

// åˆå§‹åŒ–
loadDocuments();
loadLLMDocuments();
loadLLMConfigs();
loadSearchConfigs();
loadEmbeddingConfigs();
checkLLMConfig();

// ============== LLMåŒ¹é…åŠŸèƒ½ ==============

let llmSelectedDocuments = [];
let llmSearchResults = null;
let parsedRequirements = null;
let tempFilePath = null;

// åŠ è½½LLM Tabçš„æ–‡æ¡£åˆ—è¡¨
async function loadLLMDocuments() {
    try {
        const response = await fetch(`${API_BASE}/documents`, {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            renderLLMDocList(result.data);
        } else {
            document.getElementById('llmDocList').innerHTML = '<span style="color: #dc3545;">åŠ è½½å¤±è´¥</span>';
        }
    } catch (error) {
        console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('llmDocList').innerHTML = '<span style="color: #dc3545;">åŠ è½½å¤±è´¥</span>';
    }
}

function renderLLMDocList(documents) {
    const container = document.getElementById('llmDocList');
    
    if (!documents || documents.length === 0) {
        container.innerHTML = '<span style="color: #999;">æš‚æ— å·²å¤„ç†çš„æ–‡æ¡£</span>';
        return;
    }
    
    container.innerHTML = documents.map(doc => `
        <label class="doc-checkbox" data-doc-id="${doc.doc_id}">
            <input type="checkbox" value="${doc.doc_id}" onchange="toggleLLMDocument('${doc.doc_id}')">
            ${escapeHtml(doc.filename)}
        </label>
    `).join('');
}

function toggleLLMDocument(docId) {
    const index = llmSelectedDocuments.indexOf(docId);
    const checkbox = document.querySelector(`#llmDocList .doc-checkbox[data-doc-id="${docId}"]`);
    
    if (index === -1) {
        llmSelectedDocuments.push(docId);
        checkbox.classList.add('selected');
    } else {
        llmSelectedDocuments.splice(index, 1);
        checkbox.classList.remove('selected');
    }
}

// åŠ è½½LLMé…ç½®åˆ—è¡¨
async function loadLLMConfigs() {
    try {
        const response = await fetch(`${API_BASE}/llm-configs`, {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            const select = document.getElementById('llmConfigSelect');
            select.innerHTML = '<option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>';
            
            result.data.forEach(config => {
                const option = document.createElement('option');
                option.value = config.id;
                option.textContent = config.config_name + (config.is_default ? ' (é»˜è®¤)' : '');
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½LLMé…ç½®å¤±è´¥:', error);
    }
}

// ============== æœç´¢å¼•æ“é…ç½®åŠŸèƒ½ ==============

let searchConfigs = [];

// åŠ è½½æœç´¢å¼•æ“é…ç½®
async function loadSearchConfigs() {
    try {
        const response = await fetch('/llm/search-config', {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            searchConfigs = result.data;
            renderSearchEngineSelect();
            renderSearchConfigList();
        }
    } catch (error) {
        console.error('åŠ è½½æœç´¢é…ç½®å¤±è´¥:', error);
    }
}

// æ¸²æŸ“æœç´¢å¼•æ“é€‰æ‹©å™¨
function renderSearchEngineSelect() {
    const select = document.getElementById('searchEngineSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">æ— é…ç½®</option>';
    
    searchConfigs.forEach(config => {
        const option = document.createElement('option');
        option.value = config.id;
        option.textContent = getSearchEngineLabel(config.search_engine) + (config.is_default ? ' (é»˜è®¤)' : '');
        if (config.is_default) option.selected = true;
        select.appendChild(option);
    });
}

// è·å–æœç´¢å¼•æ“æ ‡ç­¾
function getSearchEngineLabel(engine) {
    const labels = {
        'google': 'Google',
        'bing': 'Bing',
        'baidu': 'ç™¾åº¦',
        'custom': 'è‡ªå®šä¹‰'
    };
    return labels[engine] || engine;
}

// æ¸²æŸ“æœç´¢é…ç½®åˆ—è¡¨
function renderSearchConfigList() {
    const container = document.getElementById('searchConfigList');
    if (!container) return;
    
    if (!searchConfigs || searchConfigs.length === 0) {
        container.innerHTML = '<div style="padding: 16px; color: #909399; text-align: center;">æš‚æ— æœç´¢å¼•æ“é…ç½®<br><small>é…ç½®åå¯å¯ç”¨ç½‘ç»œæœç´¢åŠŸèƒ½</small></div>';
        return;
    }
    
    container.innerHTML = searchConfigs.map(config => `
        <div class="llm-config-item ${config.is_default ? 'default' : ''}">
            <div class="llm-config-info">
                <div class="llm-config-name">${getSearchEngineLabel(config.search_engine)} ${config.is_default ? '<span style="color: #409eff;">(é»˜è®¤)</span>' : ''}</div>
                <div class="llm-config-detail">${config.api_url || 'é»˜è®¤URL'}</div>
            </div>
            <div class="llm-config-actions">
                <button class="btn btn-small" onclick="editSearchConfig(${config.id})">ç¼–è¾‘</button>
                <button class="btn btn-small btn-danger" onclick="deleteSearchConfig(${config.id})">åˆ é™¤</button>
            </div>
        </div>
    `).join('');
}

// æ‰“å¼€æœç´¢é…ç½®å¼¹çª—
function openSearchConfigModal() {
    document.getElementById('searchConfigModal').classList.add('show');
    loadSearchConfigs();
}

// å…³é—­æœç´¢é…ç½®å¼¹çª—
function closeSearchConfigModal() {
    document.getElementById('searchConfigModal').classList.remove('show');
    hideSearchConfigForm();
}

// æ˜¾ç¤ºæ·»åŠ æœç´¢é…ç½®è¡¨å•
function showAddSearchConfigForm() {
    document.getElementById('searchConfigForm').style.display = 'block';
    document.getElementById('searchConfigFormTitle').textContent = 'æ·»åŠ æœç´¢å¼•æ“';
    document.getElementById('editSearchConfigId').value = '';
    document.getElementById('searchEngineType').value = 'duckduckgo';
    document.getElementById('searchApiUrl').value = '';
    document.getElementById('searchApiKey').value = '';
    document.getElementById('searchExtraParams').value = '';
    document.getElementById('searchIsDefault').checked = true;
    onSearchEngineTypeChange();
}

// éšè—æœç´¢é…ç½®è¡¨å•
function hideSearchConfigForm() {
    document.getElementById('searchConfigForm').style.display = 'none';
}

// æœç´¢å¼•æ“ç±»å‹å˜åŒ–
function onSearchEngineTypeChange() {
    const engine = document.getElementById('searchEngineType').value;
    const urlInput = document.getElementById('searchApiUrl');
    const extraGroup = document.getElementById('searchExtraParamsGroup');
    const apiUrlGroup = document.getElementById('searchApiUrlGroup');
    const apiKeyGroup = document.getElementById('searchApiKeyGroup');
    
    const defaultUrls = {
        'google': 'https://www.googleapis.com/customsearch/v1',
        'bing': 'https://api.bing.microsoft.com/v7.0/search',
        'baidu': '',
        'duckduckgo': '',
        'custom': ''
    };
    
    if (!urlInput.value || Object.values(defaultUrls).includes(urlInput.value)) {
        urlInput.value = defaultUrls[engine] || '';
    }
    
    // DuckDuckGoä¸éœ€è¦API URLå’ŒKey
    if (engine === 'duckduckgo') {
        apiUrlGroup.style.display = 'none';
        apiKeyGroup.style.display = 'none';
        extraGroup.style.display = 'none';
    } else {
        apiUrlGroup.style.display = 'block';
        apiKeyGroup.style.display = 'block';
        
        // Googleéœ€è¦é¢å¤–çš„cxå‚æ•°
        if (engine === 'google') {
            extraGroup.style.display = 'block';
            document.getElementById('searchExtraParams').placeholder = '{"cx": "ä½ çš„æœç´¢å¼•æ“ID"}';
        } else {
            extraGroup.style.display = engine === 'custom' ? 'block' : 'none';
        }
    }
}

// ç¼–è¾‘æœç´¢é…ç½®
function editSearchConfig(configId) {
    const config = searchConfigs.find(c => c.id === configId);
    if (!config) return;
    
    document.getElementById('searchConfigForm').style.display = 'block';
    document.getElementById('searchConfigFormTitle').textContent = 'ç¼–è¾‘æœç´¢å¼•æ“';
    document.getElementById('editSearchConfigId').value = configId;
    document.getElementById('searchEngineType').value = config.search_engine;
    document.getElementById('searchApiUrl').value = config.api_url || '';
    document.getElementById('searchApiKey').value = '';  // å®‰å…¨è€ƒè™‘ä¸æ˜¾ç¤ºå¯†é’¥
    document.getElementById('searchExtraParams').value = config.extra_params ? JSON.stringify(config.extra_params, null, 2) : '';
    document.getElementById('searchIsDefault').checked = config.is_default;
    onSearchEngineTypeChange();
}

// ä¿å­˜æœç´¢é…ç½®
async function saveSearchConfig() {
    const editId = document.getElementById('editSearchConfigId').value;
    const isEdit = !!editId;
    
    const engine = document.getElementById('searchEngineType').value;
    const apiUrl = document.getElementById('searchApiUrl').value.trim();
    const apiKey = document.getElementById('searchApiKey').value.trim();
    const extraParams = document.getElementById('searchExtraParams').value.trim();
    const isDefault = document.getElementById('searchIsDefault').checked;
    
    // DuckDuckGo ä¸éœ€è¦ API Keyï¼Œå…¶ä»–å¼•æ“éœ€è¦
    if (engine !== 'duckduckgo' && !apiKey && !isEdit) {
        alert('è¯·è¾“å…¥API Key');
        return;
    }
    
    let parsedExtraParams = null;
    if (extraParams) {
        try {
            parsedExtraParams = JSON.parse(extraParams);
        } catch (e) {
            alert('é¢å¤–å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON');
            return;
        }
    }
    
    try {
        const url = isEdit ? `/llm/search-config/${editId}` : '/llm/search-config';
        const method = isEdit ? 'PUT' : 'POST';
        
        const body = {
            search_engine: engine,
            api_url: apiUrl || null,
            is_default: isDefault
        };
        
        // DuckDuckGo ä¸éœ€è¦ api_keyï¼Œå¯ä»¥ä¼ ç©ºæˆ–ä¸ä¼ 
        if (apiKey) body.api_key = apiKey;
        if (parsedExtraParams) body.extra_params = parsedExtraParams;
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(isEdit ? 'é…ç½®æ›´æ–°æˆåŠŸ' : 'é…ç½®åˆ›å»ºæˆåŠŸ');
            hideSearchConfigForm();
            loadSearchConfigs();
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('ä¿å­˜æœç´¢é…ç½®å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
    }
}

// åˆ é™¤æœç´¢é…ç½®
async function deleteSearchConfig(configId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæœç´¢å¼•æ“é…ç½®å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/llm/search-config/${configId}`, {
            method: 'DELETE'
        });
        const result = await response.json();
        
        if (result.success) {
            loadSearchConfigs();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('åˆ é™¤æœç´¢é…ç½®å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
}

// ============== Embedding é…ç½®åŠŸèƒ½ ==============

let embeddingConfigs = [];
let embeddingProviders = {};

// åŠ è½½ Embedding é…ç½®åˆ—è¡¨
async function loadEmbeddingConfigs() {
    try {
        const response = await fetch(`${API_BASE}/embedding-configs`, {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            embeddingConfigs = result.data;
            renderEmbeddingConfigSelect();
            renderEmbeddingConfigList();
        }
    } catch (error) {
        console.error('åŠ è½½Embeddingé…ç½®å¤±è´¥:', error);
    }
}

// åŠ è½½ Embedding æä¾›å•†ä¿¡æ¯
async function loadEmbeddingProviders() {
    try {
        const response = await fetch(`${API_BASE}/embedding-providers`, {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            embeddingProviders = result.data;
        }
    } catch (error) {
        console.error('åŠ è½½Embeddingæä¾›å•†å¤±è´¥:', error);
    }
}

// æ¸²æŸ“ Embedding é…ç½®é€‰æ‹©å™¨
function renderEmbeddingConfigSelect() {
    const select = document.getElementById('embeddingConfigSelect');
    select.innerHTML = '<option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>';
    
    embeddingConfigs.forEach(config => {
        const option = document.createElement('option');
        option.value = config.id;
        option.textContent = config.name + (config.is_default ? ' (é»˜è®¤)' : '');
        select.appendChild(option);
    });
}

// æ¸²æŸ“ Embedding é…ç½®åˆ—è¡¨
function renderEmbeddingConfigList() {
    const listEl = document.getElementById('embeddingConfigList');
    
    if (embeddingConfigs.length === 0) {
        listEl.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— é…ç½®ï¼Œè¯·æ·»åŠ </div>';
        return;
    }
    
    listEl.innerHTML = embeddingConfigs.map(config => `
        <div class="llm-config-item ${config.is_default ? 'default' : ''}">
            <div class="llm-config-info">
                <div class="llm-config-name">
                    ${escapeHtml(config.name)}
                    ${config.is_default ? '<span style="color: #667eea; font-size: 12px; margin-left: 8px;">é»˜è®¤</span>' : ''}
                </div>
                <div class="llm-config-detail">
                    ${escapeHtml(config.provider)} / ${escapeHtml(config.model_name)} | ç»´åº¦: ${config.dimensions}
                </div>
            </div>
            <div class="llm-config-actions">
                ${!config.is_default ? `<button onclick="setDefaultEmbeddingConfig(${config.id})">è®¾ä¸ºé»˜è®¤</button>` : ''}
                <button onclick="testEmbeddingConfigById(${config.id})">æµ‹è¯•</button>
                <button class="danger" onclick="deleteEmbeddingConfig(${config.id})">åˆ é™¤</button>
            </div>
        </div>
    `).join('');
}

// æ‰“å¼€ Embedding é…ç½®å¼¹çª—
function openEmbeddingConfigModal() {
    document.getElementById('embeddingConfigModal').classList.add('show');
    loadEmbeddingConfigs();
    loadEmbeddingProviders();
    checkEmbeddingStatus();
}

// å…³é—­ Embedding é…ç½®å¼¹çª—
function closeEmbeddingConfigModal() {
    document.getElementById('embeddingConfigModal').classList.remove('show');
    hideEmbeddingConfigForm();
}

// æ£€æŸ¥ Embedding é…ç½®çŠ¶æ€
async function checkEmbeddingStatus() {
    const statusEl = document.getElementById('embeddingStatusInfo');
    
    try {
        const response = await fetch(`${API_BASE}/embedding-config/check`, {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            if (data.has_working_provider) {
                statusEl.style.background = '#f6ffed';
                statusEl.style.borderColor = '#b7eb8f';
                statusEl.innerHTML = `âœ… å·²é…ç½®: <b>${data.config_name}</b> (${data.provider}/${data.model_name})`;
            } else if (data.has_config) {
                statusEl.style.background = '#fffbe6';
                statusEl.style.borderColor = '#ffe58f';
                statusEl.innerHTML = `âš ï¸ é…ç½®å­˜åœ¨ä½†æ— æ³•ä½¿ç”¨ï¼Œå½“å‰ä½¿ç”¨ç®€å•è¯å‘é‡æ–¹æ¡ˆï¼ˆæ•ˆæœæœ‰é™ï¼‰`;
            } else {
                statusEl.style.background = '#fff2f0';
                statusEl.style.borderColor = '#ffccc7';
                statusEl.innerHTML = `âŒ æœªé…ç½® Embedding æ¨¡å‹ï¼Œä½¿ç”¨ç®€å•è¯å‘é‡æ–¹æ¡ˆï¼ˆæ•ˆæœæœ‰é™ï¼‰<br>
                    <small>å»ºè®®é…ç½®è…¾è®¯æ··å…ƒæˆ– OpenAI ä»¥è·å¾—æ›´å¥½çš„è¯­ä¹‰æœç´¢æ•ˆæœ</small>`;
            }
        }
    } catch (error) {
        statusEl.style.background = '#fff2f0';
        statusEl.style.borderColor = '#ffccc7';
        statusEl.innerHTML = 'âŒ æ£€æŸ¥é…ç½®å¤±è´¥';
    }
}

// æ˜¾ç¤ºæ·»åŠ  Embedding é…ç½®è¡¨å•
function showAddEmbeddingConfigForm() {
    document.getElementById('embeddingConfigForm').style.display = 'block';
    document.getElementById('embeddingConfigFormTitle').textContent = 'æ·»åŠ  Embedding é…ç½®';
    document.getElementById('editEmbeddingConfigId').value = '';
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById('embeddingConfigName').value = '';
    document.getElementById('embeddingProvider').value = '';
    document.getElementById('embeddingModelName').innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©æä¾›å•† --</option>';
    document.getElementById('embeddingApiKey').value = '';
    document.getElementById('embeddingApiBase').value = '';
    document.getElementById('embeddingDimensions').value = '1024';
    document.getElementById('embeddingSecretKey').value = '';
    document.getElementById('embeddingIsDefault').checked = false;
    
    document.getElementById('embeddingTestResult').style.display = 'none';
}

// éšè— Embedding é…ç½®è¡¨å•
function hideEmbeddingConfigForm() {
    document.getElementById('embeddingConfigForm').style.display = 'none';
}

// å½“æä¾›å•†æ”¹å˜æ—¶æ›´æ–°æ¨¡å‹åˆ—è¡¨
function onEmbeddingProviderChange() {
    const provider = document.getElementById('embeddingProvider').value;
    const modelSelect = document.getElementById('embeddingModelName');
    const apiKeyGroup = document.getElementById('embeddingApiKeyGroup');
    const apiBaseGroup = document.getElementById('embeddingApiBaseGroup');
    const secretKeyGroup = document.getElementById('embeddingSecretKeyGroup');
    const dimensionsInput = document.getElementById('embeddingDimensions');
    
    // é‡ç½®æ¨¡å‹é€‰æ‹©
    modelSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ¨¡å‹ --</option>';
    
    if (!provider || !embeddingProviders[provider]) {
        return;
    }
    
    const providerInfo = embeddingProviders[provider];
    
    // å¡«å……æ¨¡å‹é€‰é¡¹
    providerInfo.models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.name;
        option.textContent = model.name;
        option.dataset.dimensions = model.dimensions;
        modelSelect.appendChild(option);
    });
    
    // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹
    if (providerInfo.models.length > 0) {
        modelSelect.value = providerInfo.models[0].name;
        dimensionsInput.value = providerInfo.models[0].dimensions;
    }
    
    // æ ¹æ®æä¾›å•†è°ƒæ•´è¡¨å•
    if (provider === 'hunyuan') {
        apiKeyGroup.style.display = 'block';
        apiBaseGroup.style.display = 'none';
        secretKeyGroup.style.display = 'block';
        document.querySelector('#embeddingApiKeyGroup label').textContent = 'Secret IDï¼ˆè…¾è®¯äº‘ï¼‰';
    } else if (provider === 'openai') {
        apiKeyGroup.style.display = 'block';
        apiBaseGroup.style.display = 'block';
        secretKeyGroup.style.display = 'none';
        document.querySelector('#embeddingApiKeyGroup label').textContent = 'API Key';
    } else if (provider === 'huggingface') {
        apiKeyGroup.style.display = 'none';
        apiBaseGroup.style.display = 'none';
        secretKeyGroup.style.display = 'none';
    }
    
    // æ¨¡å‹é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°ç»´åº¦
    modelSelect.onchange = function() {
        const selectedOption = modelSelect.options[modelSelect.selectedIndex];
        if (selectedOption && selectedOption.dataset.dimensions) {
            dimensionsInput.value = selectedOption.dataset.dimensions;
        }
    };
}

// æµ‹è¯• Embedding é…ç½®
async function testEmbeddingConfig() {
    const testResultEl = document.getElementById('embeddingTestResult');
    testResultEl.style.display = 'block';
    testResultEl.style.background = '#e6f7ff';
    testResultEl.style.borderColor = '#91d5ff';
    testResultEl.textContent = 'æµ‹è¯•ä¸­...';
    
    const provider = document.getElementById('embeddingProvider').value;
    const modelName = document.getElementById('embeddingModelName').value;
    const apiKey = document.getElementById('embeddingApiKey').value;
    const apiBase = document.getElementById('embeddingApiBase').value;
    const dimensions = parseInt(document.getElementById('embeddingDimensions').value);
    const secretKey = document.getElementById('embeddingSecretKey').value;
    
    if (!provider || !modelName) {
        testResultEl.style.background = '#fff2f0';
        testResultEl.style.borderColor = '#ffccc7';
        testResultEl.textContent = 'è¯·å…ˆé€‰æ‹©æä¾›å•†å’Œæ¨¡å‹';
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/embedding-config/test`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                provider: provider,
                model_name: modelName,
                api_key: apiKey,
                api_base: apiBase || null,
                dimensions: dimensions,
                extra_config: provider === 'hunyuan' ? {secret_key: secretKey, region: 'ap-guangzhou'} : null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            testResultEl.style.background = '#f6ffed';
            testResultEl.style.borderColor = '#b7eb8f';
            testResultEl.innerHTML = `âœ… ${result.message}<br>å‘é‡ç»´åº¦: ${result.dimensions}`;
        } else {
            testResultEl.style.background = '#fff2f0';
            testResultEl.style.borderColor = '#ffccc7';
            testResultEl.textContent = 'âŒ ' + result.message;
        }
    } catch (error) {
        testResultEl.style.background = '#fff2f0';
        testResultEl.style.borderColor = '#ffccc7';
        testResultEl.textContent = 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message;
    }
}

// æ ¹æ®IDæµ‹è¯•å·²ä¿å­˜çš„é…ç½®
async function testEmbeddingConfigById(configId) {
    try {
        const response = await fetch(`${API_BASE}/embedding-config/test`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({ config_id: configId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`âœ… æµ‹è¯•æˆåŠŸï¼\n${result.message}\nå‘é‡ç»´åº¦: ${result.dimensions}`);
        } else {
            alert('âŒ æµ‹è¯•å¤±è´¥: ' + result.message);
        }
    } catch (error) {
        alert('âŒ æµ‹è¯•å¤±è´¥: ' + error.message);
    }
}

// ä¿å­˜ Embedding é…ç½®
async function saveEmbeddingConfig() {
    const configId = document.getElementById('editEmbeddingConfigId').value;
    const isEdit = !!configId;
    
    const name = document.getElementById('embeddingConfigName').value.trim();
    const provider = document.getElementById('embeddingProvider').value;
    const modelName = document.getElementById('embeddingModelName').value;
    const apiKey = document.getElementById('embeddingApiKey').value.trim();
    const apiBase = document.getElementById('embeddingApiBase').value.trim();
    const dimensions = parseInt(document.getElementById('embeddingDimensions').value);
    const secretKey = document.getElementById('embeddingSecretKey').value.trim();
    const isDefault = document.getElementById('embeddingIsDefault').checked;
    
    if (!name) {
        alert('è¯·è¾“å…¥é…ç½®åç§°');
        return;
    }
    if (!provider) {
        alert('è¯·é€‰æ‹©æä¾›å•†');
        return;
    }
    if (!modelName) {
        alert('è¯·é€‰æ‹©æ¨¡å‹');
        return;
    }
    
    // æ„å»ºé¢å¤–é…ç½®
    let extraConfig = null;
    if (provider === 'hunyuan' && secretKey) {
        extraConfig = { secret_key: secretKey, region: 'ap-guangzhou' };
    }
    
    const data = {
        name: name,
        provider: provider,
        model_name: modelName,
        api_key: apiKey || null,
        api_base: apiBase || null,
        dimensions: dimensions,
        is_default: isDefault,
        extra_config: extraConfig
    };
    
    try {
        const url = isEdit ? `${API_BASE}/embedding-config/${configId}` : `${API_BASE}/embedding-config`;
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(isEdit ? 'é…ç½®æ›´æ–°æˆåŠŸ' : 'é…ç½®åˆ›å»ºæˆåŠŸ');
            hideEmbeddingConfigForm();
            loadEmbeddingConfigs();
            checkEmbeddingStatus();
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('ä¿å­˜Embeddingé…ç½®å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
    }
}

// è®¾ç½®é»˜è®¤ Embedding é…ç½®
async function setDefaultEmbeddingConfig(configId) {
    try {
        const response = await fetch(`${API_BASE}/embedding-config/${configId}/set-default`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadEmbeddingConfigs();
            checkEmbeddingStatus();
        } else {
            alert('è®¾ç½®å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        alert('è®¾ç½®å¤±è´¥: ' + error.message);
    }
}

// åˆ é™¤ Embedding é…ç½®
async function deleteEmbeddingConfig(configId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`${API_BASE}/embedding-config/${configId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadEmbeddingConfigs();
            checkEmbeddingStatus();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
}

// æ£€æŸ¥LLMé…ç½®çŠ¶æ€
async function checkLLMConfig() {
    const statusEl = document.getElementById('llmStatus');
    const statusText = statusEl.querySelector('.status-text');
    
    try {
        const response = await fetch(`${API_BASE}/llm-config/check`, {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success && result.data.has_config) {
            statusEl.classList.add('ready');
            statusEl.classList.remove('error');
            statusText.textContent = `å·²é…ç½®: ${result.data.model_type}/${result.data.model_name}`;
        } else {
            statusEl.classList.add('error');
            statusEl.classList.remove('ready');
            statusText.textContent = 'æœªé…ç½®LLMï¼Œè¯·å…ˆé…ç½®';
        }
    } catch (error) {
        statusEl.classList.add('error');
        statusEl.classList.remove('ready');
        statusText.textContent = 'é…ç½®æ£€æŸ¥å¤±è´¥';
    }
}

// LLMå•æ¡æŸ¥è¯¢
async function doLLMSearch() {
    const input = document.getElementById('llmQueryInput');
    const query = input.value.trim();
    const reqFile = document.getElementById('reqFile');
    
    // å¦‚æœæœ‰ä¸Šä¼ æ–‡ä»¶ï¼Œå…ˆè§£ææ–‡ä»¶
    if (reqFile.files.length > 0) {
        await analyzeUploadedFile();
        return;
    }
    
    if (!query) {
        alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ‹›æ ‡ä½œç­”æŒ‡ä»¤ï¼ˆåŒ…å«ç« èŠ‚ç¼–å·å¦‚ 1.4.1, 1.4.2ï¼‰
    const sectionPattern = /(\d+(?:\.\d+)+)/g;
    const sectionMatches = query.match(sectionPattern);
    const isBidInstruction = sectionMatches && sectionMatches.length > 0 && 
        (query.includes('ä½œç­”') || query.includes('å›ç­”') || query.includes('é’ˆå¯¹') || query.includes('ç« èŠ‚'));
    
    if (isBidInstruction) {
        // æ‹›æ ‡ä½œç­”æ¨¡å¼
        await processBidInstruction(query);
        return;
    }
    
    // æ™®é€šæŸ¥è¯¢æ¨¡å¼
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addLLMMessage('user', query);
    input.value = '';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const loadingId = addLLMLoadingMessage();
    
    try {
        const llmConfigId = document.getElementById('llmConfigSelect').value;
        const enableWebSearch = document.getElementById('enableWebSearchLLM').checked;
        
        const response = await fetch(`${API_BASE}/llm-search`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                query: query,
                document_ids: llmSelectedDocuments,
                enable_web_search: enableWebSearch,
                llm_config_id: llmConfigId || null
            })
        });
        
        const result = await response.json();
        removeLLMMessage(loadingId);
        
        if (result.success) {
            llmSearchResults = [result.data];
            displayLLMResult(result.data);
            document.getElementById('btnExportLLM').disabled = false;
        } else {
            addLLMMessage('system', `æŸ¥è¯¢å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        removeLLMMessage(loadingId);
        addLLMMessage('system', `æŸ¥è¯¢å‡ºé”™: ${error.message}`);
    }
}

// æ˜¾ç¤ºLLMå•æ¡ç»“æœ
function displayLLMResult(data) {
    const matchTypeLabels = {
        'exact': 'ç²¾ç¡®åŒ¹é…',
        'semantic': 'è¯­ä¹‰åŒ¹é…',
        'web': 'ç½‘ç»œæœç´¢',
        'llm_generated': 'LLMç”Ÿæˆ',
        'none': 'æœªåŒ¹é…',
        'error': 'åˆ†æå¤±è´¥'
    };
    
    const matchType = data.match_type || 'none';
    const confidence = data.confidence || 0;
    const source = data.source || {};
    const images = source.images || [];
    const answerHtml = renderContentWithImages(data.answer || 'æ— ç­”æ¡ˆ', images);
    
    let sourceInfo = '';
    if (source.type === 'document') {
        const pathStr = (source.path || []).map(p => p.title).join(' â†’ ');
        sourceInfo = `
            <div class="llm-source-info">
                ğŸ“„ æ¥æºï¼š${escapeHtml(source.filename || 'æœªçŸ¥æ–‡æ¡£')}
                ${pathStr ? `<br>ğŸ“ è·¯å¾„ï¼š${escapeHtml(pathStr)}` : ''}
            </div>
        `;
    } else if (source.type === 'web') {
        const webLinks = (source.search_results || []).slice(0, 3).map(r => 
            `<a href="${escapeHtml(r.url)}" target="_blank">${escapeHtml(r.title)}</a>`
        ).join(' | ');
        sourceInfo = `
            <div class="llm-source-info">
                ğŸŒ ç½‘ç»œæœç´¢ç»“æœï¼š${webLinks}
            </div>
        `;
    }
    
    const html = `
        <div class="llm-result">
            <div class="llm-result-header">
                <span>æ™ºèƒ½åŒ¹é…ç»“æœ</span>
                <span class="match-type-badge ${matchType}">${matchTypeLabels[matchType]}</span>
            </div>
            <div class="llm-result-body">
                ${sourceInfo}
                <div class="llm-answer">${answerHtml}</div>
                <div class="confidence-bar">
                    <span>ç½®ä¿¡åº¦ï¼š</span>
                    <div class="bar">
                        <div class="bar-fill" style="width: ${confidence * 100}%"></div>
                    </div>
                    <span>${(confidence * 100).toFixed(0)}%</span>
                </div>
            </div>
        </div>
    `;
    
    addLLMMessage('system', html, true);
}

// åˆ†æä¸Šä¼ çš„éœ€æ±‚æ–‡ä»¶
async function analyzeUploadedFile() {
    const reqFile = document.getElementById('reqFile');
    const queryInput = document.getElementById('llmQueryInput');
    const queryText = queryInput ? queryInput.value.trim() : '';
    
    if (reqFile.files.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©éœ€æ±‚æ–‡æ¡£');
        return;
    }
    
    const file = reqFile.files[0];
    
    // ä»æŸ¥è¯¢è¾“å…¥ä¸­æå–ç« èŠ‚è¿‡æ»¤ï¼ˆå¦‚æœæœ‰ï¼‰
    let sectionFilter = '';
    const sectionPattern = /(\d+(?:\.\d+)+)/g;
    const matches = queryText.match(sectionPattern);
    if (matches && matches.length > 0) {
        sectionFilter = matches.join(',');
        addLLMMessage('user', `åˆ†æéœ€æ±‚æ–‡æ¡£: ${file.name} (è¿‡æ»¤ç« èŠ‚: ${sectionFilter})`);
    } else {
        addLLMMessage('user', `åˆ†æéœ€æ±‚æ–‡æ¡£: ${file.name}`);
    }
    
    const loadingId = addLLMLoadingMessage('æ­£åœ¨è§£ææ–‡æ¡£...');
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        llmSelectedDocuments.forEach(id => {
            formData.append('document_ids[]', id);
        });
        
        const llmConfigId = document.getElementById('llmConfigSelect').value;
        if (llmConfigId) {
            formData.append('llm_config_id', llmConfigId);
        }
        
        const enableWebSearch = document.getElementById('enableWebSearchLLM').checked;
        formData.append('enable_web_search', enableWebSearch);
        
        // æ·»åŠ ç« èŠ‚è¿‡æ»¤å‚æ•°
        if (sectionFilter) {
            formData.append('section_filter', sectionFilter);
        }
        
        const response = await fetch(`${API_BASE}/analyze-file`, {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });
        
        const result = await response.json();
        removeLLMMessage(loadingId);
        
        if (result.success) {
            parsedRequirements = result.data.requirements;
            tempFilePath = result.data.temp_file;
            
            // æ˜¾ç¤ºè§£æç»“æœï¼Œè®©ç”¨æˆ·ç¡®è®¤
            displayParsedRequirements(result.data);
        } else {
            addLLMMessage('system', `æ–‡æ¡£è§£æå¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        removeLLMMessage(loadingId);
        addLLMMessage('system', `è§£æå‡ºé”™: ${error.message}`);
    }
    
    // æ¸…é™¤æ–‡ä»¶
    reqFile.value = '';
    document.getElementById('reqFileName').textContent = '';
}

// æ˜¾ç¤ºè§£æå‡ºçš„éœ€æ±‚åˆ—è¡¨
function displayParsedRequirements(data) {
    // æŒ‰ç« èŠ‚åˆ†ç»„
    const sectionGroups = {};
    data.requirements.forEach((req, i) => {
        const sectionNum = req.section?.number || 'æœªåˆ†ç±»';
        const sectionTitle = req.section?.title || '';
        const key = sectionNum;
        if (!sectionGroups[key]) {
            sectionGroups[key] = {
                number: sectionNum,
                title: sectionTitle,
                requirements: []
            };
        }
        sectionGroups[key].requirements.push({...req, globalIndex: i + 1});
    });
    
    // ç”Ÿæˆåˆ†ç»„æ˜¾ç¤º
    let reqListHtml = '';
    for (const [key, group] of Object.entries(sectionGroups)) {
        reqListHtml += `
            <div style="margin-bottom: 15px;">
                <div style="background: #e9ecef; padding: 8px 12px; border-radius: 5px; font-weight: bold; margin-bottom: 8px;">
                    ğŸ“‘ ${escapeHtml(group.number)} ${escapeHtml(group.title)} 
                    <span style="color: #666; font-weight: normal;">(${group.requirements.length} æ¡)</span>
                </div>
                ${group.requirements.map(req => `
                    <div style="padding: 6px 12px; border-bottom: 1px solid #eee; margin-left: 10px;">
                        <strong>${req.globalIndex}.</strong> ${escapeHtml(req.title || req.content?.substring(0, 100) || '')}
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    const html = `
        <div class="parsed-requirements">
            <h4 style="margin-bottom: 10px;">ä»æ–‡æ¡£ "${escapeHtml(data.filename)}" è§£æå‡º ${data.count} æ¡éœ€æ±‚ï¼š</h4>
            <div style="max-height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f8f9fa;">
                ${reqListHtml}
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="startBatchAnalysis()">å¼€å§‹åˆ†æ</button>
                <button class="btn btn-secondary" onclick="cancelBatchAnalysis()">å–æ¶ˆ</button>
            </div>
        </div>
    `;
    
    addLLMMessage('system', html, true);
}

// å¼€å§‹æ‰¹é‡åˆ†æ
async function startBatchAnalysis() {
    if (!parsedRequirements || parsedRequirements.length === 0) {
        alert('æ²¡æœ‰å¾…åˆ†æçš„éœ€æ±‚');
        return;
    }
    
    const loadingId = addLLMLoadingMessage(`æ­£åœ¨åˆ†æ ${parsedRequirements.length} æ¡éœ€æ±‚ï¼Œè¯·ç¨å€™...`);
    
    try {
        const llmConfigId = document.getElementById('llmConfigSelect').value;
        const enableWebSearch = document.getElementById('enableWebSearchLLM').checked;
        
        const response = await fetch(`${API_BASE}/analyze-requirements`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                requirements: parsedRequirements,
                document_ids: llmSelectedDocuments,
                enable_web_search: enableWebSearch,
                llm_config_id: llmConfigId || null,
                temp_file: tempFilePath
            })
        });
        
        const result = await response.json();
        removeLLMMessage(loadingId);
        
        if (result.success) {
            llmSearchResults = result.data.results;
            displayBatchAnalysisResults(result.data);
            document.getElementById('btnExportLLM').disabled = false;
        } else {
            addLLMMessage('system', `æ‰¹é‡åˆ†æå¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        removeLLMMessage(loadingId);
        addLLMMessage('system', `åˆ†æå‡ºé”™: ${error.message}`);
    }
    
    // æ¸…ç†
    parsedRequirements = null;
    tempFilePath = null;
}

// å–æ¶ˆæ‰¹é‡åˆ†æ
function cancelBatchAnalysis() {
    parsedRequirements = null;
    tempFilePath = null;
    addLLMMessage('system', 'å·²å–æ¶ˆæ‰¹é‡åˆ†æ');
}

// æ˜¾ç¤ºæ‰¹é‡åˆ†æç»“æœ
function displayBatchAnalysisResults(data) {
    const matchTypeLabels = {
        'exact': 'ç²¾ç¡®åŒ¹é…',
        'semantic': 'è¯­ä¹‰åŒ¹é…',
        'web': 'ç½‘ç»œæœç´¢',
        'llm_generated': 'LLMç”Ÿæˆ',
        'none': 'æœªåŒ¹é…',
        'error': 'åˆ†æå¤±è´¥'
    };
    
    const summary = data.summary;
    
    let html = `
        <div class="batch-results">
            <div class="batch-summary">
                <div class="stat-item">
                    <span>æ€»è®¡ï¼š</span>
                    <span class="stat-count">${data.total}</span>
                </div>
                <div class="stat-item">
                    <span>ç²¾ç¡®åŒ¹é…ï¼š</span>
                    <span class="stat-count" style="color: #28a745;">${summary.exact}</span>
                </div>
                <div class="stat-item">
                    <span>è¯­ä¹‰åŒ¹é…ï¼š</span>
                    <span class="stat-count" style="color: #17a2b8;">${summary.semantic}</span>
                </div>
                <div class="stat-item">
                    <span>ç½‘ç»œæœç´¢ï¼š</span>
                    <span class="stat-count" style="color: #fd7e14;">${summary.web}</span>
                </div>
                <div class="stat-item">
                    <span>LLMç”Ÿæˆï¼š</span>
                    <span class="stat-count" style="color: #6f42c1;">${summary.llm_generated}</span>
                </div>
                <div class="stat-item">
                    <span>æœªåŒ¹é…ï¼š</span>
                    <span class="stat-count" style="color: #dc3545;">${summary.none}</span>
                </div>
            </div>
    `;
    
    data.results.forEach((result, i) => {
        const matchType = result.match_type || 'none';
        const confidence = result.confidence || 0;
        const source = result.source || {};
        const images = source.images || [];
        const answerHtml = renderContentWithImages(result.answer || 'æ— ç­”æ¡ˆ', images);
        
        let sourceText = '';
        if (source.type === 'document') {
            sourceText = `ğŸ“„ ${source.filename || 'æ–‡æ¡£'}`;
        } else if (source.type === 'web') {
            sourceText = 'ğŸŒ ç½‘ç»œæœç´¢';
        } else if (source.type === 'llm') {
            sourceText = 'ğŸ¤– LLMç”Ÿæˆ';
        }
        
        html += `
            <div class="requirement-item" data-index="${i}">
                <div class="requirement-header" onclick="toggleRequirementBody(${i})">
                    <div style="display: flex; align-items: center;">
                        <span class="requirement-index">${result.index || i + 1}</span>
                        <span class="requirement-title">${escapeHtml(result.requirement_title || result.requirement?.substring(0, 50) || 'éœ€æ±‚')}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${sourceText ? `<span style="font-size: 12px; color: #666;">${sourceText}</span>` : ''}
                        <span class="match-type-badge ${matchType}">${matchTypeLabels[matchType]}</span>
                    </div>
                </div>
                <div class="requirement-body" id="reqBody_${i}">
                    <div class="req-section">
                        <div class="req-section-title">éœ€æ±‚å†…å®¹</div>
                        <div class="req-section-content">${escapeHtml(result.requirement || '')}</div>
                    </div>
                    <div class="req-section">
                        <div class="req-section-title">ç­”æ¡ˆ (ç½®ä¿¡åº¦: ${(confidence * 100).toFixed(0)}%)</div>
                        <div class="req-section-content">${answerHtml}</div>
                    </div>
                    ${source.type === 'document' && source.path ? `
                        <div class="req-section">
                            <div class="req-section-title">æ¥æºè·¯å¾„</div>
                            <div class="req-section-content">${escapeHtml((source.path || []).map(p => p.title).join(' â†’ '))}</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    addLLMMessage('system', html, true);
    addLLMMessage('system', `âœ… æ‰¹é‡åˆ†æå®Œæˆï¼å…± ${data.total} æ¡éœ€æ±‚ã€‚æ‚¨å¯ä»¥ç‚¹å‡» <strong>"å¯¼å‡ºWord"</strong> æŒ‰é’®å°†ç»“æœå¯¼å‡ºä¸ºæ–‡æ¡£ã€‚`, true);
}

// åˆ‡æ¢éœ€æ±‚è¯¦æƒ…æ˜¾ç¤º
function toggleRequirementBody(index) {
    const body = document.getElementById(`reqBody_${index}`);
    if (body) {
        body.classList.toggle('show');
    }
}

// å¯¼å‡ºLLMåˆ†æç»“æœ
async function exportLLMResults() {
    if (!llmSearchResults || llmSearchResults.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
        return;
    }
    
    const btn = document.getElementById('btnExportLLM');
    btn.disabled = true;
    btn.textContent = 'å¯¼å‡ºä¸­...';
    
    try {
        const response = await fetch(`${API_BASE}/export-llm-results`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                results: llmSearchResults,
                title: 'éœ€æ±‚åˆ†ææŠ¥å‘Š'
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `éœ€æ±‚åˆ†ææŠ¥å‘Š_${new Date().toISOString().slice(0,10)}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            addLLMMessage('system', 'Wordæ–‡æ¡£å·²ä¸‹è½½');
        } else {
            const result = await response.json();
            addLLMMessage('system', `å¯¼å‡ºå¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        addLLMMessage('system', `å¯¼å‡ºå‡ºé”™: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'å¯¼å‡ºWord';
    }
}

// LLMæ¶ˆæ¯ç›¸å…³å‡½æ•°
let llmMessageId = 0;

function addLLMMessage(type, content, isHtml = false) {
    const container = document.getElementById('llmChatMessages');
    const id = 'llm-msg-' + (++llmMessageId);
    
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.id = id;
    
    const time = new Date().toLocaleTimeString('zh-CN');
    
    div.innerHTML = `
        <div class="message-content">${isHtml ? content : escapeHtml(content)}</div>
        <div class="message-time">${time}</div>
    `;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    return id;
}

function addLLMLoadingMessage(text = 'æ­£åœ¨å¤„ç†...') {
    const container = document.getElementById('llmChatMessages');
    const id = 'llm-msg-' + (++llmMessageId);
    
    const div = document.createElement('div');
    div.className = 'message system';
    div.id = id;
    div.innerHTML = `
        <div class="message-content">
            <div class="loading-message">
                <div class="loading"></div>
                <span>${escapeHtml(text)}</span>
            </div>
        </div>
    `;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    
    return id;
}

function removeLLMMessage(id) {
    const msg = document.getElementById(id);
    if (msg) msg.remove();
}

// ============== æ‹›æ ‡ä½œç­”åŠŸèƒ½ ==============

// å­˜å‚¨å½“å‰æ‹›æ ‡ä½œç­”çš„æ•°æ®
let currentBidData = {
    docId: null,
    sectionNumbers: [],
    sections: {},
    results: []
};

// å¤„ç†æ‹›æ ‡ä½œç­”æŒ‡ä»¤
async function processBidInstruction(instruction) {
    const input = document.getElementById('llmQueryInput');
    input.value = '';
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addLLMMessage('user', instruction);
    
    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ–‡æ¡£
    if (!llmSelectedDocuments || llmSelectedDocuments.length === 0) {
        addLLMMessage('system', 'âš ï¸ è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©è¦ä½œç­”çš„æ‹›æ ‡æ–‡æ¡£', true);
        return;
    }
    
    // ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰ä¸­çš„æ–‡æ¡£ä½œä¸ºæ‹›æ ‡æ–‡æ¡£
    const bidDocId = llmSelectedDocuments[0];
    
    // Step 1: è§£ææŒ‡ä»¤
    const loadingId = addLLMLoadingMessage('æ­£åœ¨è§£ææŒ‡ä»¤...');
    
    try {
        const parseResponse = await fetch(`${API_BASE}/parse-bid-instruction`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                instruction: instruction,
                doc_id: bidDocId
            })
        });
        
        const parseResult = await parseResponse.json();
        removeLLMMessage(loadingId);
        
        if (!parseResult.success) {
            addLLMMessage('system', `âŒ ${parseResult.error}`, true);
            return;
        }
        
        const sectionNumbers = parseResult.data.section_numbers;
        if (sectionNumbers.length === 0) {
            addLLMMessage('system', 'âŒ æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„ç« èŠ‚ç¼–å·ï¼Œè¯·ä½¿ç”¨æ ¼å¼å¦‚ï¼š1.4.1, 1.4.2', true);
            return;
        }
        
        // æ˜¾ç¤ºè§£æç»“æœ
        addLLMMessage('system', `âœ… å·²è¯†åˆ«ç« èŠ‚ç¼–å·ï¼š<strong>${sectionNumbers.join(', ')}</strong><br>æ­£åœ¨è·å–ç« èŠ‚å†…å®¹...`, true);
        
        // Step 2: è·å–ç« èŠ‚çš„æŠ€æœ¯è¦æ±‚
        const reqLoadingId = addLLMLoadingMessage('æ­£åœ¨è·å–æŠ€æœ¯è¦æ±‚...');
        
        const reqResponse = await fetch(`${API_BASE}/get-section-requirements`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                doc_id: bidDocId,
                section_numbers: sectionNumbers
            })
        });
        
        const reqResult = await reqResponse.json();
        removeLLMMessage(reqLoadingId);
        
        if (!reqResult.success) {
            addLLMMessage('system', `âŒ è·å–ç« èŠ‚å†…å®¹å¤±è´¥: ${reqResult.error}`, true);
            return;
        }
        
        const sectionsData = reqResult.data.sections;
        const totalReq = reqResult.data.total_requirements;
        
        if (totalReq === 0) {
            addLLMMessage('system', 'âš ï¸ æœªåœ¨æŒ‡å®šç« èŠ‚ä¸­æ‰¾åˆ°æŠ€æœ¯è¦æ±‚æ¡ç›®', true);
            return;
        }
        
        // æ˜¾ç¤ºæ‰¾åˆ°çš„æŠ€æœ¯è¦æ±‚
        displayBidSectionPreview(sectionsData, reqResult.data);
        
        // ä¿å­˜æ•°æ®ä¾›åç»­ä½¿ç”¨
        currentBidData = {
            docId: bidDocId,
            sectionNumbers: sectionNumbers,
            sections: sectionsData,
            results: []
        };
        
    } catch (error) {
        removeLLMMessage(loadingId);
        addLLMMessage('system', `âŒ å¤„ç†å¤±è´¥: ${error.message}`, true);
    }
}

// æ˜¾ç¤ºæ‹›æ ‡ç« èŠ‚é¢„è§ˆ
function displayBidSectionPreview(sectionsData, reqData) {
    let html = `
        <div class="bid-preview">
            <div class="bid-preview-header">
                <h4>ğŸ“‹ æŠ€æœ¯è¦æ±‚é¢„è§ˆ</h4>
                <span>å…± ${reqData.total_requirements} æ¡æŠ€æœ¯è¦æ±‚</span>
            </div>
    `;
    
    for (const [sectionNum, section] of Object.entries(sectionsData)) {
        const reqCount = section.requirements ? section.requirements.length : 0;
        html += `
            <div class="bid-section-item">
                <div class="bid-section-header">
                    <span class="section-number">${sectionNum}</span>
                    <span class="section-title">${escapeHtml(section.title || '')}</span>
                    <span class="section-count">${reqCount} æ¡</span>
                </div>
        `;
        
        if (section.requirements && section.requirements.length > 0) {
            html += '<div class="bid-requirements-list">';
            section.requirements.slice(0, 5).forEach((req, idx) => {
                const reqText = req.text || req.content || '';
                html += `
                    <div class="bid-req-item">
                        <span class="req-idx">${req.index || idx + 1}</span>
                        <span class="req-text">${escapeHtml(reqText.substring(0, 100))}${reqText.length > 100 ? '...' : ''}</span>
                    </div>
                `;
            });
            if (section.requirements.length > 5) {
                html += `<div class="bid-req-more">... è¿˜æœ‰ ${section.requirements.length - 5} æ¡</div>`;
            }
            html += '</div>';
        }
        
        html += '</div>';
    }
    
    if (reqData.missing_sections && reqData.missing_sections.length > 0) {
        html += `<div class="bid-warning">âš ï¸ æœªæ‰¾åˆ°ç« èŠ‚: ${reqData.missing_sections.join(', ')}</div>`;
    }
    
    html += `
            <div class="bid-actions">
                <button class="btn btn-primary" onclick="startBidAnswering()">ğŸš€ å¼€å§‹æ™ºèƒ½ä½œç­”</button>
                <button class="btn btn-secondary" onclick="cancelBidAnswering()">å–æ¶ˆ</button>
            </div>
        </div>
    `;
    
    addLLMMessage('system', html, true);
}

// å¼€å§‹æ‹›æ ‡ä½œç­”
async function startBidAnswering() {
    if (!currentBidData.docId || currentBidData.sectionNumbers.length === 0) {
        addLLMMessage('system', 'âŒ æ²¡æœ‰å¾…ä½œç­”çš„æ•°æ®', true);
        return;
    }
    
    const llmConfigId = document.getElementById('llmConfigSelect').value;
    const enableWebSearch = document.getElementById('enableWebSearchLLM').checked;
    
    // è·å–çŸ¥è¯†åº“æ–‡æ¡£ï¼ˆé™¤äº†æ‹›æ ‡æ–‡æ¡£æœ¬èº«ä¹‹å¤–çš„å…¶ä»–é€‰ä¸­æ–‡æ¡£ï¼‰
    const knowledgeDocIds = llmSelectedDocuments.filter(id => id !== currentBidData.docId);
    
    addLLMMessage('system', 'ğŸ”„ å¼€å§‹æ™ºèƒ½ä½œç­”ï¼Œè¯·ç¨å€™...<br>åŒ¹é…ä¼˜å…ˆçº§ï¼šç²¾ç¡®åŒ¹é… â†’ è¯­ä¹‰åŒ¹é… â†’ ç½‘ç»œæœç´¢ â†’ LLMç”Ÿæˆ', true);
    
    const loadingId = addLLMLoadingMessage('æ­£åœ¨è¿›è¡Œæ™ºèƒ½åŒ¹é…å’Œä½œç­”...');
    
    try {
        const response = await fetch(`${API_BASE}/answer-bid-requirements`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                doc_id: currentBidData.docId,
                section_numbers: currentBidData.sectionNumbers,
                knowledge_doc_ids: knowledgeDocIds,
                llm_config_id: llmConfigId || null,
                enable_web_search: enableWebSearch
            })
        });
        
        const result = await response.json();
        removeLLMMessage(loadingId);
        
        if (result.success) {
            currentBidData.results = result.data.results;
            llmSearchResults = result.data.results;
            displayBidAnswerResults(result.data);
            document.getElementById('btnExportLLM').disabled = false;
        } else {
            addLLMMessage('system', `âŒ ä½œç­”å¤±è´¥: ${result.error}`, true);
        }
    } catch (error) {
        removeLLMMessage(loadingId);
        addLLMMessage('system', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, true);
    }
}

// æ˜¾ç¤ºæ‹›æ ‡ä½œç­”ç»“æœ
function displayBidAnswerResults(data) {
    const matchTypeLabels = {
        'exact': 'ç²¾ç¡®åŒ¹é…',
        'semantic': 'è¯­ä¹‰åŒ¹é…',
        'web': 'ç½‘ç»œæœç´¢',
        'llm_generated': 'LLMç”Ÿæˆ',
        'none': 'æœªåŒ¹é…',
        'error': 'åˆ†æå¤±è´¥'
    };
    
    const matchTypeColors = {
        'exact': '#28a745',
        'semantic': '#17a2b8',
        'web': '#fd7e14',
        'llm_generated': '#6f42c1',
        'none': '#dc3545',
        'error': '#dc3545'
    };
    
    const summary = data.summary;
    
    let html = `
        <div class="bid-results">
            <div class="bid-results-header">
                <h4>ğŸ“Š æ‹›æ ‡ä½œç­”ç»“æœ</h4>
                <div class="doc-info">ğŸ“„ ${escapeHtml(data.doc_info?.filename || '')}</div>
            </div>
            <div class="bid-summary">
                <div class="summary-item"><span>æ€»è®¡</span><strong>${summary.total}</strong></div>
                <div class="summary-item" style="color:${matchTypeColors.exact}"><span>ç²¾ç¡®åŒ¹é…</span><strong>${summary.exact}</strong></div>
                <div class="summary-item" style="color:${matchTypeColors.semantic}"><span>è¯­ä¹‰åŒ¹é…</span><strong>${summary.semantic}</strong></div>
                <div class="summary-item" style="color:${matchTypeColors.web}"><span>ç½‘ç»œæœç´¢</span><strong>${summary.web}</strong></div>
                <div class="summary-item" style="color:${matchTypeColors.llm_generated}"><span>LLMç”Ÿæˆ</span><strong>${summary.llm_generated}</strong></div>
                <div class="summary-item" style="color:${matchTypeColors.none}"><span>æœªåŒ¹é…</span><strong>${summary.none}</strong></div>
            </div>
            <div class="bid-export-actions">
                <button class="btn btn-primary btn-sm" onclick="exportBidAnswers('default')">ğŸ“¥ å¯¼å‡ºWordæ–‡æ¡£</button>
                <button class="btn btn-outline btn-sm" onclick="exportBidAnswers('table')">ğŸ“‹ å¯¼å‡ºè¡¨æ ¼æ ¼å¼</button>
            </div>
    `;
    
    // æŒ‰ç« èŠ‚åˆ†ç»„æ˜¾ç¤º
    const groupedResults = {};
    data.results.forEach(r => {
        const key = r.section_number;
        if (!groupedResults[key]) {
            groupedResults[key] = {
                title: r.section_title,
                items: []
            };
        }
        groupedResults[key].items.push(r);
    });
    
    for (const [sectionNum, group] of Object.entries(groupedResults)) {
        html += `
            <div class="bid-section-result">
                <div class="section-result-header" onclick="toggleSectionResult('${sectionNum}')">
                    <span class="section-num">${sectionNum}</span>
                    <span class="section-title">${escapeHtml(group.title)}</span>
                    <span class="section-toggle">â–¼</span>
                </div>
                <div class="section-result-body" id="sectionResult_${sectionNum.replace(/\./g, '_')}">
        `;
        
        group.items.forEach((item, idx) => {
            const matchType = item.match_type || 'none';
            const confidence = Math.round((item.confidence || 0) * 100);
            
            // è·å–æ¥æºä¸­çš„å›¾ç‰‡ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            const images = item.source?.images || [];
            // ä½¿ç”¨ renderContentWithImages å¤„ç†ç­”æ¡ˆä¸­çš„å›¾ç‰‡å ä½ç¬¦
            const answerHtml = renderContentWithImages(item.answer || 'æœªèƒ½ç”Ÿæˆç­”æ¡ˆ', images);
            
            html += `
                <div class="bid-answer-item">
                    <div class="answer-header">
                        <span class="answer-idx">${item.requirement_index || idx + 1}</span>
                        <span class="match-badge" style="background:${matchTypeColors[matchType]}20;color:${matchTypeColors[matchType]}">${matchTypeLabels[matchType]} (${confidence}%)</span>
                    </div>
                    <div class="answer-requirement">
                        <strong>æŠ€æœ¯è¦æ±‚ï¼š</strong>${escapeHtml(item.requirement || '')}
                        ${item.spec ? `<br><em>è§„æ ¼ï¼š${escapeHtml(item.spec)}</em>` : ''}
                    </div>
                    <div class="answer-content">
                        <strong>åº”ç­”å†…å®¹ï¼š</strong>
                        <div class="answer-text">${answerHtml}</div>
                    </div>
                    ${item.source?.type === 'document' ? `<div class="answer-source">ğŸ“„ æ¥æºï¼š${escapeHtml(item.source.filename || 'æ–‡æ¡£')}</div>` : ''}
                </div>
            `;
        });
        
        html += '</div></div>';
    }
    
    html += '</div>';
    
    addLLMMessage('system', html, true);
}

// å¯¼å‡ºæ‹›æ ‡ä½œç­”ç»“æœä¸ºWord
async function exportBidAnswers(formatType = 'default') {
    if (!currentBidData.results || currentBidData.results.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
        return;
    }
    
    addLLMMessage('system', 'ğŸ“¥ æ­£åœ¨ç”ŸæˆWordæ–‡æ¡£...', true);
    
    try {
        const response = await fetch(`${API_BASE}/export-bid-answers`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                results: currentBidData.results,
                title: 'æ‹›æ ‡æŠ€æœ¯è¦æ±‚åº”ç­”ä¹¦',
                doc_info: {
                    doc_id: currentBidData.docId,
                    filename: document.querySelector('.bid-results .doc-info')?.textContent?.replace('ğŸ“„ ', '') || ''
                },
                format_type: formatType
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = formatType === 'table' ? 'æ‹›æ ‡åº”ç­”è¡¨.docx' : 'æ‹›æ ‡åº”ç­”ä¹¦.docx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            addLLMMessage('system', 'âœ… Wordæ–‡æ¡£å·²ç”Ÿæˆå¹¶ä¸‹è½½', true);
        } else {
            const result = await response.json();
            addLLMMessage('system', `âŒ å¯¼å‡ºå¤±è´¥: ${result.error}`, true);
        }
    } catch (error) {
        addLLMMessage('system', `âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, true);
    }
}

// åˆ‡æ¢ç« èŠ‚ç»“æœå±•å¼€/æ”¶èµ·
function toggleSectionResult(sectionNum) {
    const bodyId = `sectionResult_${sectionNum.replace(/\./g, '_')}`;
    const body = document.getElementById(bodyId);
    if (body) {
        body.style.display = body.style.display === 'none' ? 'block' : 'none';
    }
}

// å–æ¶ˆæ‹›æ ‡ä½œç­”
function cancelBidAnswering() {
    currentBidData = {
        docId: null,
        sectionNumbers: [],
        sections: {},
        results: []
    };
    addLLMMessage('system', 'å·²å–æ¶ˆæ‹›æ ‡ä½œç­”');
}

// éœ€æ±‚æ–‡ä»¶é€‰æ‹©
document.getElementById('reqFile').addEventListener('change', function() {
    const fileName = this.files.length > 0 ? this.files[0].name : '';
    document.getElementById('reqFileName').textContent = fileName;
    
    if (fileName) {
        document.getElementById('btnAnalyzeFile').style.display = 'inline-block';
        addLLMMessage('system', `å·²é€‰æ‹©æ–‡ä»¶: <strong>${escapeHtml(fileName)}</strong><br>è¯·ç‚¹å‡»"æ™ºèƒ½åŒ¹é…"æˆ–"åˆ†ææ–‡æ¡£"æŒ‰é’®å¼€å§‹åˆ†æ`, true);
    } else {
        document.getElementById('btnAnalyzeFile').style.display = 'none';
    }
});

// LLMè¾“å…¥æ¡†å›è½¦å‘é€
document.getElementById('llmQueryInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        doLLMSearch();
    }
});

// ============== LLMé…ç½®ç®¡ç†å¼¹çª—åŠŸèƒ½ ==============

// æ¨¡å‹é€‰é¡¹æ˜ å°„
const llmModelOptions = {
    'openai': ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo', 'gpt-4o', 'gpt-4o-mini'],
    'qianwen': ['qwen-turbo', 'qwen-plus', 'qwen-max', 'qwen-long'],
    'wenxin': ['ernie-bot-4', 'ernie-bot-turbo', 'ernie-bot'],
    'zhipu': ['glm-4', 'glm-4-flash', 'glm-3-turbo'],
    'deepseek': ['deepseek-chat', 'deepseek-coder'],
    'custom': []
};

let llmConfigsCache = [];

// æ‰“å¼€é…ç½®å¼¹çª—
function openLLMConfigModal() {
    document.getElementById('llmConfigModal').classList.add('show');
    loadLLMConfigList();
}

// å…³é—­é…ç½®å¼¹çª—
function closeLLMConfigModal() {
    document.getElementById('llmConfigModal').classList.remove('show');
    hideLLMConfigForm();
}

// åŠ è½½é…ç½®åˆ—è¡¨
async function loadLLMConfigList() {
    const container = document.getElementById('llmConfigList');
    container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">åŠ è½½ä¸­...</div>';
    
    try {
        const response = await fetch('/llm/config', {
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            llmConfigsCache = result.data;
            renderLLMConfigList(result.data);
            // åŒæ—¶æ›´æ–°ä¸‹æ‹‰æ¡†
            updateLLMConfigSelect(result.data);
        } else {
            container.innerHTML = '<div style="color:#dc3545;padding:10px;">åŠ è½½é…ç½®å¤±è´¥</div>';
        }
    } catch (error) {
        console.error('åŠ è½½LLMé…ç½®å¤±è´¥:', error);
        container.innerHTML = '<div style="color:#dc3545;padding:10px;">åŠ è½½é…ç½®å¤±è´¥</div>';
    }
}

// æ¸²æŸ“é…ç½®åˆ—è¡¨
function renderLLMConfigList(configs) {
    const container = document.getElementById('llmConfigList');
    
    if (!configs || configs.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— é…ç½®ï¼Œè¯·æ·»åŠ æ–°é…ç½®</div>';
        return;
    }
    
    container.innerHTML = configs.map(config => `
        <div class="llm-config-item ${config.is_default ? 'default' : ''}">
            <div class="llm-config-info">
                <div class="llm-config-name">
                    ${escapeHtml(config.config_name)} 
                    ${config.is_default ? '<span style="color:#667eea;font-size:12px;">(é»˜è®¤)</span>' : ''}
                </div>
                <div class="llm-config-detail">${config.model_type} / ${config.model_name}</div>
            </div>
            <div class="llm-config-actions">
                <button onclick="editLLMConfig(${config.id})">ç¼–è¾‘</button>
                <button class="danger" onclick="deleteLLMConfig(${config.id})">åˆ é™¤</button>
            </div>
        </div>
    `).join('');
}

// æ›´æ–°LLMé…ç½®ä¸‹æ‹‰æ¡†
function updateLLMConfigSelect(configs) {
    const select = document.getElementById('llmConfigSelect');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>';
    
    configs.forEach(config => {
        const option = document.createElement('option');
        option.value = config.id;
        option.textContent = config.config_name + (config.is_default ? ' (é»˜è®¤)' : '');
        select.appendChild(option);
    });
    
    // ä¿æŒä¹‹å‰çš„é€‰æ‹©
    if (currentValue) {
        select.value = currentValue;
    }
    
    // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
    checkLLMConfig();
}

// æ˜¾ç¤ºæ·»åŠ é…ç½®è¡¨å•
function showAddLLMConfigForm() {
    document.getElementById('llmConfigForm').style.display = 'block';
    document.getElementById('llmConfigFormTitle').textContent = 'æ·»åŠ é…ç½®';
    document.getElementById('editLLMConfigId').value = '';
    
    // é‡ç½®è¡¨å•
    document.getElementById('llmConfigName').value = '';
    document.getElementById('llmModelType').value = 'openai';
    document.getElementById('llmApiBaseUrl').value = '';
    document.getElementById('llmApiKey').value = '';
    document.getElementById('llmMaxTokens').value = '2048';
    document.getElementById('llmTemperature').value = '0.7';
    document.getElementById('llmIsDefault').checked = false;
    
    onLLMModelTypeChange();
}

// éšè—é…ç½®è¡¨å•
function hideLLMConfigForm() {
    document.getElementById('llmConfigForm').style.display = 'none';
}

// æ¨¡å‹ç±»å‹å˜æ›´
function onLLMModelTypeChange() {
    const modelType = document.getElementById('llmModelType').value;
    const modelSelectContainer = document.getElementById('llmModelName').parentNode;
    const options = llmModelOptions[modelType] || [];
    
    // ç§»é™¤æ—§çš„å…ƒç´ 
    const oldElement = document.getElementById('llmModelName');
    
    if (options.length === 0) {
        // è‡ªå®šä¹‰æ¨¡å‹ï¼Œä½¿ç”¨input
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'llmModelName';
        input.placeholder = 'è¾“å…¥æ¨¡å‹åç§°';
        oldElement.parentNode.replaceChild(input, oldElement);
    } else {
        // é¢„è®¾æ¨¡å‹ï¼Œä½¿ç”¨select
        if (oldElement.tagName !== 'SELECT') {
            const select = document.createElement('select');
            select.id = 'llmModelName';
            oldElement.parentNode.replaceChild(select, oldElement);
        }
        
        const selectEl = document.getElementById('llmModelName');
        selectEl.innerHTML = options.map(model => 
            `<option value="${model}">${model}</option>`
        ).join('');
    }
}

// ç¼–è¾‘é…ç½®
function editLLMConfig(configId) {
    const config = llmConfigsCache.find(c => c.id === configId);
    if (!config) return;
    
    document.getElementById('llmConfigForm').style.display = 'block';
    document.getElementById('llmConfigFormTitle').textContent = 'ç¼–è¾‘é…ç½®';
    document.getElementById('editLLMConfigId').value = configId;
    
    document.getElementById('llmConfigName').value = config.config_name;
    document.getElementById('llmModelType').value = config.model_type;
    onLLMModelTypeChange();
    
    const modelNameEl = document.getElementById('llmModelName');
    modelNameEl.value = config.model_name;
    
    document.getElementById('llmApiBaseUrl').value = config.api_base_url || '';
    document.getElementById('llmApiKey').value = '';  // ä¸æ˜¾ç¤ºå¯†é’¥
    document.getElementById('llmMaxTokens').value = config.max_tokens;
    document.getElementById('llmTemperature').value = config.temperature;
    document.getElementById('llmIsDefault').checked = config.is_default;
}

// ä¿å­˜é…ç½®
async function saveLLMConfig() {
    const editId = document.getElementById('editLLMConfigId').value;
    const isEdit = !!editId;
    
    const configName = document.getElementById('llmConfigName').value.trim();
    const apiKey = document.getElementById('llmApiKey').value.trim();
    
    if (!configName) {
        alert('è¯·è¾“å…¥é…ç½®åç§°');
        return;
    }
    
    if (!isEdit && !apiKey) {
        alert('è¯·è¾“å…¥API Key');
        return;
    }
    
    const data = {
        config_name: configName,
        model_type: document.getElementById('llmModelType').value,
        model_name: document.getElementById('llmModelName').value,
        api_base_url: document.getElementById('llmApiBaseUrl').value || null,
        max_tokens: parseInt(document.getElementById('llmMaxTokens').value),
        temperature: parseFloat(document.getElementById('llmTemperature').value),
        is_default: document.getElementById('llmIsDefault').checked
    };
    
    if (apiKey) {
        data.api_key = apiKey;
    }
    
    try {
        const url = isEdit ? `/llm/config/${editId}` : '/llm/config';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(isEdit ? 'é…ç½®æ›´æ–°æˆåŠŸ' : 'é…ç½®åˆ›å»ºæˆåŠŸ');
            hideLLMConfigForm();
            loadLLMConfigList();
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// åˆ é™¤é…ç½®
async function deleteLLMConfig(configId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/llm/config/${configId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            loadLLMConfigList();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// æµ‹è¯•é…ç½®
async function testLLMConfig() {
    const editId = document.getElementById('editLLMConfigId').value;
    const apiKey = document.getElementById('llmApiKey').value.trim();
    const modelType = document.getElementById('llmModelType').value;
    const modelName = document.getElementById('llmModelName').value;
    
    // æ„å»ºæµ‹è¯•æ•°æ®
    let testData = {};
    
    if (apiKey) {
        // å¦‚æœæœ‰è¾“å…¥API Keyï¼Œä½¿ç”¨è¡¨å•æ•°æ®ç›´æ¥æµ‹è¯•
        testData = {
            model_type: modelType,
            model_name: modelName,
            api_key: apiKey,
            api_base_url: document.getElementById('llmApiBaseUrl').value || null,
            max_tokens: parseInt(document.getElementById('llmMaxTokens').value),
            temperature: parseFloat(document.getElementById('llmTemperature').value)
        };
    } else if (editId) {
        // å¦‚æœæ²¡æœ‰è¾“å…¥API Keyä½†æ˜¯åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œä½¿ç”¨å·²ä¿å­˜çš„é…ç½®IDæµ‹è¯•
        testData = {config_id: parseInt(editId)};
    } else {
        // æ–°å»ºé…ç½®ä¸”æ²¡æœ‰è¾“å…¥API Key
        alert('è¯·è¾“å…¥API Keyåå†æµ‹è¯•');
        return;
    }
    
    try {
        // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
        const testBtn = event.target;
        const originalText = testBtn.textContent;
        testBtn.textContent = 'æµ‹è¯•ä¸­...';
        testBtn.disabled = true;
        
        const response = await fetch('/llm/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify(testData)
        });
        
        const result = await response.json();
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        testBtn.textContent = originalText;
        testBtn.disabled = false;
        
        if (result.success) {
            alert('æµ‹è¯•æˆåŠŸï¼\nå›å¤: ' + result.data.response);
        } else {
            alert('æµ‹è¯•å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('æµ‹è¯•å¤±è´¥:', error);
        alert('æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
}

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
document.getElementById('llmConfigModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeLLMConfigModal();
    }
});
</script>

{% endblock %}
